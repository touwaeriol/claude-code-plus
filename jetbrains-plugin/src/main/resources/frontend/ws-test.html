<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket RPC æµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        :root {
            --primary: #5b8dee;
            --primary-dark: #4b73d4;
            --success: #48bb78;
            --danger: #f56565;
            --text-main: #1f2933;
            --text-secondary: #4a5568;
            --panel-bg: #ffffff;
            --surface: #f7f9fc;
            --border: #e4e9f2;
            --log-bg: #0f172a;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: radial-gradient(circle at top, #f2f4ff 0%, #eef2ff 45%, #f9fafb 100%);
            padding: 16px;
            min-height: 100vh;
            color: var(--text-main);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--panel-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 32px);
            border: 1px solid var(--border);
        }
        .header {
            background: linear-gradient(135deg, #5b8dee 0%, #7f70f5 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 8px 8px 0 0;
        }
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        .section {
            padding: 16px 20px;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
            background: var(--panel-bg);
        }
        .section:last-child {
            border-bottom: none;
        }
        .toolbar-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }
        .toolbar-column {
            flex: 1 1 320px;
            min-width: 280px;
        }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .control-group label {
            min-width: 100px;
            font-size: 14px;
            color: #666;
        }
        .control-group input,
        .control-group select,
        .control-group textarea {
            flex: 1 1 200px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .control-group textarea {
            min-height: 80px;
            font-family: 'Courier New', monospace;
        }
        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        .btn-success {
            background: #48bb78;
            color: white;
        }
        .btn-success:hover {
            background: #38a169;
        }
        .btn-danger {
            background: #f56565;
            color: white;
        }
        .btn-danger:hover {
            background: #e53e3e;
        }
        .btn-secondary {
            background: #718096;
            color: white;
        }
        .btn-secondary:hover {
            background: #4a5568;
        }
        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        .status.disconnected {
            background: #fed7d7;
            color: #c53030;
        }
        .status.connected {
            background: #c6f6d5;
            color: #22543d;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status.disconnected .status-indicator {
            background: #f56565;
        }
        .status.connected .status-indicator {
            background: #48bb78;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .quick-test-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .quick-test-buttons .btn {
            flex: 1 1 160px;
            justify-content: flex-start;
        }
        .log-section {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
        }
        .message-log {
            background: var(--log-bg);
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            flex: 1 1 auto;
            min-height: 260px;
            max-height: max(260px, calc(100vh - 360px));
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            min-height: 0;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
        }
        .message-log::-webkit-scrollbar {
            width: 8px;
        }
        .message-log::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.08);
            border-radius: 4px;
        }
        .message-log::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
        }
        .message-item {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
        }
        .message-item.sent {
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid #667eea;
        }
        .message-item.received {
            background: rgba(72, 187, 120, 0.1);
            border-left: 3px solid #48bb78;
        }
        .message-item.error {
            background: rgba(245, 101, 101, 0.1);
            border-left: 3px solid #f56565;
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .message-type {
            font-weight: 600;
        }
        .message-time {
            opacity: 0.7;
        }
        .message-content {
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 12px;
        }
        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 6px;
        }
        .tag {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            background: rgba(255,255,255,0.15);
            color: #f8fafc;
        }
        /* å›¾ç‰‡é¢„è§ˆæ ·å¼ */
        .image-preview-area {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background: var(--surface);
            border-radius: 6px;
            min-height: 0;
        }
        .image-preview-area:empty {
            display: none;
        }
        .image-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
        }
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid var(--border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .image-preview-item .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            border: 2px solid white;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.15s;
        }
        .image-preview-item .remove-btn:hover {
            transform: scale(1.1);
        }
        .image-count {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”Œ WebSocket RPC æµ‹è¯•å·¥å…·</h1>
            <p>æµ‹è¯• Claude Code Plus WebSocket RPC åŠŸèƒ½</p>
        </div>

        <!-- é¡¶éƒ¨æ§åˆ¶åŒº -->
        <div class="section toolbar-wrapper">
            <div class="toolbar-column">
                <div class="section-title">ğŸ“¡ è¿æ¥æ§åˆ¶</div>
                <div class="control-group">
                    <label>WebSocket URL:</label>
                    <input type="text" id="wsUrl" value="ws://localhost:8765/ws" />
                    <button class="btn btn-secondary" id="resetUrlBtn" style="padding: 6px 12px; font-size: 12px;" title="é‡ç½®ä¸ºé»˜è®¤å€¼ 8765">ğŸ”„ é‡ç½®</button>
                </div>
                <div class="control-group">
                    <button class="btn btn-success" id="connectBtn">ğŸŸ¢ è¿æ¥</button>
                    <button class="btn btn-danger" id="disconnectBtn" disabled>ğŸ”´ æ–­å¼€</button>
                    <span class="status disconnected" id="statusIndicator">
                        <span class="status-indicator"></span>
                        æœªè¿æ¥
                    </span>
                </div>
            </div>
            <div class="toolbar-column">
                <div class="section-title">ğŸ® RPC æ–¹æ³•</div>
                <div class="quick-test-buttons">
                    <button class="btn btn-success" id="rpcConnectBtn" disabled>ğŸ”Œ Connect</button>
                    <button class="btn btn-danger" id="rpcDisconnectBtn" disabled>ğŸ”Œ Disconnect</button>
                    <button class="btn btn-secondary" id="rpcInterruptBtn" disabled>â¸ï¸ Interrupt</button>
                    <button class="btn btn-secondary" id="rpcSetModelBtn" disabled>âš™ï¸ SetModel</button>
                    <button class="btn btn-secondary" id="rpcGetHistoryBtn" disabled>ğŸ“œ GetHistory</button>
                </div>
            </div>
        </div>

        <!-- Query æ¶ˆæ¯å‘é€åŒº -->
        <div class="section">
            <div class="section-title">ğŸ’¬ QueryWithContent - å‘é€æ¶ˆæ¯æŸ¥è¯¢ï¼ˆæ”¯æŒå›¾ç‰‡ï¼‰</div>
            <div class="control-group">
                <label>æ¶ˆæ¯å†…å®¹:</label>
                <textarea id="messageContent" placeholder='è¾“å…¥æ¶ˆæ¯ï¼Œæ”¯æŒæ·»åŠ å›¾ç‰‡ä¸€èµ·å‘é€...'>ä½ å¥½ï¼Œè¯·æè¿°ä¸€ä¸‹è¿™å¼ å›¾ç‰‡</textarea>
            </div>
            <div class="control-group">
                <label>æ·»åŠ å›¾ç‰‡:</label>
                <input type="file" id="imageInput" accept="image/*" multiple style="display:none" />
                <button class="btn btn-secondary" id="addImageBtn">ğŸ“· é€‰æ‹©å›¾ç‰‡</button>
                <span class="image-count" id="imageCount"></span>
            </div>
            <div id="imagePreviewArea" class="image-preview-area">
                <!-- å›¾ç‰‡é¢„è§ˆå°†åŠ¨æ€æ·»åŠ  -->
            </div>
            <div class="control-group">
                <button class="btn btn-primary" id="sendQueryBtn" disabled>ğŸ“¨ å‘é€ QueryWithContent</button>
                <button class="btn btn-secondary" id="clearImagesBtn">ğŸ—‘ï¸ æ¸…ç©ºå›¾ç‰‡</button>
            </div>
        </div>

        <!-- æ¶ˆæ¯æ—¥å¿—åŒº -->
        <div class="section log-section">
            <div class="section-title">
                ğŸ“‹ æ¶ˆæ¯æ—¥å¿—
                <button class="btn btn-secondary" id="clearLogBtn" style="float: right; padding: 5px 15px;">æ¸…ç©ºæ—¥å¿—</button>
            </div>
            <div class="message-log" id="messageLog">
                <div style="opacity: 0.5; text-align: center; padding: 20px;">
                    ç­‰å¾…è¿æ¥...
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let messageId = 1;
        let isAutoScroll = true;
        let selectedImages = []; // å­˜å‚¨ { file: File, base64: string, previewUrl: string, mimeType: string }

        const wsUrlInput = document.getElementById('wsUrl');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const messageContentTextarea = document.getElementById('messageContent');
        const sendQueryBtn = document.getElementById('sendQueryBtn');
        const messageLog = document.getElementById('messageLog');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const resetUrlBtn = document.getElementById('resetUrlBtn');
        const imageInput = document.getElementById('imageInput');
        const addImageBtn = document.getElementById('addImageBtn');
        const imagePreviewArea = document.getElementById('imagePreviewArea');
        const imageCount = document.getElementById('imageCount');
        const clearImagesBtn = document.getElementById('clearImagesBtn');

        // ä» localStorage æ¢å¤ä¿å­˜çš„ WebSocket URLï¼Œå¼ºåˆ¶ä½¿ç”¨ 8765 ä½œä¸ºé»˜è®¤å€¼
        const defaultUrl = 'ws://localhost:8765/ws';
        const savedWsUrl = localStorage.getItem('wsTestUrl');
        
        // è°ƒè¯•ä¿¡æ¯
        console.log('[ws-test] æ£€æŸ¥ localStorage:', {
            savedWsUrl: savedWsUrl,
            defaultUrl: defaultUrl
        });
        
        // å¦‚æœä¿å­˜çš„å€¼ä¸æ˜¯ 8765ï¼Œå¼ºåˆ¶æ¸…é™¤å¹¶ä½¿ç”¨é»˜è®¤å€¼
        if (savedWsUrl && savedWsUrl.includes(':8765')) {
            // ä¿å­˜çš„å€¼æ˜¯ 8765ï¼Œä½¿ç”¨å®ƒ
            wsUrlInput.value = savedWsUrl;
            console.log('[ws-test] ä½¿ç”¨ä¿å­˜çš„ 8765 URL:', savedWsUrl);
        } else {
            // ä¿å­˜çš„å€¼ä¸æ˜¯ 8765 æˆ–ä¸å­˜åœ¨ï¼Œå¼ºåˆ¶ä½¿ç”¨é»˜è®¤å€¼ 8765
            wsUrlInput.value = defaultUrl;
            if (savedWsUrl) {
                console.log('[ws-test] æ¸…é™¤é 8765 çš„æ—§å€¼:', savedWsUrl);
                localStorage.removeItem('wsTestUrl');
            }
            console.log('[ws-test] ä½¿ç”¨é»˜è®¤å€¼ 8765:', defaultUrl);
        }

        // ä¿å­˜ WebSocket URL åˆ° localStorage
        function saveWsUrl() {
            localStorage.setItem('wsTestUrl', wsUrlInput.value);
        }

        // å½“ URL è¾“å…¥æ¡†æ”¹å˜æ—¶ä¿å­˜
        wsUrlInput.addEventListener('change', saveWsUrl);
        wsUrlInput.addEventListener('blur', saveWsUrl);

        // RPC æ–¹æ³•æŒ‰é’®
        const rpcConnectBtn = document.getElementById('rpcConnectBtn');
        const rpcDisconnectBtn = document.getElementById('rpcDisconnectBtn');
        const rpcInterruptBtn = document.getElementById('rpcInterruptBtn');
        const rpcSetModelBtn = document.getElementById('rpcSetModelBtn');
        const rpcGetHistoryBtn = document.getElementById('rpcGetHistoryBtn');

        function escapeHtml(str = '') {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function normalizeContent(content) {
            if (typeof content === 'string') {
                return content;
            }
            try {
                return JSON.stringify(content, null, 2);
            } catch (err) {
                return String(content ?? '');
            }
        }

        // æ·»åŠ æ—¥å¿—æ¶ˆæ¯
        function addLog(type, method, content, timestamp = new Date()) {
            if (!messageLog.dataset.hasEntries) {
                messageLog.innerHTML = '';
                messageLog.dataset.hasEntries = 'true';
            }

            const messageItem = document.createElement('div');
            messageItem.className = `message-item ${type}`;

            const typeLabel = type === 'sent' ? 'â¬†ï¸ å‘é€' : type === 'received' ? 'â¬‡ï¸ æ¥æ”¶' : 'âŒ é”™è¯¯';
            const timeStr = timestamp.toLocaleTimeString('zh-CN', { hour12: false });
            const normalized = normalizeContent(content);
            const safeContent = escapeHtml(normalized);

            messageItem.innerHTML = `
                <div class="message-header">
                    <span class="message-type">${typeLabel}: ${method}</span>
                    <span class="message-time">${timeStr}</span>
                </div>
                <div class="message-content">${safeContent}</div>
                <div class="message-actions">
                    <span class="tag">${method}</span>
                    <button class="btn btn-secondary" style="padding:2px 8px;font-size:11px;">å¤åˆ¶</button>
                </div>
            `;

            const copyBtn = messageItem.querySelector('button');
            copyBtn.addEventListener('click', () => {
                const textToCopy = normalized;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        copyBtn.textContent = 'å·²å¤åˆ¶';
                        setTimeout(() => copyBtn.textContent = 'å¤åˆ¶', 1500);
                    }).catch(() => {
                        copyBtn.textContent = 'å¤±è´¥';
                        setTimeout(() => copyBtn.textContent = 'å¤åˆ¶', 1500);
                    });
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = textToCopy;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        copyBtn.textContent = 'å·²å¤åˆ¶';
                    } catch (err) {
                        copyBtn.textContent = 'å¤±è´¥';
                    }
                    document.body.removeChild(textarea);
                    setTimeout(() => copyBtn.textContent = 'å¤åˆ¶', 1500);
                }
            });

            messageLog.appendChild(messageItem);
            if (isAutoScroll) {
                messageLog.scrollTop = messageLog.scrollHeight;
            }
        }

        // è¿æ¥ WebSocket
        function connect() {
            const url = wsUrlInput.value;
            addLog('sent', 'WebSocket', `æ­£åœ¨è¿æ¥åˆ°: ${url}`);

            try {
                ws = new WebSocket(url);

                ws.onopen = () => {
                    addLog('received', 'WebSocket', 'âœ… WebSocket è¿æ¥æˆåŠŸ!');
                    updateConnectionStatus(true);
                };

                ws.onmessage = (event) => {
                    addLog('received', 'Message', event.data);
                };

                ws.onerror = (error) => {
                    addLog('error', 'WebSocket', `è¿æ¥é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
                };

                ws.onclose = () => {
                    addLog('received', 'WebSocket', 'âŒ WebSocket è¿æ¥å·²å…³é—­');
                    updateConnectionStatus(false);
                };
            } catch (error) {
                addLog('error', 'WebSocket', `è¿æ¥å¤±è´¥: ${error.message}`);
            }
        }

        // æ–­å¼€è¿æ¥
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // å‘é€ RPC æ¶ˆæ¯çš„é€šç”¨å‡½æ•°
        function sendRpcMessage(method, params = {}) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('error', 'Send', 'âŒ WebSocket æœªè¿æ¥');
                return;
            }

            const message = {
                jsonrpc: '2.0',
                id: messageId++,
                method: method,
                params: params
            };

            const messageStr = JSON.stringify(message, null, 2);
            try {
                ws.send(messageStr);
                addLog('sent', method, messageStr);
            } catch (err) {
                addLog('error', method, `å‘é€å¤±è´¥: ${err.message}`);
            }
        }

        // ============================================
        // å›¾ç‰‡å¤„ç†å‡½æ•°
        // ============================================

        // å›¾ç‰‡è½¬ base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const result = e.target.result;
                    // ç§»é™¤ data:image/xxx;base64, å‰ç¼€
                    const base64 = result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // æ·»åŠ å›¾ç‰‡
        async function addImages(files) {
            for (const file of files) {
                if (!file.type.startsWith('image/')) {
                    addLog('error', 'Image', `âŒ ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.type}`);
                    continue;
                }
                try {
                    const base64 = await fileToBase64(file);
                    const previewUrl = URL.createObjectURL(file);
                    selectedImages.push({
                        file,
                        base64,
                        previewUrl,
                        mimeType: file.type,
                        name: file.name
                    });
                    addLog('received', 'Image', `âœ… å·²æ·»åŠ å›¾ç‰‡: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);
                } catch (err) {
                    addLog('error', 'Image', `âŒ è¯»å–å›¾ç‰‡å¤±è´¥: ${file.name}`);
                }
            }
            renderImagePreviews();
            updateImageCount();
        }

        // æ¸²æŸ“å›¾ç‰‡é¢„è§ˆ
        function renderImagePreviews() {
            imagePreviewArea.innerHTML = selectedImages.map((img, index) => `
                <div class="image-preview-item">
                    <img src="${img.previewUrl}" alt="${img.name}" title="${img.name}" />
                    <button class="remove-btn" onclick="removeImage(${index})" title="åˆ é™¤">Ã—</button>
                </div>
            `).join('');
        }

        // åˆ é™¤å•å¼ å›¾ç‰‡
        function removeImage(index) {
            const img = selectedImages[index];
            if (img) {
                URL.revokeObjectURL(img.previewUrl);
                addLog('received', 'Image', `ğŸ—‘ï¸ å·²åˆ é™¤å›¾ç‰‡: ${img.name}`);
            }
            selectedImages.splice(index, 1);
            renderImagePreviews();
            updateImageCount();
        }

        // æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡
        function clearAllImages() {
            selectedImages.forEach(img => URL.revokeObjectURL(img.previewUrl));
            selectedImages = [];
            renderImagePreviews();
            updateImageCount();
            addLog('received', 'Image', 'ğŸ—‘ï¸ å·²æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡');
        }

        // æ›´æ–°å›¾ç‰‡è®¡æ•°æ˜¾ç¤º
        function updateImageCount() {
            if (selectedImages.length > 0) {
                imageCount.textContent = `å·²é€‰æ‹© ${selectedImages.length} å¼ å›¾ç‰‡`;
            } else {
                imageCount.textContent = '';
            }
        }

        // ============================================
        // å‘é€æ¶ˆæ¯ï¼ˆä½¿ç”¨ queryWithContentï¼‰
        // ============================================

        function sendQuery() {
            const messageText = messageContentTextarea.value.trim();

            // æ„å»º ContentBlock[]
            const content = [];

            // æ·»åŠ æ–‡æœ¬å—
            if (messageText) {
                content.push({ type: 'text', text: messageText });
            }

            // æ·»åŠ å›¾ç‰‡å—
            for (const img of selectedImages) {
                content.push({
                    type: 'image',
                    source: {
                        type: 'base64',
                        media_type: img.mimeType,
                        data: img.base64
                    }
                });
            }

            if (content.length === 0) {
                addLog('error', 'Query', 'âŒ è¯·è¾“å…¥æ¶ˆæ¯æˆ–æ·»åŠ å›¾ç‰‡');
                return;
            }

            // ä½¿ç”¨ queryWithContent æ–¹æ³•å‘é€
            const contentSummary = content.map(c => {
                if (c.type === 'text') return `text(${c.text.length}å­—)`;
                if (c.type === 'image') return `image(${c.source.media_type})`;
                return c.type;
            }).join(', ');
            addLog('sent', 'QueryWithContent', `å‘é€ ${content.length} ä¸ªå†…å®¹å—: [${contentSummary}]`);

            sendRpcMessage('queryWithContent', { content });

            // å‘é€åæ¸…ç©ºå›¾ç‰‡ï¼ˆä¿ç•™æ–‡æœ¬ï¼‰
            selectedImages.forEach(img => URL.revokeObjectURL(img.previewUrl));
            selectedImages = [];
            renderImagePreviews();
            updateImageCount();
        }

        // RPC æ–¹æ³•æŒ‰é’®å¤„ç†å‡½æ•°
        function rpcConnect() {
            sendRpcMessage('connect', {});
        }

        function rpcDisconnect() {
            sendRpcMessage('disconnect', {});
        }

        function rpcInterrupt() {
            sendRpcMessage('interrupt', {});
        }

        function rpcSetModel() {
            const model = prompt('è¯·è¾“å…¥æ¨¡å‹åç§°:', 'claude-sonnet-4-5-20250929');
            if (model) {
                sendRpcMessage('setModel', { model: model });
            }
        }

        function rpcGetHistory() {
            sendRpcMessage('getHistory', {});
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            if (connected) {
                statusIndicator.className = 'status connected';
                statusIndicator.innerHTML = '<span class="status-indicator"></span>å·²è¿æ¥';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendQueryBtn.disabled = false;

                // å¯ç”¨æ‰€æœ‰ RPC æ–¹æ³•æŒ‰é’®
                rpcConnectBtn.disabled = false;
                rpcDisconnectBtn.disabled = false;
                rpcInterruptBtn.disabled = false;
                rpcSetModelBtn.disabled = false;
                rpcGetHistoryBtn.disabled = false;
            } else {
                statusIndicator.className = 'status disconnected';
                statusIndicator.innerHTML = '<span class="status-indicator"></span>æœªè¿æ¥';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendQueryBtn.disabled = true;

                // ç¦ç”¨æ‰€æœ‰ RPC æ–¹æ³•æŒ‰é’®
                rpcConnectBtn.disabled = true;
                rpcDisconnectBtn.disabled = true;
                rpcInterruptBtn.disabled = true;
                rpcSetModelBtn.disabled = true;
                rpcGetHistoryBtn.disabled = true;
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            messageLog.dataset.hasEntries = '';
            messageLog.innerHTML = '<div style="opacity: 0.5; text-align: center; padding: 20px;">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // é‡ç½® URL ä¸ºé»˜è®¤å€¼ 8765
        function resetUrl() {
            const defaultUrl = 'ws://localhost:8765/ws';
            wsUrlInput.value = defaultUrl;
            localStorage.removeItem('wsTestUrl');
            addLog('received', 'System', `ğŸ”„ URL å·²é‡ç½®ä¸ºé»˜è®¤å€¼: ${defaultUrl}`);
            console.log('[ws-test] URL å·²é‡ç½®ä¸º:', defaultUrl);
        }

        // äº‹ä»¶ç›‘å¬å™¨
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        sendQueryBtn.addEventListener('click', sendQuery);
        clearLogBtn.addEventListener('click', clearLog);
        resetUrlBtn.addEventListener('click', resetUrl);

        // å›¾ç‰‡ç›¸å…³äº‹ä»¶ç›‘å¬
        addImageBtn.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', (e) => {
            addImages(e.target.files);
            imageInput.value = ''; // æ¸…ç©º inputï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
        });
        clearImagesBtn.addEventListener('click', clearAllImages);

        // æ”¯æŒæ‹–æ‹½ä¸Šä¼ å›¾ç‰‡
        const dropZone = document.querySelector('.section:has(#messageContent)');
        if (dropZone) {
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.background = 'rgba(91, 141, 238, 0.1)';
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.style.background = '';
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.background = '';
                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                if (files.length > 0) {
                    addImages(files);
                }
            });
        }

        // RPC æ–¹æ³•æŒ‰é’®äº‹ä»¶ç›‘å¬
        rpcConnectBtn.addEventListener('click', rpcConnect);
        rpcDisconnectBtn.addEventListener('click', rpcDisconnect);
        rpcInterruptBtn.addEventListener('click', rpcInterrupt);
        rpcSetModelBtn.addEventListener('click', rpcSetModel);
        rpcGetHistoryBtn.addEventListener('click', rpcGetHistory);

        // æ—¥å¿—æ»šåŠ¨ç›‘å¬ï¼Œç”¨æˆ·å‘ä¸Šæ»šåŠ¨æ—¶å…³é—­è‡ªåŠ¨æ»šåŠ¨
        messageLog.addEventListener('scroll', () => {
            const nearBottom = messageLog.scrollTop + messageLog.clientHeight >= messageLog.scrollHeight - 20;
            isAutoScroll = nearBottom;
        });

        // æ”¯æŒ Ctrl+Enter å‘é€æ¶ˆæ¯
        messageContentTextarea.addEventListener('keydown', (e) => {
            if ((e.key === 'Enter' && e.ctrlKey) || (e.key === 'Enter' && e.metaKey)) {
                e.preventDefault();
                sendQuery();
            }
        });

        // æ”¯æŒç²˜è´´å›¾ç‰‡ (Ctrl+V)
        document.addEventListener('paste', async (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;

            const imageFiles = [];
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    if (file) {
                        // ç”Ÿæˆæ–‡ä»¶å
                        const ext = item.type.split('/')[1] || 'png';
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                        Object.defineProperty(file, 'name', {
                            value: `clipboard-${timestamp}.${ext}`,
                            writable: false
                        });
                        imageFiles.push(file);
                    }
                }
            }

            if (imageFiles.length > 0) {
                e.preventDefault();
                addLog('received', 'Clipboard', `ğŸ“‹ ä»å‰ªè´´æ¿ç²˜è´´ ${imageFiles.length} å¼ å›¾ç‰‡`);
                await addImages(imageFiles);
            }
        });

        // åˆå§‹åŒ–æ—¥å¿—
        addLog('received', 'System', 'ğŸš€ WebSocket RPC æµ‹è¯•å·¥å…·å·²å°±ç»ª');
        addLog('received', 'System', 'ğŸ“ è¯·å…ˆç‚¹å‡»"è¿æ¥"æŒ‰é’®å»ºç«‹ WebSocket è¿æ¥');
    </script>
</body>
</html>
