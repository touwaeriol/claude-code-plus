var _=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function _r(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function Ar(r){if(r.__esModule)return r;var e=r.default;if(typeof e=="function"){var t=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(n){var i=Object.getOwnPropertyDescriptor(r,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return r[n]}})}),t}var Xe={},Ge={},H={};(function(r){Object.defineProperty(r,"__esModule",{value:!0}),r.Frame=r.Lengths=r.Flags=r.FrameTypes=void 0;var e;(function(t){t[t.RESERVED=0]="RESERVED",t[t.SETUP=1]="SETUP",t[t.LEASE=2]="LEASE",t[t.KEEPALIVE=3]="KEEPALIVE",t[t.REQUEST_RESPONSE=4]="REQUEST_RESPONSE",t[t.REQUEST_FNF=5]="REQUEST_FNF",t[t.REQUEST_STREAM=6]="REQUEST_STREAM",t[t.REQUEST_CHANNEL=7]="REQUEST_CHANNEL",t[t.REQUEST_N=8]="REQUEST_N",t[t.CANCEL=9]="CANCEL",t[t.PAYLOAD=10]="PAYLOAD",t[t.ERROR=11]="ERROR",t[t.METADATA_PUSH=12]="METADATA_PUSH",t[t.RESUME=13]="RESUME",t[t.RESUME_OK=14]="RESUME_OK",t[t.EXT=63]="EXT"})(e=r.FrameTypes||(r.FrameTypes={})),function(t){t[t.NONE=0]="NONE",t[t.COMPLETE=64]="COMPLETE",t[t.FOLLOWS=128]="FOLLOWS",t[t.IGNORE=512]="IGNORE",t[t.LEASE=64]="LEASE",t[t.METADATA=256]="METADATA",t[t.NEXT=32]="NEXT",t[t.RESPOND=128]="RESPOND",t[t.RESUME_ENABLE=128]="RESUME_ENABLE"}(r.Flags||(r.Flags={})),function(t){function n(m){return(m&t.METADATA)===t.METADATA}t.hasMetadata=n;function i(m){return(m&t.COMPLETE)===t.COMPLETE}t.hasComplete=i;function s(m){return(m&t.NEXT)===t.NEXT}t.hasNext=s;function u(m){return(m&t.FOLLOWS)===t.FOLLOWS}t.hasFollows=u;function y(m){return(m&t.IGNORE)===t.IGNORE}t.hasIgnore=y;function h(m){return(m&t.RESPOND)===t.RESPOND}t.hasRespond=h;function E(m){return(m&t.LEASE)===t.LEASE}t.hasLease=E;function T(m){return(m&t.RESUME_ENABLE)===t.RESUME_ENABLE}t.hasResume=T}(r.Flags||(r.Flags={})),function(t){t[t.FRAME=3]="FRAME",t[t.HEADER=6]="HEADER",t[t.METADATA=3]="METADATA",t[t.REQUEST=3]="REQUEST"}(r.Lengths||(r.Lengths={})),function(t){function n(s){return s.streamId===0}t.isConnection=n;function i(s){return e.REQUEST_RESPONSE<=s.type&&s.type<=e.REQUEST_CHANNEL}t.isRequest=i}(r.Frame||(r.Frame={}))})(H);(function(r){var e=_&&_.__generator||function(a,f){var l={label:0,sent:function(){if(g[0]&1)throw g[1];return g[1]},trys:[],ops:[]},d,C,g,I;return I={next:V(0),throw:V(1),return:V(2)},typeof Symbol=="function"&&(I[Symbol.iterator]=function(){return this}),I;function V(L){return function(de){return ce([L,de])}}function ce(L){if(d)throw new TypeError("Generator is already executing.");for(;l;)try{if(d=1,C&&(g=L[0]&2?C.return:L[0]?C.throw||((g=C.return)&&g.call(C),0):C.next)&&!(g=g.call(C,L[1])).done)return g;switch(C=0,g&&(L=[L[0]&2,g.value]),L[0]){case 0:case 1:g=L;break;case 4:return l.label++,{value:L[1],done:!1};case 5:l.label++,C=L[1],L=[0];continue;case 7:L=l.ops.pop(),l.trys.pop();continue;default:if(g=l.trys,!(g=g.length>0&&g[g.length-1])&&(L[0]===6||L[0]===2)){l=0;continue}if(L[0]===3&&(!g||L[1]>g[0]&&L[1]<g[3])){l.label=L[1];break}if(L[0]===6&&l.label<g[1]){l.label=g[1],g=L;break}if(g&&l.label<g[2]){l.label=g[2],l.ops.push(L);break}g[2]&&l.ops.pop(),l.trys.pop();continue}L=f.call(a,l)}catch(de){L=[6,de],C=0}finally{d=g=0}if(L[0]&5)throw L[1];return{value:L[0]?L[1]:void 0,done:!0}}};Object.defineProperty(r,"__esModule",{value:!0}),r.Deserializer=r.sizeOfFrame=r.serializeFrame=r.deserializeFrame=r.serializeFrameWithLength=r.deserializeFrames=r.deserializeFrameWithLength=r.writeUInt64BE=r.readUInt64BE=r.writeUInt24BE=r.readUInt24BE=r.MAX_VERSION=r.MAX_TTL=r.MAX_STREAM_ID=r.MAX_RESUME_LENGTH=r.MAX_REQUEST_N=r.MAX_REQUEST_COUNT=r.MAX_MIME_LENGTH=r.MAX_METADATA_LENGTH=r.MAX_LIFETIME=r.MAX_KEEPALIVE=r.MAX_CODE=r.FRAME_TYPE_OFFFSET=r.FLAGS_MASK=void 0;var t=H;r.FLAGS_MASK=1023,r.FRAME_TYPE_OFFFSET=10,r.MAX_CODE=2147483647,r.MAX_KEEPALIVE=2147483647,r.MAX_LIFETIME=2147483647,r.MAX_METADATA_LENGTH=16777215,r.MAX_MIME_LENGTH=255,r.MAX_REQUEST_COUNT=2147483647,r.MAX_REQUEST_N=2147483647,r.MAX_RESUME_LENGTH=65535,r.MAX_STREAM_ID=2147483647,r.MAX_TTL=2147483647,r.MAX_VERSION=65535;var n=4294967296;function i(a,f){var l=a.readUInt8(f)<<16,d=a.readUInt8(f+1)<<8,C=a.readUInt8(f+2);return l|d|C}r.readUInt24BE=i;function s(a,f,l){return l=a.writeUInt8(f>>>16,l),l=a.writeUInt8(f>>>8&255,l),a.writeUInt8(f&255,l)}r.writeUInt24BE=s;function u(a,f){var l=a.readUInt32BE(f),d=a.readUInt32BE(f+4);return l*n+d}r.readUInt64BE=u;function y(a,f,l){var d=f/n|0,C=f%n;return l=a.writeUInt32BE(d,l),a.writeUInt32BE(C,l)}r.writeUInt64BE=y;var h=6,E=3;function T(a){var f=i(a,0);return o(a.slice(E,E+f))}r.deserializeFrameWithLength=T;function m(a){var f,l,d,C,g,I;return e(this,function(V){switch(V.label){case 0:f=0,V.label=1;case 1:return f+E<a.length?(l=i(a,f),d=f+E,C=d+l,C>a.length?[3,3]:(g=a.slice(d,C),I=o(g),f=C,[4,[I,f]])):[3,3];case 2:return V.sent(),[3,1];case 3:return[2]}})}r.deserializeFrames=m;function c(a){var f=v(a),l=Buffer.allocUnsafe(f.length+E);return s(l,f.length,0),f.copy(l,E),l}r.serializeFrameWithLength=c;function o(a){var f=0,l=a.readInt32BE(f);f+=4;var d=a.readUInt16BE(f);f+=2;var C=d>>>r.FRAME_TYPE_OFFFSET,g=d&r.FLAGS_MASK;switch(C){case t.FrameTypes.SETUP:return A(a,l,g);case t.FrameTypes.PAYLOAD:return Ot(a,l,g);case t.FrameTypes.ERROR:return ee(a,l,g);case t.FrameTypes.KEEPALIVE:return P(a,l,g);case t.FrameTypes.REQUEST_FNF:return Qe(a,l,g);case t.FrameTypes.REQUEST_RESPONSE:return Pe(a,l,g);case t.FrameTypes.REQUEST_STREAM:return Fe(a,l,g);case t.FrameTypes.REQUEST_CHANNEL:return Se(a,l,g);case t.FrameTypes.METADATA_PUSH:return ne(a,l,g);case t.FrameTypes.REQUEST_N:return gt(a,l,g);case t.FrameTypes.RESUME:return Dt(a,l,g);case t.FrameTypes.RESUME_OK:return Lt(a,l,g);case t.FrameTypes.CANCEL:return St(a,l,g);case t.FrameTypes.LEASE:return le(a,l,g)}}r.deserializeFrame=o;function v(a){switch(a.type){case t.FrameTypes.SETUP:return N(a);case t.FrameTypes.PAYLOAD:return _t(a);case t.FrameTypes.ERROR:return q(a);case t.FrameTypes.KEEPALIVE:return te(a);case t.FrameTypes.REQUEST_FNF:case t.FrameTypes.REQUEST_RESPONSE:return Re(a);case t.FrameTypes.REQUEST_STREAM:case t.FrameTypes.REQUEST_CHANNEL:return Ue(a);case t.FrameTypes.METADATA_PUSH:return Te(a);case t.FrameTypes.REQUEST_N:return Ae(a);case t.FrameTypes.RESUME:return bt(a);case t.FrameTypes.RESUME_OK:return It(a);case t.FrameTypes.CANCEL:return Tt(a);case t.FrameTypes.LEASE:return B(a)}}r.serializeFrame=v;function S(a){switch(a.type){case t.FrameTypes.SETUP:return M(a);case t.FrameTypes.PAYLOAD:return At(a);case t.FrameTypes.ERROR:return $(a);case t.FrameTypes.KEEPALIVE:return Q(a);case t.FrameTypes.REQUEST_FNF:case t.FrameTypes.REQUEST_RESPONSE:return ge(a);case t.FrameTypes.REQUEST_STREAM:case t.FrameTypes.REQUEST_CHANNEL:return qe(a);case t.FrameTypes.METADATA_PUSH:return Me(a);case t.FrameTypes.REQUEST_N:return Rt();case t.FrameTypes.RESUME:return Nt(a);case t.FrameTypes.RESUME_OK:return Ct();case t.FrameTypes.CANCEL:return Ft();case t.FrameTypes.LEASE:return oe(a)}}r.sizeOfFrame=S;var p=14,R=2;function N(a){var f=a.resumeToken!=null?a.resumeToken.byteLength:0,l=a.metadataMimeType!=null?Buffer.byteLength(a.metadataMimeType,"ascii"):0,d=a.dataMimeType!=null?Buffer.byteLength(a.dataMimeType,"ascii"):0,C=ae(a),g=Buffer.allocUnsafe(h+p+(f?R+f:0)+l+d+C),I=j(a,g);return I=g.writeUInt16BE(a.majorVersion,I),I=g.writeUInt16BE(a.minorVersion,I),I=g.writeUInt32BE(a.keepAlive,I),I=g.writeUInt32BE(a.lifetime,I),a.flags&t.Flags.RESUME_ENABLE&&(I=g.writeUInt16BE(f,I),a.resumeToken!=null&&(I+=a.resumeToken.copy(g,I))),I=g.writeUInt8(l,I),a.metadataMimeType!=null&&(I+=g.write(a.metadataMimeType,I,I+l,"ascii")),I=g.writeUInt8(d,I),a.dataMimeType!=null&&(I+=g.write(a.dataMimeType,I,I+d,"ascii")),xe(a,g,I),g}function M(a){var f=a.resumeToken!=null?a.resumeToken.byteLength:0,l=a.metadataMimeType!=null?Buffer.byteLength(a.metadataMimeType,"ascii"):0,d=a.dataMimeType!=null?Buffer.byteLength(a.dataMimeType,"ascii"):0,C=ae(a);return h+p+(f?R+f:0)+l+d+C}function A(a,f,l){a.length;var d=h,C=a.readUInt16BE(d);d+=2;var g=a.readUInt16BE(d);d+=2;var I=a.readInt32BE(d);d+=4;var V=a.readInt32BE(d);d+=4;var ce=null;if(l&t.Flags.RESUME_ENABLE){var L=a.readInt16BE(d);d+=2,ce=a.slice(d,d+L),d+=L}var de=a.readUInt8(d);d+=1;var Pt=a.toString("ascii",d,d+de);d+=de;var Je=a.readUInt8(d);d+=1;var wt=a.toString("ascii",d,d+Je);d+=Je;var Ze={data:null,dataMimeType:wt,flags:l,keepAlive:I,lifetime:V,majorVersion:C,metadata:null,metadataMimeType:Pt,minorVersion:g,resumeToken:ce,streamId:0,type:t.FrameTypes.SETUP};return ue(a,Ze,d),Ze}var w=4;function q(a){var f=a.message!=null?Buffer.byteLength(a.message,"utf8"):0,l=Buffer.allocUnsafe(h+w+f),d=j(a,l);return d=l.writeUInt32BE(a.code,d),a.message!=null&&l.write(a.message,d,d+f,"utf8"),l}function $(a){var f=a.message!=null?Buffer.byteLength(a.message,"utf8"):0;return h+w+f}function ee(a,f,l){a.length;var d=h,C=a.readInt32BE(d);d+=4;var g=a.length-d,I="";return g>0&&(I=a.toString("utf8",d,d+g),d+=g),{code:C,flags:l,message:I,streamId:f,type:t.FrameTypes.ERROR}}var W=8;function te(a){var f=a.data!=null?a.data.byteLength:0,l=Buffer.allocUnsafe(h+W+f),d=j(a,l);return d=y(l,a.lastReceivedPosition,d),a.data!=null&&a.data.copy(l,d),l}function Q(a){var f=a.data!=null?a.data.byteLength:0;return h+W+f}function P(a,f,l){a.length;var d=h,C=u(a,d);d+=8;var g=null;return d<a.length&&(g=a.slice(d,a.length)),{data:g,flags:l,lastReceivedPosition:C,streamId:0,type:t.FrameTypes.KEEPALIVE}}var X=8;function B(a){var f=a.metadata!=null?a.metadata.byteLength:0,l=Buffer.allocUnsafe(h+X+f),d=j(a,l);return d=l.writeUInt32BE(a.ttl,d),d=l.writeUInt32BE(a.requestCount,d),a.metadata!=null&&a.metadata.copy(l,d),l}function oe(a){var f=a.metadata!=null?a.metadata.byteLength:0;return h+X+f}function le(a,f,l){var d=h,C=a.readUInt32BE(d);d+=4;var g=a.readUInt32BE(d);d+=4;var I=null;return d<a.length&&(I=a.slice(d,a.length)),{flags:l,metadata:I,requestCount:g,streamId:0,ttl:C,type:t.FrameTypes.LEASE}}function Re(a){var f=ae(a),l=Buffer.allocUnsafe(h+f),d=j(a,l);return xe(a,l,d),l}function ge(a){var f=ae(a);return h+f}function Te(a){var f=a.metadata;if(f!=null){var l=Buffer.allocUnsafe(h+f.byteLength),d=j(a,l);return f.copy(l,d),l}else{var l=Buffer.allocUnsafe(h);return j(a,l),l}}function Me(a){return h+(a.metadata!=null?a.metadata.byteLength:0)}function Qe(a,f,l){a.length;var d={data:null,flags:l,metadata:null,streamId:f,type:t.FrameTypes.REQUEST_FNF};return ue(a,d,h),d}function Pe(a,f,l){var d={data:null,flags:l,metadata:null,streamId:f,type:t.FrameTypes.REQUEST_RESPONSE};return ue(a,d,h),d}function ne(a,f,l){return{flags:l,metadata:length===h?null:a.slice(h,length),streamId:0,type:t.FrameTypes.METADATA_PUSH}}var we=4;function Ue(a){var f=ae(a),l=Buffer.allocUnsafe(h+we+f),d=j(a,l);return d=l.writeUInt32BE(a.requestN,d),xe(a,l,d),l}function qe(a){var f=ae(a);return h+we+f}function Fe(a,f,l){a.length;var d=h,C=a.readInt32BE(d);d+=4;var g={data:null,flags:l,metadata:null,requestN:C,streamId:f,type:t.FrameTypes.REQUEST_STREAM};return ue(a,g,d),g}function Se(a,f,l){a.length;var d=h,C=a.readInt32BE(d);d+=4;var g={data:null,flags:l,metadata:null,requestN:C,streamId:f,type:t.FrameTypes.REQUEST_CHANNEL};return ue(a,g,d),g}var _e=4;function Ae(a){var f=Buffer.allocUnsafe(h+_e),l=j(a,f);return f.writeUInt32BE(a.requestN,l),f}function Rt(a){return h+_e}function gt(a,f,l){a.length;var d=a.readInt32BE(h);return{flags:l,requestN:d,streamId:f,type:t.FrameTypes.REQUEST_N}}function Tt(a){var f=Buffer.allocUnsafe(h);return j(a,f),f}function Ft(a){return h}function St(a,f,l){return a.length,{flags:l,streamId:f,type:t.FrameTypes.CANCEL}}function _t(a){var f=ae(a),l=Buffer.allocUnsafe(h+f),d=j(a,l);return xe(a,l,d),l}function At(a){var f=ae(a);return h+f}function Ot(a,f,l){a.length;var d={data:null,flags:l,metadata:null,streamId:f,type:t.FrameTypes.PAYLOAD};return ue(a,d,h),d}var We=22;function bt(a){var f=a.resumeToken.byteLength,l=Buffer.allocUnsafe(h+We+f),d=j(a,l);return d=l.writeUInt16BE(a.majorVersion,d),d=l.writeUInt16BE(a.minorVersion,d),d=l.writeUInt16BE(f,d),d+=a.resumeToken.copy(l,d),d=y(l,a.serverPosition,d),y(l,a.clientPosition,d),l}function Nt(a){var f=a.resumeToken.byteLength;return h+We+f}function Dt(a,f,l){a.length;var d=h,C=a.readUInt16BE(d);d+=2;var g=a.readUInt16BE(d);d+=2;var I=a.readInt16BE(d);d+=2;var V=a.slice(d,d+I);d+=I;var ce=u(a,d);d+=8;var L=u(a,d);return d+=8,{clientPosition:L,flags:l,majorVersion:C,minorVersion:g,resumeToken:V,serverPosition:ce,streamId:0,type:t.FrameTypes.RESUME}}var Ye=8;function It(a){var f=Buffer.allocUnsafe(h+Ye),l=j(a,f);return y(f,a.clientPosition,l),f}function Ct(a){return h+Ye}function Lt(a,f,l){a.length;var d=u(a,h);return{clientPosition:d,flags:l,streamId:0,type:t.FrameTypes.RESUME_OK}}function j(a,f){var l=f.writeInt32BE(a.streamId,0);return f.writeUInt16BE(a.type<<r.FRAME_TYPE_OFFFSET|a.flags&r.FLAGS_MASK,l)}function ae(a){var f=0;return a.data!=null&&(f+=a.data.byteLength),t.Flags.hasMetadata(a.flags)&&(f+=E,a.metadata!=null&&(f+=a.metadata.byteLength)),f}function xe(a,f,l){if(t.Flags.hasMetadata(a.flags))if(a.metadata!=null){var d=a.metadata.byteLength;l=s(f,d,l),l+=a.metadata.copy(f,l)}else l=s(f,0,l);a.data!=null&&a.data.copy(f,l)}function ue(a,f,l){if(t.Flags.hasMetadata(f.flags)){var d=i(a,l);l+=E,d>0&&(f.metadata=a.slice(l,l+d),l+=d)}l<a.length&&(f.data=a.slice(l,a.length))}var Mt=function(){function a(){}return a.prototype.deserializeFrame=function(f){return o(f)},a.prototype.deserializeFrameWithLength=function(f){return T(f)},a.prototype.deserializeFrames=function(f){return m(f)},a}();r.Deserializer=Mt})(Ge);var ot={};Object.defineProperty(ot,"__esModule",{value:!0});var Ce={},$e=_&&_.__values||function(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],n=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(Ce,"__esModule",{value:!0});Ce.Deferred=void 0;var Ut=function(){function r(){this._done=!1,this.onCloseCallbacks=[]}return Object.defineProperty(r.prototype,"done",{get:function(){return this._done},enumerable:!1,configurable:!0}),r.prototype.close=function(e){var t,n,i,s;if(this.done){console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}if(this._done=!0,this._error=e,e){try{for(var u=$e(this.onCloseCallbacks),y=u.next();!y.done;y=u.next()){var h=y.value;h(e)}}catch(m){t={error:m}}finally{try{y&&!y.done&&(n=u.return)&&n.call(u)}finally{if(t)throw t.error}}return}try{for(var E=$e(this.onCloseCallbacks),T=E.next();!T.done;T=E.next()){var h=T.value;h()}}catch(m){i={error:m}}finally{try{T&&!T.done&&(s=E.return)&&s.call(E)}finally{if(i)throw i.error}}},r.prototype.onClose=function(e){if(this._done){e(this._error);return}this.onCloseCallbacks.push(e)},r}();Ce.Deferred=Ut;var re={};(function(r){var e=_&&_.__extends||function(){var n=function(i,s){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(u,y){u.__proto__=y}||function(u,y){for(var h in y)Object.prototype.hasOwnProperty.call(y,h)&&(u[h]=y[h])},n(i,s)};return function(i,s){if(typeof s!="function"&&s!==null)throw new TypeError("Class extends value "+String(s)+" is not a constructor or null");n(i,s);function u(){this.constructor=i}i.prototype=s===null?Object.create(s):(u.prototype=s.prototype,new u)}}();Object.defineProperty(r,"__esModule",{value:!0}),r.ErrorCodes=r.RSocketError=void 0;var t=function(n){e(i,n);function i(s,u){var y=n.call(this,u)||this;return y.code=s,y}return i}(Error);r.RSocketError=t,function(n){n[n.RESERVED=0]="RESERVED",n[n.INVALID_SETUP=1]="INVALID_SETUP",n[n.UNSUPPORTED_SETUP=2]="UNSUPPORTED_SETUP",n[n.REJECTED_SETUP=3]="REJECTED_SETUP",n[n.REJECTED_RESUME=4]="REJECTED_RESUME",n[n.CONNECTION_CLOSE=258]="CONNECTION_CLOSE",n[n.CONNECTION_ERROR=257]="CONNECTION_ERROR",n[n.APPLICATION_ERROR=513]="APPLICATION_ERROR",n[n.REJECTED=514]="REJECTED",n[n.CANCELED=515]="CANCELED",n[n.INVALID=516]="INVALID",n[n.RESERVED_EXTENSION=4294967295]="RESERVED_EXTENSION"}(r.ErrorCodes||(r.ErrorCodes={}))})(re);var lt={};Object.defineProperty(lt,"__esModule",{value:!0});var Oe={},Ve={},et;function ut(){return et||(et=1,function(r){var e=_&&_.__extends||function(){var m=function(c,o){return m=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(v,S){v.__proto__=S}||function(v,S){for(var p in S)Object.prototype.hasOwnProperty.call(S,p)&&(v[p]=S[p])},m(c,o)};return function(c,o){if(typeof o!="function"&&o!==null)throw new TypeError("Class extends value "+String(o)+" is not a constructor or null");m(c,o);function v(){this.constructor=c}c.prototype=o===null?Object.create(o):(v.prototype=o.prototype,new v)}}(),t=_&&_.__awaiter||function(m,c,o,v){function S(p){return p instanceof o?p:new o(function(R){R(p)})}return new(o||(o=Promise))(function(p,R){function N(w){try{A(v.next(w))}catch(q){R(q)}}function M(w){try{A(v.throw(w))}catch(q){R(q)}}function A(w){w.done?p(w.value):S(w.value).then(N,M)}A((v=v.apply(m,c||[])).next())})},n=_&&_.__generator||function(m,c){var o={label:0,sent:function(){if(p[0]&1)throw p[1];return p[1]},trys:[],ops:[]},v,S,p,R;return R={next:N(0),throw:N(1),return:N(2)},typeof Symbol=="function"&&(R[Symbol.iterator]=function(){return this}),R;function N(A){return function(w){return M([A,w])}}function M(A){if(v)throw new TypeError("Generator is already executing.");for(;o;)try{if(v=1,S&&(p=A[0]&2?S.return:A[0]?S.throw||((p=S.return)&&p.call(S),0):S.next)&&!(p=p.call(S,A[1])).done)return p;switch(S=0,p&&(A=[A[0]&2,p.value]),A[0]){case 0:case 1:p=A;break;case 4:return o.label++,{value:A[1],done:!1};case 5:o.label++,S=A[1],A=[0];continue;case 7:A=o.ops.pop(),o.trys.pop();continue;default:if(p=o.trys,!(p=p.length>0&&p[p.length-1])&&(A[0]===6||A[0]===2)){o=0;continue}if(A[0]===3&&(!p||A[1]>p[0]&&A[1]<p[3])){o.label=A[1];break}if(A[0]===6&&o.label<p[1]){o.label=p[1],p=A;break}if(p&&o.label<p[2]){o.label=p[2],o.ops.push(A);break}p[2]&&o.ops.pop(),o.trys.pop();continue}A=c.call(m,o)}catch(w){A=[6,w],S=0}finally{v=p=0}if(A[0]&5)throw A[1];return{value:A[0]?A[1]:void 0,done:!0}}};Object.defineProperty(r,"__esModule",{value:!0}),r.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer=r.ResumableClientServerInputMultiplexerDemultiplexer=r.ClientServerInputMultiplexerDemultiplexer=r.StreamIdGenerator=void 0;var i=Le(),s=Ce,u=re,y=H;(function(m){function c(v){return new o(v)}m.create=c;var o=function(){function v(S){this.currentId=S}return v.prototype.next=function(S){var p=this.currentId+2;S(p)&&(this.currentId=p)},v}()})(r.StreamIdGenerator||(r.StreamIdGenerator={}));var h=function(m){e(c,m);function c(o,v,S){var p=m.call(this)||this;return p.streamIdSupplier=o,p.outbound=v,p.closeable=S,p.registry={},S.onClose(p.close.bind(p)),p}return c.prototype.handle=function(o){if(y.Frame.isConnection(o)){if(o.type===i.FrameTypes.RESERVED)return;this.connectionFramesHandler.handle(o)}else if(y.Frame.isRequest(o)){if(this.registry[o.streamId])return;this.requestFramesHandler.handle(o,this)}else{var v=this.registry[o.streamId];if(!v)return;v.handle(o)}},c.prototype.connectionInbound=function(o){if(this.connectionFramesHandler)throw new Error("Connection frame handler has already been installed");this.connectionFramesHandler=o},c.prototype.handleRequestStream=function(o){if(this.requestFramesHandler)throw new Error("Stream handler has already been installed");this.requestFramesHandler=o},c.prototype.send=function(o){this.outbound.send(o)},Object.defineProperty(c.prototype,"connectionOutbound",{get:function(){return this},enumerable:!1,configurable:!0}),c.prototype.createRequestStream=function(o){var v=this;if(this.done){o.handleReject(new Error("Already closed"));return}var S=this.registry;this.streamIdSupplier.next(function(p){return o.handleReady(p,v)},Object.keys(S))},c.prototype.connect=function(o){this.registry[o.streamId]=o},c.prototype.disconnect=function(o){delete this.registry[o.streamId]},c.prototype.close=function(o){if(this.done){m.prototype.close.call(this,o);return}for(var v in this.registry){var S=this.registry[v];S.close(new Error("Closed. ".concat(o?"Original cause [".concat(o,"]."):"")))}m.prototype.close.call(this,o)},c}(s.Deferred);r.ClientServerInputMultiplexerDemultiplexer=h;var E=function(m){e(c,m);function c(o,v,S,p,R,N,M){var A=m.call(this,o,v,new s.Deferred)||this;return A.frameStore=p,A.token=R,A.sessionTimeout=M,N instanceof Function?A.reconnector=N:A.sessionStore=N,S.onClose(A.handleConnectionClose.bind(A)),A}return c.prototype.send=function(o){if(y.Frame.isConnection(o)){if(o.type===i.FrameTypes.KEEPALIVE)o.lastReceivedPosition=this.frameStore.lastReceivedFramePosition;else if(o.type===i.FrameTypes.ERROR){this.outbound.send(o),this.sessionStore&&delete this.sessionStore[this.token],m.prototype.close.call(this,new u.RSocketError(o.code,o.message));return}}else this.frameStore.store(o);this.outbound.send(o)},c.prototype.handle=function(o){if(y.Frame.isConnection(o)){if(o.type===i.FrameTypes.KEEPALIVE)try{this.frameStore.dropTo(o.lastReceivedPosition)}catch(v){this.outbound.send({type:i.FrameTypes.ERROR,streamId:0,flags:i.Flags.NONE,code:v.code,message:v.message}),this.close(v)}else if(o.type===i.FrameTypes.ERROR){m.prototype.handle.call(this,o),this.sessionStore&&delete this.sessionStore[this.token],m.prototype.close.call(this,new u.RSocketError(o.code,o.message));return}}else this.frameStore.record(o);m.prototype.handle.call(this,o)},c.prototype.resume=function(o,v,S){switch(this.outbound=v,o.type){case i.FrameTypes.RESUME:{if(clearTimeout(this.timeoutId),this.frameStore.lastReceivedFramePosition<o.clientPosition){var p=new u.RSocketError(i.ErrorCodes.REJECTED_RESUME,"Impossible to resume since first available client frame position is greater than last received server frame position");this.outbound.send({type:i.FrameTypes.ERROR,streamId:0,flags:i.Flags.NONE,code:p.code,message:p.message}),this.close(p);return}try{this.frameStore.dropTo(o.serverPosition)}catch(R){this.outbound.send({type:i.FrameTypes.ERROR,streamId:0,flags:i.Flags.NONE,code:R.code,message:R.message}),this.close(R);return}this.outbound.send({type:i.FrameTypes.RESUME_OK,streamId:0,flags:i.Flags.NONE,clientPosition:this.frameStore.lastReceivedFramePosition});break}case i.FrameTypes.RESUME_OK:{try{this.frameStore.dropTo(o.clientPosition)}catch(R){this.outbound.send({type:i.FrameTypes.ERROR,streamId:0,flags:i.Flags.NONE,code:R.code,message:R.message}),this.close(R)}break}}this.frameStore.drain(this.outbound.send.bind(this.outbound)),S.onClose(this.handleConnectionClose.bind(this)),this.connectionFramesHandler.resume()},c.prototype.handleConnectionClose=function(o){return t(this,void 0,void 0,function(){var v;return n(this,function(S){switch(S.label){case 0:if(this.connectionFramesHandler.pause(),!this.reconnector)return[3,5];S.label=1;case 1:return S.trys.push([1,3,,4]),[4,this.reconnector(this,this.frameStore)];case 2:return S.sent(),[3,4];case 3:return v=S.sent(),this.close(v),[3,4];case 4:return[3,6];case 5:this.timeoutId=setTimeout(this.close.bind(this),this.sessionTimeout),S.label=6;case 6:return[2]}})})},c}(h);r.ResumableClientServerInputMultiplexerDemultiplexer=E;var T=function(){function m(c,o,v){this.outbound=c,this.closeable=o,this.delegate=v,this.resumed=!1}return m.prototype.close=function(){this.delegate.close()},m.prototype.onClose=function(c){this.delegate.onClose(c)},Object.defineProperty(m.prototype,"connectionOutbound",{get:function(){return this.delegate.connectionOutbound},enumerable:!1,configurable:!0}),m.prototype.createRequestStream=function(c){this.delegate.createRequestStream(c)},m.prototype.connectionInbound=function(c){this.delegate.connectionInbound(c)},m.prototype.handleRequestStream=function(c){this.delegate.handleRequestStream(c)},m.prototype.handle=function(c){var o=this;if(!this.resumed){if(c.type===i.FrameTypes.RESUME_OK){this.resumed=!0,this.delegate.resume(c,this.outbound,this.closeable);return}else this.outbound.send({type:i.FrameTypes.ERROR,streamId:0,code:i.ErrorCodes.CONNECTION_ERROR,message:"Incomplete RESUME handshake. Unexpected frame ".concat(c.type," received"),flags:i.Flags.NONE}),this.closeable.close(),this.closeable.onClose(function(){return o.delegate.close(new u.RSocketError(i.ErrorCodes.CONNECTION_ERROR,"Incomplete RESUME handshake. Unexpected frame ".concat(c.type," received")))});return}this.delegate.handle(c)},m}();r.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer=T}(Ve)),Ve}var x={},me={},K={},ct=_&&_.__generator||function(r,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},n,i,s,u;return u={next:y(0),throw:y(1),return:y(2)},typeof Symbol=="function"&&(u[Symbol.iterator]=function(){return this}),u;function y(E){return function(T){return h([E,T])}}function h(E){if(n)throw new TypeError("Generator is already executing.");for(;t;)try{if(n=1,i&&(s=E[0]&2?i.return:E[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,E[1])).done)return s;switch(i=0,s&&(E=[E[0]&2,s.value]),E[0]){case 0:case 1:s=E;break;case 4:return t.label++,{value:E[1],done:!1};case 5:t.label++,i=E[1],E=[0];continue;case 7:E=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(E[0]===6||E[0]===2)){t=0;continue}if(E[0]===3&&(!s||E[1]>s[0]&&E[1]<s[3])){t.label=E[1];break}if(E[0]===6&&t.label<s[1]){t.label=s[1],s=E;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(E);break}s[2]&&t.ops.pop(),t.trys.pop();continue}E=e.call(r,t)}catch(T){E=[6,T],i=0}finally{n=s=0}if(E[0]&5)throw E[1];return{value:E[0]?E[1]:void 0,done:!0}}};Object.defineProperty(K,"__esModule",{value:!0});K.fragmentWithRequestN=K.fragment=K.isFragmentable=void 0;var b=H;function qt(r,e,t){return e===0?!1:r.data.byteLength+(r.metadata?r.metadata.byteLength+b.Lengths.METADATA:0)+(t==b.FrameTypes.REQUEST_STREAM||t==b.FrameTypes.REQUEST_CHANNEL?b.Lengths.REQUEST:0)>e}K.isFragmentable=qt;function xt(r,e,t,n,i){var s,u,y,h,E,T,m,m,c,o,v,v,S,p;return i===void 0&&(i=!1),ct(this,function(R){switch(R.label){case 0:return s=(p=(S=e.data)===null||S===void 0?void 0:S.byteLength)!==null&&p!==void 0?p:0,u=n!==b.FrameTypes.PAYLOAD,y=t,e.metadata?(E=e.metadata.byteLength,E!==0?[3,1]:(y-=b.Lengths.METADATA,h=Buffer.allocUnsafe(0),[3,6])):[3,6];case 1:return T=0,u?(y-=b.Lengths.METADATA,m=Math.min(E,T+y),h=e.metadata.slice(T,m),y-=h.byteLength,T=m,y!==0?[3,3]:(u=!1,[4,{type:n,flags:b.Flags.FOLLOWS|b.Flags.METADATA,data:void 0,metadata:h,streamId:r}])):[3,3];case 2:R.sent(),h=void 0,y=t,R.label=3;case 3:return T<E?(y-=b.Lengths.METADATA,m=Math.min(E,T+y),h=e.metadata.slice(T,m),y-=h.byteLength,T=m,y===0||s===0?[4,{type:b.FrameTypes.PAYLOAD,flags:b.Flags.NEXT|b.Flags.METADATA|(T===E&&i&&s===0?b.Flags.COMPLETE:b.Flags.FOLLOWS),data:void 0,metadata:h,streamId:r}]:[3,5]):[3,6];case 4:R.sent(),h=void 0,y=t,R.label=5;case 5:return[3,3];case 6:return c=0,u?(v=Math.min(s,c+y),o=e.data.slice(c,v),y-=o.byteLength,c=v,[4,{type:n,flags:b.Flags.FOLLOWS|(h?b.Flags.METADATA:b.Flags.NONE),data:o,metadata:h,streamId:r}]):[3,8];case 7:R.sent(),h=void 0,o=void 0,y=t,R.label=8;case 8:return c<s?(v=Math.min(s,c+y),o=e.data.slice(c,v),y-=o.byteLength,c=v,[4,{type:b.FrameTypes.PAYLOAD,flags:c===s?(i?b.Flags.COMPLETE:b.Flags.NONE)|b.Flags.NEXT|(h?b.Flags.METADATA:0):b.Flags.FOLLOWS|b.Flags.NEXT|(h?b.Flags.METADATA:0),data:o,metadata:h,streamId:r}]):[3,10];case 9:return R.sent(),h=void 0,o=void 0,y=t,[3,8];case 10:return[2]}})}K.fragment=xt;function kt(r,e,t,n,i,s){var u,y,h,E,T,m,c,c,o,v,S,S,p,R;return s===void 0&&(s=!1),ct(this,function(N){switch(N.label){case 0:return u=(R=(p=e.data)===null||p===void 0?void 0:p.byteLength)!==null&&R!==void 0?R:0,y=!0,h=t,e.metadata?(T=e.metadata.byteLength,T!==0?[3,1]:(h-=b.Lengths.METADATA,E=Buffer.allocUnsafe(0),[3,6])):[3,6];case 1:return m=0,y?(h-=b.Lengths.METADATA+b.Lengths.REQUEST,c=Math.min(T,m+h),E=e.metadata.slice(m,c),h-=E.byteLength,m=c,h!==0?[3,3]:(y=!1,[4,{type:n,flags:b.Flags.FOLLOWS|b.Flags.METADATA,data:void 0,requestN:i,metadata:E,streamId:r}])):[3,3];case 2:N.sent(),E=void 0,h=t,N.label=3;case 3:return m<T?(h-=b.Lengths.METADATA,c=Math.min(T,m+h),E=e.metadata.slice(m,c),h-=E.byteLength,m=c,h===0||u===0?[4,{type:b.FrameTypes.PAYLOAD,flags:b.Flags.NEXT|b.Flags.METADATA|(m===T&&s&&u===0?b.Flags.COMPLETE:b.Flags.FOLLOWS),data:void 0,metadata:E,streamId:r}]:[3,5]):[3,6];case 4:N.sent(),E=void 0,h=t,N.label=5;case 5:return[3,3];case 6:return o=0,y?(h-=b.Lengths.REQUEST,S=Math.min(u,o+h),v=e.data.slice(o,S),h-=v.byteLength,o=S,[4,{type:n,flags:b.Flags.FOLLOWS|(E?b.Flags.METADATA:b.Flags.NONE),data:v,requestN:i,metadata:E,streamId:r}]):[3,8];case 7:N.sent(),E=void 0,v=void 0,h=t,N.label=8;case 8:return o<u?(S=Math.min(u,o+h),v=e.data.slice(o,S),h-=v.byteLength,o=S,[4,{type:b.FrameTypes.PAYLOAD,flags:o===u?(s?b.Flags.COMPLETE:b.Flags.NONE)|b.Flags.NEXT|(E?b.Flags.METADATA:0):b.Flags.FOLLOWS|b.Flags.NEXT|(E?b.Flags.METADATA:0),data:v,metadata:E,streamId:r}]):[3,10];case 9:return N.sent(),E=void 0,v=void 0,h=t,[3,8];case 10:return[2]}})}K.fragmentWithRequestN=kt;var G={};Object.defineProperty(G,"__esModule",{value:!0});G.cancel=G.reassemble=G.add=void 0;function zt(r,e,t){return r.hasFragments?(r.data=r.data?Buffer.concat([r.data,e]):e,r.metadata&&t&&(r.metadata=Buffer.concat([r.metadata,t])),!0):(r.hasFragments=!0,r.data=e,t&&(r.metadata=t),!0)}G.add=zt;function jt(r,e,t){r.hasFragments=!1;var n=r.data?Buffer.concat([r.data,e]):e;if(r.data=void 0,r.metadata){var i=t?Buffer.concat([r.metadata,t]):r.metadata;return r.metadata=void 0,{data:n,metadata:i}}return{data:n}}G.reassemble=jt;function Bt(r){r.hasFragments=!1,r.data=void 0,r.metadata=void 0}G.cancel=Bt;var Ht=_&&_.__createBinding||(Object.create?function(r,e,t,n){n===void 0&&(n=t),Object.defineProperty(r,n,{enumerable:!0,get:function(){return e[t]}})}:function(r,e,t,n){n===void 0&&(n=t),r[n]=e[t]}),Qt=_&&_.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),Xt=_&&_.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&Ht(e,r,t);return Qt(e,r),e},Ke=_&&_.__values||function(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],n=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(me,"__esModule",{value:!0});me.RequestChannelResponderStream=me.RequestChannelRequesterStream=void 0;var k=re,he=K,F=H,Y=Xt(G),Vt=function(){function r(e,t,n,i,s,u){this.payload=e,this.isComplete=t,this.receiver=n,this.fragmentSize=i,this.initialRequestN=s,this.leaseManager=u,this.streamType=F.FrameTypes.REQUEST_CHANNEL}return r.prototype.handleReady=function(e,t){var n,i;if(this.outboundDone)return!1;this.streamId=e,this.stream=t,t.connect(this);var s=this.isComplete;if(s&&(this.outboundDone=s),(0,he.isFragmentable)(this.payload,this.fragmentSize,F.FrameTypes.REQUEST_CHANNEL))try{for(var u=Ke((0,he.fragmentWithRequestN)(e,this.payload,this.fragmentSize,F.FrameTypes.REQUEST_CHANNEL,this.initialRequestN,s)),y=u.next();!y.done;y=u.next()){var h=y.value;this.stream.send(h)}}catch(E){n={error:E}}finally{try{y&&!y.done&&(i=u.return)&&i.call(u)}finally{if(n)throw n.error}}else this.stream.send({type:F.FrameTypes.REQUEST_CHANNEL,data:this.payload.data,metadata:this.payload.metadata,requestN:this.initialRequestN,flags:(this.payload.metadata!==void 0?F.Flags.METADATA:F.Flags.NONE)|(s?F.Flags.COMPLETE:F.Flags.NONE),streamId:e});return this.hasExtension&&this.stream.send({type:F.FrameTypes.EXT,streamId:e,extendedContent:this.extendedContent,extendedType:this.extendedType,flags:this.flags}),!0},r.prototype.handleReject=function(e){this.inboundDone||(this.inboundDone=!0,this.outboundDone=!0,this.receiver.onError(e))},r.prototype.handle=function(e){var t,n=e.type;switch(n){case F.FrameTypes.PAYLOAD:{var i=F.Flags.hasComplete(e.flags),s=F.Flags.hasNext(e.flags);if(i||!F.Flags.hasFollows(e.flags)){if(i&&(this.inboundDone=!0,this.outboundDone&&this.stream.disconnect(this),!s)){this.receiver.onComplete();return}var u=this.hasFragments?Y.reassemble(this,e.data,e.metadata):{data:e.data,metadata:e.metadata};this.receiver.onNext(u,i);return}if(Y.add(this,e.data,e.metadata))return;t="Unexpected frame size";break}case F.FrameTypes.CANCEL:{if(this.outboundDone)return;this.outboundDone=!0,this.inboundDone&&this.stream.disconnect(this),this.receiver.cancel();return}case F.FrameTypes.REQUEST_N:{if(this.outboundDone)return;if(this.hasFragments){t="Unexpected frame type [".concat(n,"] during reassembly");break}this.receiver.request(e.requestN);return}case F.FrameTypes.ERROR:{var y=this.outboundDone;this.inboundDone=!0,this.outboundDone=!0,this.stream.disconnect(this),Y.cancel(this),y||this.receiver.cancel(),this.receiver.onError(new k.RSocketError(e.code,e.message));return}case F.FrameTypes.EXT:this.receiver.onExtension(e.extendedType,e.extendedContent,F.Flags.hasIgnore(e.flags));return;default:t="Unexpected frame type [".concat(n,"]")}this.close(new k.RSocketError(k.ErrorCodes.CANCELED,t)),this.stream.send({type:F.FrameTypes.CANCEL,streamId:this.streamId,flags:F.Flags.NONE}),this.stream.disconnect(this)},r.prototype.request=function(e){if(!this.inboundDone){if(!this.streamId){this.initialRequestN+=e;return}this.stream.send({type:F.FrameTypes.REQUEST_N,flags:F.Flags.NONE,requestN:e,streamId:this.streamId})}},r.prototype.cancel=function(){var e,t=this.inboundDone,n=this.outboundDone;if(!(t&&n)){if(this.inboundDone=!0,this.outboundDone=!0,n||this.receiver.cancel(),!this.streamId){(e=this.leaseManager)===null||e===void 0||e.cancelRequest(this);return}this.stream.send({type:t?F.FrameTypes.ERROR:F.FrameTypes.CANCEL,flags:F.Flags.NONE,streamId:this.streamId,code:k.ErrorCodes.CANCELED,message:"Cancelled"}),this.stream.disconnect(this),Y.cancel(this)}},r.prototype.onNext=function(e,t){var n,i;if(!this.outboundDone)if(t&&(this.outboundDone=!0,this.inboundDone&&this.stream.disconnect(this)),(0,he.isFragmentable)(e,this.fragmentSize,F.FrameTypes.PAYLOAD))try{for(var s=Ke((0,he.fragment)(this.streamId,e,this.fragmentSize,F.FrameTypes.PAYLOAD,t)),u=s.next();!u.done;u=s.next()){var y=u.value;this.stream.send(y)}}catch(h){n={error:h}}finally{try{u&&!u.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}else this.stream.send({type:F.FrameTypes.PAYLOAD,streamId:this.streamId,flags:F.Flags.NEXT|(e.metadata?F.Flags.METADATA:F.Flags.NONE)|(t?F.Flags.COMPLETE:F.Flags.NONE),data:e.data,metadata:e.metadata})},r.prototype.onComplete=function(){if(!this.streamId){this.isComplete=!0;return}this.outboundDone||(this.outboundDone=!0,this.stream.send({type:F.FrameTypes.PAYLOAD,streamId:this.streamId,flags:F.Flags.COMPLETE,data:null,metadata:null}),this.inboundDone&&this.stream.disconnect(this))},r.prototype.onError=function(e){if(!this.outboundDone){var t=this.inboundDone;this.outboundDone=!0,this.inboundDone=!0,this.stream.send({type:F.FrameTypes.ERROR,streamId:this.streamId,flags:F.Flags.NONE,code:e instanceof k.RSocketError?e.code:k.ErrorCodes.APPLICATION_ERROR,message:e.message}),this.stream.disconnect(this),t||this.receiver.onError(e)}},r.prototype.onExtension=function(e,t,n){if(!this.outboundDone){if(!this.streamId){this.hasExtension=!0,this.extendedType=e,this.extendedContent=t,this.flags=n?F.Flags.IGNORE:F.Flags.NONE;return}this.stream.send({streamId:this.streamId,type:F.FrameTypes.EXT,extendedType:e,extendedContent:t,flags:n?F.Flags.IGNORE:F.Flags.NONE})}},r.prototype.close=function(e){if(!(this.inboundDone&&this.outboundDone)){var t=this.inboundDone,n=this.outboundDone;this.inboundDone=!0,this.outboundDone=!0,Y.cancel(this),n||this.receiver.cancel(),t||(e?this.receiver.onError(e):this.receiver.onComplete())}},r}();me.RequestChannelRequesterStream=Vt;var Kt=function(){function r(e,t,n,i,s){if(this.streamId=e,this.stream=t,this.fragmentSize=n,this.handler=i,this.streamType=F.FrameTypes.REQUEST_CHANNEL,t.connect(this),F.Flags.hasFollows(s.flags)){Y.add(this,s.data,s.metadata),this.initialRequestN=s.requestN,this.isComplete=F.Flags.hasComplete(s.flags);return}var u={data:s.data,metadata:s.metadata},y=F.Flags.hasComplete(s.flags);this.inboundDone=y;try{this.receiver=i(u,s.requestN,y,this),this.outboundDone&&this.defferedError&&this.receiver.onError(this.defferedError)}catch(h){this.outboundDone&&!this.inboundDone?this.cancel():this.inboundDone=!0,this.onError(h)}}return r.prototype.handle=function(e){var t,n=e.type;switch(n){case F.FrameTypes.PAYLOAD:{if(F.Flags.hasFollows(e.flags)){if(Y.add(this,e.data,e.metadata))return;t="Unexpected frame size";break}var i=this.hasFragments?Y.reassemble(this,e.data,e.metadata):{data:e.data,metadata:e.metadata},s=F.Flags.hasComplete(e.flags);if(this.receiver){if(s&&(this.inboundDone=!0,this.outboundDone&&this.stream.disconnect(this),!F.Flags.hasNext(e.flags))){this.receiver.onComplete();return}this.receiver.onNext(i,s)}else{var u=this.isComplete||s;u&&(this.inboundDone=!0,this.outboundDone&&this.stream.disconnect(this));try{this.receiver=this.handler(i,this.initialRequestN,u,this),this.outboundDone&&this.defferedError}catch(E){this.outboundDone&&!this.inboundDone?this.cancel():this.inboundDone=!0,this.onError(E)}}return}case F.FrameTypes.REQUEST_N:{if(!this.receiver||this.hasFragments){t="Unexpected frame type [".concat(n,"] during reassembly");break}this.receiver.request(e.requestN);return}case F.FrameTypes.ERROR:case F.FrameTypes.CANCEL:{var u=this.inboundDone,y=this.outboundDone;if(this.inboundDone=!0,this.outboundDone=!0,this.stream.disconnect(this),Y.cancel(this),!this.receiver)return;if(y||this.receiver.cancel(),!u){var h=n===F.FrameTypes.CANCEL?new k.RSocketError(k.ErrorCodes.CANCELED,"Cancelled"):new k.RSocketError(e.code,e.message);this.receiver.onError(h)}return}case F.FrameTypes.EXT:{if(!this.receiver||this.hasFragments){t="Unexpected frame type [".concat(n,"] during reassembly");break}this.receiver.onExtension(e.extendedType,e.extendedContent,F.Flags.hasIgnore(e.flags));return}default:t="Unexpected frame type [".concat(n,"]")}this.stream.send({type:F.FrameTypes.ERROR,flags:F.Flags.NONE,code:k.ErrorCodes.CANCELED,message:t,streamId:this.streamId}),this.stream.disconnect(this),this.close(new k.RSocketError(k.ErrorCodes.CANCELED,t))},r.prototype.onError=function(e){if(this.outboundDone){console.warn("Trying to error for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}var t=this.inboundDone;this.outboundDone=!0,this.inboundDone=!0,this.stream.send({type:F.FrameTypes.ERROR,flags:F.Flags.NONE,code:e instanceof k.RSocketError?e.code:k.ErrorCodes.APPLICATION_ERROR,message:e.message,streamId:this.streamId}),this.stream.disconnect(this),t||(this.receiver?this.receiver.onError(e):this.defferedError=e)},r.prototype.onNext=function(e,t){var n,i;if(!this.outboundDone){if(t&&(this.outboundDone=!0),(0,he.isFragmentable)(e,this.fragmentSize,F.FrameTypes.PAYLOAD))try{for(var s=Ke((0,he.fragment)(this.streamId,e,this.fragmentSize,F.FrameTypes.PAYLOAD,t)),u=s.next();!u.done;u=s.next()){var y=u.value;this.stream.send(y)}}catch(h){n={error:h}}finally{try{u&&!u.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}else this.stream.send({type:F.FrameTypes.PAYLOAD,flags:F.Flags.NEXT|(t?F.Flags.COMPLETE:F.Flags.NONE)|(e.metadata?F.Flags.METADATA:F.Flags.NONE),data:e.data,metadata:e.metadata,streamId:this.streamId});t&&this.inboundDone&&this.stream.disconnect(this)}},r.prototype.onComplete=function(){this.outboundDone||(this.outboundDone=!0,this.stream.send({type:F.FrameTypes.PAYLOAD,flags:F.Flags.COMPLETE,streamId:this.streamId,data:null,metadata:null}),this.inboundDone&&this.stream.disconnect(this))},r.prototype.onExtension=function(e,t,n){this.outboundDone&&this.inboundDone||this.stream.send({type:F.FrameTypes.EXT,streamId:this.streamId,flags:n?F.Flags.IGNORE:F.Flags.NONE,extendedType:e,extendedContent:t})},r.prototype.request=function(e){this.inboundDone||this.stream.send({type:F.FrameTypes.REQUEST_N,flags:F.Flags.NONE,streamId:this.streamId,requestN:e})},r.prototype.cancel=function(){this.inboundDone||(this.inboundDone=!0,this.stream.send({type:F.FrameTypes.CANCEL,flags:F.Flags.NONE,streamId:this.streamId}),this.outboundDone&&this.stream.disconnect(this))},r.prototype.close=function(e){if(this.inboundDone&&this.outboundDone){console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}var t=this.inboundDone,n=this.outboundDone;this.inboundDone=!0,this.outboundDone=!0,Y.cancel(this);var i=this.receiver;i&&(n||i.cancel(),t||(e?i.onError(e):i.onComplete()))},r}();me.RequestChannelResponderStream=Kt;var pe={},Gt=_&&_.__createBinding||(Object.create?function(r,e,t,n){n===void 0&&(n=t),Object.defineProperty(r,n,{enumerable:!0,get:function(){return e[t]}})}:function(r,e,t,n){n===void 0&&(n=t),r[n]=e[t]}),Wt=_&&_.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),Yt=_&&_.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&Gt(e,r,t);return Wt(e,r),e},Jt=_&&_.__values||function(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],n=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(pe,"__esModule",{value:!0});pe.RequestFnfResponderStream=pe.RequestFnFRequesterStream=void 0;var ke=re,tt=K,z=H,be=Yt(G),Zt=function(){function r(e,t,n,i){this.payload=e,this.receiver=t,this.fragmentSize=n,this.leaseManager=i,this.streamType=z.FrameTypes.REQUEST_FNF}return r.prototype.handleReady=function(e,t){var n,i;if(this.done)return!1;if(this.streamId=e,(0,tt.isFragmentable)(this.payload,this.fragmentSize,z.FrameTypes.REQUEST_FNF))try{for(var s=Jt((0,tt.fragment)(e,this.payload,this.fragmentSize,z.FrameTypes.REQUEST_FNF)),u=s.next();!u.done;u=s.next()){var y=u.value;t.send(y)}}catch(h){n={error:h}}finally{try{u&&!u.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}else t.send({type:z.FrameTypes.REQUEST_FNF,data:this.payload.data,metadata:this.payload.metadata,flags:this.payload.metadata?z.Flags.METADATA:0,streamId:e});return this.done=!0,this.receiver.onComplete(),!0},r.prototype.handleReject=function(e){this.done||(this.done=!0,this.receiver.onError(e))},r.prototype.cancel=function(){var e;this.done||(this.done=!0,(e=this.leaseManager)===null||e===void 0||e.cancelRequest(this))},r.prototype.handle=function(e){if(e.type==z.FrameTypes.ERROR){this.close(new ke.RSocketError(e.code,e.message));return}this.close(new ke.RSocketError(ke.ErrorCodes.CANCELED,"Received invalid frame"))},r.prototype.close=function(e){if(this.done){console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}e?this.receiver.onError(e):this.receiver.onComplete()},r}();pe.RequestFnFRequesterStream=Zt;var $t=function(){function r(e,t,n,i){if(this.streamId=e,this.stream=t,this.handler=n,this.streamType=z.FrameTypes.REQUEST_FNF,z.Flags.hasFollows(i.flags)){be.add(this,i.data,i.metadata),t.connect(this);return}var s={data:i.data,metadata:i.metadata};try{this.cancellable=n(s,this)}catch{}}return r.prototype.handle=function(e){var t;if(e.type==z.FrameTypes.PAYLOAD)if(z.Flags.hasFollows(e.flags)){if(be.add(this,e.data,e.metadata))return;t="Unexpected fragment size"}else{this.stream.disconnect(this);var n=be.reassemble(this,e.data,e.metadata);try{this.cancellable=this.handler(n,this)}catch{}return}else t="Unexpected frame type [".concat(e.type,"]");this.done=!0,e.type!=z.FrameTypes.CANCEL&&e.type!=z.FrameTypes.ERROR&&this.stream.send({type:z.FrameTypes.ERROR,streamId:this.streamId,flags:z.Flags.NONE,code:ke.ErrorCodes.CANCELED,message:t}),this.stream.disconnect(this),be.cancel(this)},r.prototype.close=function(e){var t;if(this.done){console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}this.done=!0,be.cancel(this),(t=this.cancellable)===null||t===void 0||t.cancel()},r.prototype.onError=function(e){},r.prototype.onComplete=function(){},r}();pe.RequestFnfResponderStream=$t;var ye={},er=_&&_.__createBinding||(Object.create?function(r,e,t,n){n===void 0&&(n=t),Object.defineProperty(r,n,{enumerable:!0,get:function(){return e[t]}})}:function(r,e,t,n){n===void 0&&(n=t),r[n]=e[t]}),tr=_&&_.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),rr=_&&_.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&er(e,r,t);return tr(e,r),e},dt=_&&_.__values||function(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],n=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(ye,"__esModule",{value:!0});ye.RequestResponseResponderStream=ye.RequestResponseRequesterStream=void 0;var fe=re,ze=K,D=H,J=rr(G),nr=function(){function r(e,t,n,i){this.payload=e,this.receiver=t,this.fragmentSize=n,this.leaseManager=i,this.streamType=D.FrameTypes.REQUEST_RESPONSE}return r.prototype.handleReady=function(e,t){var n,i;if(this.done)return!1;if(this.streamId=e,this.stream=t,t.connect(this),(0,ze.isFragmentable)(this.payload,this.fragmentSize,D.FrameTypes.REQUEST_RESPONSE))try{for(var s=dt((0,ze.fragment)(e,this.payload,this.fragmentSize,D.FrameTypes.REQUEST_RESPONSE)),u=s.next();!u.done;u=s.next()){var y=u.value;this.stream.send(y)}}catch(h){n={error:h}}finally{try{u&&!u.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}else this.stream.send({type:D.FrameTypes.REQUEST_RESPONSE,data:this.payload.data,metadata:this.payload.metadata,flags:this.payload.metadata?D.Flags.METADATA:0,streamId:e});return this.hasExtension&&this.stream.send({type:D.FrameTypes.EXT,streamId:e,extendedContent:this.extendedContent,extendedType:this.extendedType,flags:this.flags}),!0},r.prototype.handleReject=function(e){this.done||(this.done=!0,this.receiver.onError(e))},r.prototype.handle=function(e){var t,n=e.type;switch(n){case D.FrameTypes.PAYLOAD:{var i=D.Flags.hasComplete(e.flags),s=D.Flags.hasNext(e.flags);if(i||!D.Flags.hasFollows(e.flags)){if(this.done=!0,this.stream.disconnect(this),!s){this.receiver.onComplete();return}var u=this.hasFragments?J.reassemble(this,e.data,e.metadata):{data:e.data,metadata:e.metadata};this.receiver.onNext(u,!0);return}if(!J.add(this,e.data,e.metadata)){t="Unexpected fragment size";break}return}case D.FrameTypes.ERROR:{this.done=!0,this.stream.disconnect(this),J.cancel(this),this.receiver.onError(new fe.RSocketError(e.code,e.message));return}case D.FrameTypes.EXT:{if(this.hasFragments){t="Unexpected frame type [".concat(n,"] during reassembly");break}this.receiver.onExtension(e.extendedType,e.extendedContent,D.Flags.hasIgnore(e.flags));return}default:t="Unexpected frame type [".concat(n,"]")}this.close(new fe.RSocketError(fe.ErrorCodes.CANCELED,t)),this.stream.send({type:D.FrameTypes.CANCEL,streamId:this.streamId,flags:D.Flags.NONE}),this.stream.disconnect(this)},r.prototype.cancel=function(){var e;if(!this.done){if(this.done=!0,!this.streamId){(e=this.leaseManager)===null||e===void 0||e.cancelRequest(this);return}this.stream.send({type:D.FrameTypes.CANCEL,flags:D.Flags.NONE,streamId:this.streamId}),this.stream.disconnect(this),J.cancel(this)}},r.prototype.onExtension=function(e,t,n){if(!this.done){if(!this.streamId){this.hasExtension=!0,this.extendedType=e,this.extendedContent=t,this.flags=n?D.Flags.IGNORE:D.Flags.NONE;return}this.stream.send({streamId:this.streamId,type:D.FrameTypes.EXT,extendedType:e,extendedContent:t,flags:n?D.Flags.IGNORE:D.Flags.NONE})}},r.prototype.close=function(e){this.done||(this.done=!0,J.cancel(this),e?this.receiver.onError(e):this.receiver.onComplete())},r}();ye.RequestResponseRequesterStream=nr;var ar=function(){function r(e,t,n,i,s){if(this.streamId=e,this.stream=t,this.fragmentSize=n,this.handler=i,this.streamType=D.FrameTypes.REQUEST_RESPONSE,t.connect(this),D.Flags.hasFollows(s.flags)){J.add(this,s.data,s.metadata);return}var u={data:s.data,metadata:s.metadata};try{this.receiver=i(u,this)}catch(y){this.onError(y)}}return r.prototype.handle=function(e){var t,n;if(!this.receiver||this.hasFragments)if(e.type===D.FrameTypes.PAYLOAD)if(D.Flags.hasFollows(e.flags)){if(J.add(this,e.data,e.metadata))return;n="Unexpected fragment size"}else{var i=J.reassemble(this,e.data,e.metadata);try{this.receiver=this.handler(i,this)}catch(s){this.onError(s)}return}else n="Unexpected frame type [".concat(e.type,"] during reassembly");else if(e.type===D.FrameTypes.EXT){this.receiver.onExtension(e.extendedType,e.extendedContent,D.Flags.hasIgnore(e.flags));return}else n="Unexpected frame type [".concat(e.type,"]");this.done=!0,(t=this.receiver)===null||t===void 0||t.cancel(),e.type!==D.FrameTypes.CANCEL&&e.type!==D.FrameTypes.ERROR&&this.stream.send({type:D.FrameTypes.ERROR,flags:D.Flags.NONE,code:fe.ErrorCodes.CANCELED,message:n,streamId:this.streamId}),this.stream.disconnect(this),J.cancel(this)},r.prototype.onError=function(e){if(this.done){console.warn("Trying to error for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}this.done=!0,this.stream.send({type:D.FrameTypes.ERROR,flags:D.Flags.NONE,code:e instanceof fe.RSocketError?e.code:fe.ErrorCodes.APPLICATION_ERROR,message:e.message,streamId:this.streamId}),this.stream.disconnect(this)},r.prototype.onNext=function(e,t){var n,i;if(!this.done){if(this.done=!0,(0,ze.isFragmentable)(e,this.fragmentSize,D.FrameTypes.PAYLOAD))try{for(var s=dt((0,ze.fragment)(this.streamId,e,this.fragmentSize,D.FrameTypes.PAYLOAD,!0)),u=s.next();!u.done;u=s.next()){var y=u.value;this.stream.send(y)}}catch(h){n={error:h}}finally{try{u&&!u.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}else this.stream.send({type:D.FrameTypes.PAYLOAD,flags:D.Flags.NEXT|D.Flags.COMPLETE|(e.metadata?D.Flags.METADATA:0),data:e.data,metadata:e.metadata,streamId:this.streamId});this.stream.disconnect(this)}},r.prototype.onComplete=function(){this.done||(this.done=!0,this.stream.send({type:D.FrameTypes.PAYLOAD,flags:D.Flags.COMPLETE,streamId:this.streamId,data:null,metadata:null}),this.stream.disconnect(this))},r.prototype.onExtension=function(e,t,n){this.done||this.stream.send({type:D.FrameTypes.EXT,streamId:this.streamId,flags:n?D.Flags.IGNORE:D.Flags.NONE,extendedType:e,extendedContent:t})},r.prototype.close=function(e){var t;if(this.done){console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}J.cancel(this),(t=this.receiver)===null||t===void 0||t.cancel()},r}();ye.RequestResponseResponderStream=ar;var ve={},sr=_&&_.__createBinding||(Object.create?function(r,e,t,n){n===void 0&&(n=t),Object.defineProperty(r,n,{enumerable:!0,get:function(){return e[t]}})}:function(r,e,t,n){n===void 0&&(n=t),r[n]=e[t]}),ir=_&&_.__setModuleDefault||(Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e}),or=_&&_.__importStar||function(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t in r)t!=="default"&&Object.prototype.hasOwnProperty.call(r,t)&&sr(e,r,t);return ir(e,r),e},ht=_&&_.__values||function(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],n=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(ve,"__esModule",{value:!0});ve.RequestStreamResponderStream=ve.RequestStreamRequesterStream=void 0;var Ee=re,je=K,O=H,Z=or(G),lr=function(){function r(e,t,n,i,s){this.payload=e,this.receiver=t,this.fragmentSize=n,this.initialRequestN=i,this.leaseManager=s,this.streamType=O.FrameTypes.REQUEST_STREAM}return r.prototype.handleReady=function(e,t){var n,i;if(this.done)return!1;if(this.streamId=e,this.stream=t,t.connect(this),(0,je.isFragmentable)(this.payload,this.fragmentSize,O.FrameTypes.REQUEST_STREAM))try{for(var s=ht((0,je.fragmentWithRequestN)(e,this.payload,this.fragmentSize,O.FrameTypes.REQUEST_STREAM,this.initialRequestN)),u=s.next();!u.done;u=s.next()){var y=u.value;this.stream.send(y)}}catch(h){n={error:h}}finally{try{u&&!u.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}else this.stream.send({type:O.FrameTypes.REQUEST_STREAM,data:this.payload.data,metadata:this.payload.metadata,requestN:this.initialRequestN,flags:this.payload.metadata!==void 0?O.Flags.METADATA:0,streamId:e});return this.hasExtension&&this.stream.send({type:O.FrameTypes.EXT,streamId:e,extendedContent:this.extendedContent,extendedType:this.extendedType,flags:this.flags}),!0},r.prototype.handleReject=function(e){this.done||(this.done=!0,this.receiver.onError(e))},r.prototype.handle=function(e){var t,n=e.type;switch(n){case O.FrameTypes.PAYLOAD:{var i=O.Flags.hasComplete(e.flags),s=O.Flags.hasNext(e.flags);if(i||!O.Flags.hasFollows(e.flags)){if(i&&(this.done=!0,this.stream.disconnect(this),!s)){this.receiver.onComplete();return}var u=this.hasFragments?Z.reassemble(this,e.data,e.metadata):{data:e.data,metadata:e.metadata};this.receiver.onNext(u,i);return}if(!Z.add(this,e.data,e.metadata)){t="Unexpected fragment size";break}return}case O.FrameTypes.ERROR:{this.done=!0,this.stream.disconnect(this),Z.cancel(this),this.receiver.onError(new Ee.RSocketError(e.code,e.message));return}case O.FrameTypes.EXT:{if(this.hasFragments){t="Unexpected frame type [".concat(n,"] during reassembly");break}this.receiver.onExtension(e.extendedType,e.extendedContent,O.Flags.hasIgnore(e.flags));return}default:t="Unexpected frame type [".concat(n,"]")}this.close(new Ee.RSocketError(Ee.ErrorCodes.CANCELED,t)),this.stream.send({type:O.FrameTypes.CANCEL,streamId:this.streamId,flags:O.Flags.NONE}),this.stream.disconnect(this)},r.prototype.request=function(e){if(!this.done){if(!this.streamId){this.initialRequestN+=e;return}this.stream.send({type:O.FrameTypes.REQUEST_N,flags:O.Flags.NONE,requestN:e,streamId:this.streamId})}},r.prototype.cancel=function(){var e;if(!this.done){if(this.done=!0,!this.streamId){(e=this.leaseManager)===null||e===void 0||e.cancelRequest(this);return}this.stream.send({type:O.FrameTypes.CANCEL,flags:O.Flags.NONE,streamId:this.streamId}),this.stream.disconnect(this),Z.cancel(this)}},r.prototype.onExtension=function(e,t,n){if(!this.done){if(!this.streamId){this.hasExtension=!0,this.extendedType=e,this.extendedContent=t,this.flags=n?O.Flags.IGNORE:O.Flags.NONE;return}this.stream.send({streamId:this.streamId,type:O.FrameTypes.EXT,extendedType:e,extendedContent:t,flags:n?O.Flags.IGNORE:O.Flags.NONE})}},r.prototype.close=function(e){this.done||(this.done=!0,Z.cancel(this),e?this.receiver.onError(e):this.receiver.onComplete())},r}();ve.RequestStreamRequesterStream=lr;var ur=function(){function r(e,t,n,i,s){if(this.streamId=e,this.stream=t,this.fragmentSize=n,this.handler=i,this.streamType=O.FrameTypes.REQUEST_STREAM,t.connect(this),O.Flags.hasFollows(s.flags)){this.initialRequestN=s.requestN,Z.add(this,s.data,s.metadata);return}var u={data:s.data,metadata:s.metadata};try{this.receiver=i(u,s.requestN,this)}catch(y){this.onError(y)}}return r.prototype.handle=function(e){var t,n;if(!this.receiver||this.hasFragments)if(e.type===O.FrameTypes.PAYLOAD)if(O.Flags.hasFollows(e.flags)){if(Z.add(this,e.data,e.metadata))return;n="Unexpected frame size"}else{var i=Z.reassemble(this,e.data,e.metadata);try{this.receiver=this.handler(i,this.initialRequestN,this)}catch(s){this.onError(s)}return}else n="Unexpected frame type [".concat(e.type,"] during reassembly");else if(e.type===O.FrameTypes.REQUEST_N){this.receiver.request(e.requestN);return}else if(e.type===O.FrameTypes.EXT){this.receiver.onExtension(e.extendedType,e.extendedContent,O.Flags.hasIgnore(e.flags));return}else n="Unexpected frame type [".concat(e.type,"]");this.done=!0,Z.cancel(this),(t=this.receiver)===null||t===void 0||t.cancel(),e.type!==O.FrameTypes.CANCEL&&e.type!==O.FrameTypes.ERROR&&this.stream.send({type:O.FrameTypes.ERROR,flags:O.Flags.NONE,code:Ee.ErrorCodes.CANCELED,message:n,streamId:this.streamId}),this.stream.disconnect(this)},r.prototype.onError=function(e){if(this.done){console.warn("Trying to error for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}this.done=!0,this.stream.send({type:O.FrameTypes.ERROR,flags:O.Flags.NONE,code:e instanceof Ee.RSocketError?e.code:Ee.ErrorCodes.APPLICATION_ERROR,message:e.message,streamId:this.streamId}),this.stream.disconnect(this)},r.prototype.onNext=function(e,t){var n,i;if(!this.done){if(t&&(this.done=!0),(0,je.isFragmentable)(e,this.fragmentSize,O.FrameTypes.PAYLOAD))try{for(var s=ht((0,je.fragment)(this.streamId,e,this.fragmentSize,O.FrameTypes.PAYLOAD,t)),u=s.next();!u.done;u=s.next()){var y=u.value;this.stream.send(y)}}catch(h){n={error:h}}finally{try{u&&!u.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}else this.stream.send({type:O.FrameTypes.PAYLOAD,flags:O.Flags.NEXT|(t?O.Flags.COMPLETE:O.Flags.NONE)|(e.metadata?O.Flags.METADATA:O.Flags.NONE),data:e.data,metadata:e.metadata,streamId:this.streamId});t&&this.stream.disconnect(this)}},r.prototype.onComplete=function(){this.done||(this.done=!0,this.stream.send({type:O.FrameTypes.PAYLOAD,flags:O.Flags.COMPLETE,streamId:this.streamId,data:null,metadata:null}),this.stream.disconnect(this))},r.prototype.onExtension=function(e,t,n){this.done||this.stream.send({type:O.FrameTypes.EXT,streamId:this.streamId,flags:n?O.Flags.IGNORE:O.Flags.NONE,extendedType:e,extendedContent:t})},r.prototype.close=function(e){var t;if(this.done){console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));return}Z.cancel(this),(t=this.receiver)===null||t===void 0||t.cancel()},r}();ve.RequestStreamResponderStream=ur;Object.defineProperty(x,"__esModule",{value:!0});x.KeepAliveSender=x.KeepAliveHandler=x.DefaultConnectionFrameHandler=x.DefaultStreamRequestHandler=x.LeaseHandler=x.RSocketRequester=void 0;var Ie=re,U=H,ft=me,Et=pe,mt=ye,pt=ve,cr=function(){function r(e,t,n){this.connection=e,this.fragmentSize=t,this.leaseManager=n}return r.prototype.fireAndForget=function(e,t){var n=new Et.RequestFnFRequesterStream(e,t,this.fragmentSize,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(n):this.connection.multiplexerDemultiplexer.createRequestStream(n),n},r.prototype.requestResponse=function(e,t){var n=new mt.RequestResponseRequesterStream(e,t,this.fragmentSize,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(n):this.connection.multiplexerDemultiplexer.createRequestStream(n),n},r.prototype.requestStream=function(e,t,n){var i=new pt.RequestStreamRequesterStream(e,n,this.fragmentSize,t,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(i):this.connection.multiplexerDemultiplexer.createRequestStream(i),i},r.prototype.requestChannel=function(e,t,n,i){var s=new ft.RequestChannelRequesterStream(e,n,i,this.fragmentSize,t,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(s):this.connection.multiplexerDemultiplexer.createRequestStream(s),s},r.prototype.metadataPush=function(e,t){throw new Error("Method not implemented.")},r.prototype.close=function(e){this.connection.close(e)},r.prototype.onClose=function(e){this.connection.onClose(e)},r}();x.RSocketRequester=cr;var dr=function(){function r(e,t){this.maxPendingRequests=e,this.multiplexer=t,this.pendingRequests=[],this.expirationTime=0,this.availableLease=0}return r.prototype.handle=function(e){for(this.expirationTime=e.ttl+Date.now(),this.availableLease=e.requestCount;this.availableLease>0&&this.pendingRequests.length>0;){var t=this.pendingRequests.shift();this.availableLease--,this.multiplexer.createRequestStream(t)}},r.prototype.requestLease=function(e){var t=this.availableLease;if(t>0&&Date.now()<this.expirationTime){this.availableLease=t-1,this.multiplexer.createRequestStream(e);return}if(this.pendingRequests.length>=this.maxPendingRequests){e.handleReject(new Ie.RSocketError(Ie.ErrorCodes.REJECTED,"No available lease given"));return}this.pendingRequests.push(e)},r.prototype.cancelRequest=function(e){var t=this.pendingRequests.indexOf(e);t>-1&&this.pendingRequests.splice(t,1)},r}();x.LeaseHandler=dr;var hr=function(){function r(e,t){this.rsocket=e,this.fragmentSize=t}return r.prototype.handle=function(e,t){switch(e.type){case U.FrameTypes.REQUEST_FNF:this.rsocket.fireAndForget&&new Et.RequestFnfResponderStream(e.streamId,t,this.rsocket.fireAndForget.bind(this.rsocket),e);return;case U.FrameTypes.REQUEST_RESPONSE:if(this.rsocket.requestResponse){new mt.RequestResponseResponderStream(e.streamId,t,this.fragmentSize,this.rsocket.requestResponse.bind(this.rsocket),e);return}this.rejectRequest(e.streamId,t);return;case U.FrameTypes.REQUEST_STREAM:if(this.rsocket.requestStream){new pt.RequestStreamResponderStream(e.streamId,t,this.fragmentSize,this.rsocket.requestStream.bind(this.rsocket),e);return}this.rejectRequest(e.streamId,t);return;case U.FrameTypes.REQUEST_CHANNEL:if(this.rsocket.requestChannel){new ft.RequestChannelResponderStream(e.streamId,t,this.fragmentSize,this.rsocket.requestChannel.bind(this.rsocket),e);return}this.rejectRequest(e.streamId,t);return}},r.prototype.rejectRequest=function(e,t){t.send({type:U.FrameTypes.ERROR,streamId:e,flags:U.Flags.NONE,code:Ie.ErrorCodes.REJECTED,message:"No available handler found"})},r.prototype.close=function(){},r}();x.DefaultStreamRequestHandler=hr;var fr=function(){function r(e,t,n,i,s){this.connection=e,this.keepAliveHandler=t,this.keepAliveSender=n,this.leaseHandler=i,this.rsocket=s}return r.prototype.handle=function(e){switch(e.type){case U.FrameTypes.KEEPALIVE:this.keepAliveHandler.handle(e);return;case U.FrameTypes.LEASE:if(this.leaseHandler){this.leaseHandler.handle(e);return}return;case U.FrameTypes.ERROR:this.connection.close(new Ie.RSocketError(e.code,e.message));return;case U.FrameTypes.METADATA_PUSH:this.rsocket.metadataPush;return;default:this.connection.multiplexerDemultiplexer.connectionOutbound.send({type:U.FrameTypes.ERROR,streamId:0,flags:U.Flags.NONE,message:"Received unknown frame type",code:Ie.ErrorCodes.CONNECTION_ERROR})}},r.prototype.pause=function(){var e;this.keepAliveHandler.pause(),(e=this.keepAliveSender)===null||e===void 0||e.pause()},r.prototype.resume=function(){var e;this.keepAliveHandler.start(),(e=this.keepAliveSender)===null||e===void 0||e.start()},r.prototype.close=function(e){var t;this.keepAliveHandler.close(),(t=this.rsocket.close)===null||t===void 0||t.call(this.rsocket,e)},r}();x.DefaultConnectionFrameHandler=fr;var se;(function(r){r[r.Paused=0]="Paused",r[r.Running=1]="Running",r[r.Closed=2]="Closed"})(se||(se={}));var Er=function(){function r(e,t){this.connection=e,this.keepAliveTimeoutDuration=t,this.state=se.Paused,this.outbound=e.multiplexerDemultiplexer.connectionOutbound}return r.prototype.handle=function(e){this.keepAliveLastReceivedMillis=Date.now(),U.Flags.hasRespond(e.flags)&&this.outbound.send({type:U.FrameTypes.KEEPALIVE,streamId:0,data:e.data,flags:e.flags^U.Flags.RESPOND,lastReceivedPosition:0})},r.prototype.start=function(){this.state===se.Paused&&(this.keepAliveLastReceivedMillis=Date.now(),this.state=se.Running,this.activeTimeout=setTimeout(this.timeoutCheck.bind(this),this.keepAliveTimeoutDuration))},r.prototype.pause=function(){this.state===se.Running&&(this.state=se.Paused,clearTimeout(this.activeTimeout))},r.prototype.close=function(){this.state=se.Closed,clearTimeout(this.activeTimeout)},r.prototype.timeoutCheck=function(){var e=Date.now(),t=e-this.keepAliveLastReceivedMillis;t>=this.keepAliveTimeoutDuration?this.connection.close(new Error("No keep-alive acks for ".concat(this.keepAliveTimeoutDuration," millis"))):this.activeTimeout=setTimeout(this.timeoutCheck.bind(this),Math.max(100,this.keepAliveTimeoutDuration-t))},r}();x.KeepAliveHandler=Er;var ie;(function(r){r[r.Paused=0]="Paused",r[r.Running=1]="Running",r[r.Closed=2]="Closed"})(ie||(ie={}));var mr=function(){function r(e,t){this.outbound=e,this.keepAlivePeriodDuration=t,this.state=ie.Paused}return r.prototype.sendKeepAlive=function(){this.outbound.send({type:U.FrameTypes.KEEPALIVE,streamId:0,data:void 0,flags:U.Flags.RESPOND,lastReceivedPosition:0})},r.prototype.start=function(){this.state===ie.Paused&&(this.state=ie.Running,this.activeInterval=setInterval(this.sendKeepAlive.bind(this),this.keepAlivePeriodDuration))},r.prototype.pause=function(){this.state===ie.Running&&(this.state=ie.Paused,clearInterval(this.activeInterval))},r.prototype.close=function(){this.state=ie.Closed,clearInterval(this.activeInterval)},r}();x.KeepAliveSender=mr;var Ne={},rt;function yt(){if(rt)return Ne;rt=1;var r=_&&_.__values||function(i){var s=typeof Symbol=="function"&&Symbol.iterator,u=s&&i[s],y=0;if(u)return u.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&y>=i.length&&(i=void 0),{value:i&&i[y++],done:!i}}};throw new TypeError(s?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(Ne,"__esModule",{value:!0}),Ne.FrameStore=void 0;var e=Le(),t=Ge,n=function(){function i(){this.storedFrames=[],this._lastReceivedFramePosition=0,this._firstAvailableFramePosition=0,this._lastSentFramePosition=0}return Object.defineProperty(i.prototype,"lastReceivedFramePosition",{get:function(){return this._lastReceivedFramePosition},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"firstAvailableFramePosition",{get:function(){return this._firstAvailableFramePosition},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"lastSentFramePosition",{get:function(){return this._lastSentFramePosition},enumerable:!1,configurable:!0}),i.prototype.store=function(s){this._lastSentFramePosition+=(0,t.sizeOfFrame)(s),this.storedFrames.push(s)},i.prototype.record=function(s){this._lastReceivedFramePosition+=(0,t.sizeOfFrame)(s)},i.prototype.dropTo=function(s){for(var u=s-this._firstAvailableFramePosition;u>0&&this.storedFrames.length>0;){var y=this.storedFrames.shift();u-=(0,t.sizeOfFrame)(y)}if(u!==0)throw new e.RSocketError(e.ErrorCodes.CONNECTION_ERROR,"State inconsistency. Expected bytes to drop ".concat(s-this._firstAvailableFramePosition," but actual ").concat(u));this._firstAvailableFramePosition=s},i.prototype.drain=function(s){var u,y;try{for(var h=r(this.storedFrames),E=h.next();!E.done;E=h.next()){var T=E.value;s(T)}}catch(m){u={error:m}}finally{try{E&&!E.done&&(y=h.return)&&y.call(h)}finally{if(u)throw u.error}}},i}();return Ne.FrameStore=n,Ne}var nt;function pr(){if(nt)return Oe;nt=1;var r=_&&_.__awaiter||function(y,h,E,T){function m(c){return c instanceof E?c:new E(function(o){o(c)})}return new(E||(E=Promise))(function(c,o){function v(R){try{p(T.next(R))}catch(N){o(N)}}function S(R){try{p(T.throw(R))}catch(N){o(N)}}function p(R){R.done?c(R.value):m(R.value).then(v,S)}p((T=T.apply(y,h||[])).next())})},e=_&&_.__generator||function(y,h){var E={label:0,sent:function(){if(c[0]&1)throw c[1];return c[1]},trys:[],ops:[]},T,m,c,o;return o={next:v(0),throw:v(1),return:v(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function v(p){return function(R){return S([p,R])}}function S(p){if(T)throw new TypeError("Generator is already executing.");for(;E;)try{if(T=1,m&&(c=p[0]&2?m.return:p[0]?m.throw||((c=m.return)&&c.call(m),0):m.next)&&!(c=c.call(m,p[1])).done)return c;switch(m=0,c&&(p=[p[0]&2,c.value]),p[0]){case 0:case 1:c=p;break;case 4:return E.label++,{value:p[1],done:!1};case 5:E.label++,m=p[1],p=[0];continue;case 7:p=E.ops.pop(),E.trys.pop();continue;default:if(c=E.trys,!(c=c.length>0&&c[c.length-1])&&(p[0]===6||p[0]===2)){E=0;continue}if(p[0]===3&&(!c||p[1]>c[0]&&p[1]<c[3])){E.label=p[1];break}if(p[0]===6&&E.label<c[1]){E.label=c[1],c=p;break}if(c&&E.label<c[2]){E.label=c[2],E.ops.push(p);break}c[2]&&E.ops.pop(),E.trys.pop();continue}p=h.call(y,E)}catch(R){p=[6,R],m=0}finally{T=c=0}if(p[0]&5)throw p[1];return{value:p[0]?p[1]:void 0,done:!0}}};Object.defineProperty(Oe,"__esModule",{value:!0}),Oe.RSocketConnector=void 0;var t=ut(),n=H,i=x,s=yt(),u=function(){function y(h){this.config=h}return y.prototype.connect=function(){var h,E,T,m,c,o,v,S,p,R,N,M,A,w,q,$,ee,W,te,Q;return r(this,void 0,void 0,function(){var P,X,B,oe,le,Re,ge,Te,Me,Qe=this;return e(this,function(Pe){switch(Pe.label){case 0:return P=this.config,X={type:n.FrameTypes.SETUP,dataMimeType:(E=(h=P.setup)===null||h===void 0?void 0:h.dataMimeType)!==null&&E!==void 0?E:"application/octet-stream",metadataMimeType:(m=(T=P.setup)===null||T===void 0?void 0:T.metadataMimeType)!==null&&m!==void 0?m:"application/octet-stream",keepAlive:(o=(c=P.setup)===null||c===void 0?void 0:c.keepAlive)!==null&&o!==void 0?o:6e4,lifetime:(S=(v=P.setup)===null||v===void 0?void 0:v.lifetime)!==null&&S!==void 0?S:3e5,metadata:(R=(p=P.setup)===null||p===void 0?void 0:p.payload)===null||R===void 0?void 0:R.metadata,data:(M=(N=P.setup)===null||N===void 0?void 0:N.payload)===null||M===void 0?void 0:M.data,resumeToken:(w=(A=P.resume)===null||A===void 0?void 0:A.tokenGenerator())!==null&&w!==void 0?w:null,streamId:0,majorVersion:1,minorVersion:0,flags:(!(($=(q=P.setup)===null||q===void 0?void 0:q.payload)===null||$===void 0)&&$.metadata?n.Flags.METADATA:n.Flags.NONE)|(P.lease?n.Flags.LEASE:n.Flags.NONE)|(P.resume?n.Flags.RESUME_ENABLE:n.Flags.NONE)},[4,P.transport.connect(function(ne){return P.resume?new t.ResumableClientServerInputMultiplexerDemultiplexer(t.StreamIdGenerator.create(-1),ne,ne,new s.FrameStore,X.resumeToken.toString(),function(we,Ue){return r(Qe,void 0,void 0,function(){var qe,Fe,Se;return e(this,function(_e){switch(_e.label){case 0:return qe=function(Ae){return Ae.send({type:n.FrameTypes.RESUME,streamId:0,flags:n.Flags.NONE,clientPosition:Ue.firstAvailableFramePosition,serverPosition:Ue.lastReceivedFramePosition,majorVersion:X.minorVersion,minorVersion:X.majorVersion,resumeToken:X.resumeToken}),new t.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer(Ae,Ae,we)},Fe=-1,Se=function(){return Fe++,P.resume.reconnectFunction(Fe).then(function(){return P.transport.connect(qe).catch(Se)})},[4,Se()];case 1:return _e.sent(),[2]}})})}):new t.ClientServerInputMultiplexerDemultiplexer(t.StreamIdGenerator.create(-1),ne,ne)})];case 1:return B=Pe.sent(),oe=new i.KeepAliveSender(B.multiplexerDemultiplexer.connectionOutbound,X.keepAlive),le=new i.KeepAliveHandler(B,X.lifetime),Re=P.lease?new i.LeaseHandler((ee=P.lease.maxPendingRequests)!==null&&ee!==void 0?ee:256,B.multiplexerDemultiplexer):void 0,ge=(W=P.responder)!==null&&W!==void 0?W:{},Te=new i.DefaultConnectionFrameHandler(B,le,oe,Re,ge),Me=new i.DefaultStreamRequestHandler(ge,0),B.onClose(function(ne){oe.close(),le.close(),Te.close(ne)}),B.multiplexerDemultiplexer.connectionInbound(Te),B.multiplexerDemultiplexer.handleRequestStream(Me),B.multiplexerDemultiplexer.connectionOutbound.send(X),le.start(),oe.start(),[2,new i.RSocketRequester(B,(Q=(te=P.fragmentation)===null||te===void 0?void 0:te.maxOutboundFragmentSize)!==null&&Q!==void 0?Q:0,Re)]}})})},y}();return Oe.RSocketConnector=u,Oe}var De={},at;function yr(){if(at)return De;at=1;var r=_&&_.__awaiter||function(h,E,T,m){function c(o){return o instanceof T?o:new T(function(v){v(o)})}return new(T||(T=Promise))(function(o,v){function S(N){try{R(m.next(N))}catch(M){v(M)}}function p(N){try{R(m.throw(N))}catch(M){v(M)}}function R(N){N.done?o(N.value):c(N.value).then(S,p)}R((m=m.apply(h,E||[])).next())})},e=_&&_.__generator||function(h,E){var T={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},m,c,o,v;return v={next:S(0),throw:S(1),return:S(2)},typeof Symbol=="function"&&(v[Symbol.iterator]=function(){return this}),v;function S(R){return function(N){return p([R,N])}}function p(R){if(m)throw new TypeError("Generator is already executing.");for(;T;)try{if(m=1,c&&(o=R[0]&2?c.return:R[0]?c.throw||((o=c.return)&&o.call(c),0):c.next)&&!(o=o.call(c,R[1])).done)return o;switch(c=0,o&&(R=[R[0]&2,o.value]),R[0]){case 0:case 1:o=R;break;case 4:return T.label++,{value:R[1],done:!1};case 5:T.label++,c=R[1],R=[0];continue;case 7:R=T.ops.pop(),T.trys.pop();continue;default:if(o=T.trys,!(o=o.length>0&&o[o.length-1])&&(R[0]===6||R[0]===2)){T=0;continue}if(R[0]===3&&(!o||R[1]>o[0]&&R[1]<o[3])){T.label=R[1];break}if(R[0]===6&&T.label<o[1]){T.label=o[1],o=R;break}if(o&&T.label<o[2]){T.label=o[2],T.ops.push(R);break}o[2]&&T.ops.pop(),T.trys.pop();continue}R=E.call(h,T)}catch(N){R=[6,N],c=0}finally{m=o=0}if(R[0]&5)throw R[1];return{value:R[0]?R[1]:void 0,done:!0}}};Object.defineProperty(De,"__esModule",{value:!0}),De.RSocketServer=void 0;var t=ut(),n=re,i=H,s=x,u=yt(),y=function(){function h(E){var T,m;this.acceptor=E.acceptor,this.transport=E.transport,this.lease=E.lease,this.serverSideKeepAlive=E.serverSideKeepAlive,this.sessionStore=E.resume?{}:void 0,this.sessionTimeout=(m=(T=E.resume)===null||T===void 0?void 0:T.sessionTimeout)!==null&&m!==void 0?m:void 0}return h.prototype.bind=function(){return r(this,void 0,void 0,function(){var E=this;return e(this,function(T){switch(T.label){case 0:return[4,this.transport.bind(function(m,c){return r(E,void 0,void 0,function(){var o,v,v,S,p,R,N,M,A,w,q,$,ee,W,te;return e(this,function(Q){switch(Q.label){case 0:switch(o=m.type,o){case i.FrameTypes.SETUP:return[3,1];case i.FrameTypes.RESUME:return[3,5]}return[3,6];case 1:return Q.trys.push([1,3,,4]),this.lease&&!i.Flags.hasLease(m.flags)?(v=new n.RSocketError(n.ErrorCodes.REJECTED_SETUP,"Lease has to be enabled"),c.multiplexerDemultiplexer.connectionOutbound.send({type:i.FrameTypes.ERROR,streamId:0,flags:i.Flags.NONE,code:v.code,message:v.message}),c.close(v),[2]):i.Flags.hasLease(m.flags)&&!this.lease?(v=new n.RSocketError(n.ErrorCodes.REJECTED_SETUP,"Lease has to be disabled"),c.multiplexerDemultiplexer.connectionOutbound.send({type:i.FrameTypes.ERROR,streamId:0,flags:i.Flags.NONE,code:v.code,message:v.message}),c.close(v),[2]):(S=i.Flags.hasLease(m.flags)?new s.LeaseHandler(($=this.lease.maxPendingRequests)!==null&&$!==void 0?$:256,c.multiplexerDemultiplexer):void 0,p=new s.RSocketRequester(c,(W=(ee=this.fragmentation)===null||ee===void 0?void 0:ee.maxOutboundFragmentSize)!==null&&W!==void 0?W:0,S),[4,this.acceptor.accept({data:m.data,dataMimeType:m.dataMimeType,metadata:m.metadata,metadataMimeType:m.metadataMimeType,flags:m.flags,keepAliveMaxLifetime:m.lifetime,keepAliveInterval:m.keepAlive,resumeToken:m.resumeToken},p)]);case 2:return R=Q.sent(),N=new s.KeepAliveHandler(c,m.lifetime),M=this.serverSideKeepAlive?new s.KeepAliveSender(c.multiplexerDemultiplexer.connectionOutbound,m.keepAlive):void 0,A=new s.DefaultConnectionFrameHandler(c,N,M,S,R),w=new s.DefaultStreamRequestHandler(R,0),c.onClose(function(P){M?.close(),N.close(),A.close(P)}),c.multiplexerDemultiplexer.connectionInbound(A),c.multiplexerDemultiplexer.handleRequestStream(w),N.start(),M?.start(),[3,4];case 3:return q=Q.sent(),c.multiplexerDemultiplexer.connectionOutbound.send({type:i.FrameTypes.ERROR,streamId:0,code:n.ErrorCodes.REJECTED_SETUP,message:(te=q.message)!==null&&te!==void 0?te:"",flags:i.Flags.NONE}),c.close(q instanceof n.RSocketError?q:new n.RSocketError(n.ErrorCodes.REJECTED_SETUP,q.message)),[3,4];case 4:return[2];case 5:return[2];case 6:c.multiplexerDemultiplexer.connectionOutbound.send({type:i.FrameTypes.ERROR,streamId:0,code:n.ErrorCodes.UNSUPPORTED_SETUP,message:"Unsupported setup",flags:i.Flags.NONE}),c.close(new n.RSocketError(n.ErrorCodes.UNSUPPORTED_SETUP)),Q.label=7;case 7:return[2]}})})},function(m,c){if(m.type===i.FrameTypes.RESUME){if(E.sessionStore){var o=E.sessionStore[m.resumeToken.toString()];if(!o){c.send({type:i.FrameTypes.ERROR,streamId:0,code:n.ErrorCodes.REJECTED_RESUME,message:"No session found for the given resume token",flags:i.Flags.NONE}),c.close();return}return o.resume(m,c,c),o}c.send({type:i.FrameTypes.ERROR,streamId:0,code:n.ErrorCodes.REJECTED_RESUME,message:"Resume is not enabled",flags:i.Flags.NONE}),c.close();return}else if(m.type===i.FrameTypes.SETUP&&i.Flags.hasResume(m.flags)){if(!E.sessionStore){var v=new n.RSocketError(n.ErrorCodes.REJECTED_SETUP,"No resume support");c.send({type:i.FrameTypes.ERROR,streamId:0,flags:i.Flags.NONE,code:v.code,message:v.message}),c.close(v);return}var S=new t.ResumableClientServerInputMultiplexerDemultiplexer(t.StreamIdGenerator.create(0),c,c,new u.FrameStore,m.resumeToken.toString(),E.sessionStore,E.sessionTimeout);return E.sessionStore[m.resumeToken.toString()]=S,S}return new t.ClientServerInputMultiplexerDemultiplexer(t.StreamIdGenerator.create(0),c,c)})];case 1:return[2,T.sent()]}})})},h}();return De.RSocketServer=y,De}var vt={};Object.defineProperty(vt,"__esModule",{value:!0});var st;function Le(){return st||(st=1,function(r){var e=_&&_.__createBinding||(Object.create?function(n,i,s,u){u===void 0&&(u=s),Object.defineProperty(n,u,{enumerable:!0,get:function(){return i[s]}})}:function(n,i,s,u){u===void 0&&(u=s),n[u]=i[s]}),t=_&&_.__exportStar||function(n,i){for(var s in n)s!=="default"&&!Object.prototype.hasOwnProperty.call(i,s)&&e(i,n,s)};Object.defineProperty(r,"__esModule",{value:!0}),t(Ge,r),t(ot,r),t(Ce,r),t(re,r),t(H,r),t(lt,r),t(pr(),r),t(yr(),r),t(vt,r)}(Xe)),Xe}var Or=Le(),vr={},Be={},He={},Rr=_&&_.__extends||function(){var r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,i){n.__proto__=i}||function(n,i){for(var s in i)Object.prototype.hasOwnProperty.call(i,s)&&(n[s]=i[s])},r(e,t)};return function(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");r(e,t);function n(){this.constructor=e}e.prototype=t===null?Object.create(t):(n.prototype=t.prototype,new n)}}();Object.defineProperty(He,"__esModule",{value:!0});He.WebsocketDuplexConnection=void 0;var it=Le(),gr=function(r){Rr(e,r);function e(t,n,i){var s=r.call(this)||this;return s.websocket=t,s.deserializer=n,s.handleClosed=function(u){s.close(new Error(u.reason||"WebsocketDuplexConnection: Socket closed unexpectedly."))},s.handleError=function(u){s.close(u.error)},s.handleMessage=function(u){try{var y=Buffer.from(u.data),h=s.deserializer.deserializeFrame(y);s.multiplexerDemultiplexer.handle(h)}catch(E){s.close(E)}},t.addEventListener("close",s.handleClosed),t.addEventListener("error",s.handleError),t.addEventListener("message",s.handleMessage),s.multiplexerDemultiplexer=i(s),s}return Object.defineProperty(e.prototype,"availability",{get:function(){return this.done?0:1},enumerable:!1,configurable:!0}),e.prototype.close=function(t){if(this.done){r.prototype.close.call(this,t);return}this.websocket.removeEventListener("close",this.handleClosed),this.websocket.removeEventListener("error",this.handleError),this.websocket.removeEventListener("message",this.handleMessage),this.websocket.close(),delete this.websocket,r.prototype.close.call(this,t)},e.prototype.send=function(t){if(!this.done){var n=(0,it.serializeFrame)(t);this.websocket.send(n)}},e}(it.Deferred);He.WebsocketDuplexConnection=gr;Object.defineProperty(Be,"__esModule",{value:!0});Be.WebsocketClientTransport=void 0;var Tr=Le(),Fr=He,Sr=function(){function r(e){var t;this.url=e.url,this.factory=(t=e.wsCreator)!==null&&t!==void 0?t:function(n){return new WebSocket(n)}}return r.prototype.connect=function(e){var t=this;return new Promise(function(n,i){var s=t.factory(t.url);s.binaryType="arraybuffer";var u=function(){s.removeEventListener("open",u),s.removeEventListener("error",y),n(new Fr.WebsocketDuplexConnection(s,new Tr.Deserializer,e))},y=function(h){s.removeEventListener("open",u),s.removeEventListener("error",y),i(h.error)};s.addEventListener("open",u),s.addEventListener("error",y)})},r}();Be.WebsocketClientTransport=Sr;(function(r){var e=_&&_.__createBinding||(Object.create?function(n,i,s,u){u===void 0&&(u=s),Object.defineProperty(n,u,{enumerable:!0,get:function(){return i[s]}})}:function(n,i,s,u){u===void 0&&(u=s),n[u]=i[s]}),t=_&&_.__exportStar||function(n,i){for(var s in n)s!=="default"&&!Object.prototype.hasOwnProperty.call(i,s)&&e(i,n,s)};Object.defineProperty(r,"__esModule",{value:!0}),t(Be,r)})(vr);export{Ar as a,vr as b,_ as c,Or as d,_r as g};
