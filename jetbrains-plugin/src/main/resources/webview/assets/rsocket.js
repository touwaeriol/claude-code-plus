var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function r(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var r=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach(function(t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}),r}var n,a,s,o,i,l,u={},c={},d={};n=d,Object.defineProperty(n,"__esModule",{value:!0}),n.Frame=n.Lengths=n.Flags=n.FrameTypes=void 0,(s=a=n.FrameTypes||(n.FrameTypes={}))[s.RESERVED=0]="RESERVED",s[s.SETUP=1]="SETUP",s[s.LEASE=2]="LEASE",s[s.KEEPALIVE=3]="KEEPALIVE",s[s.REQUEST_RESPONSE=4]="REQUEST_RESPONSE",s[s.REQUEST_FNF=5]="REQUEST_FNF",s[s.REQUEST_STREAM=6]="REQUEST_STREAM",s[s.REQUEST_CHANNEL=7]="REQUEST_CHANNEL",s[s.REQUEST_N=8]="REQUEST_N",s[s.CANCEL=9]="CANCEL",s[s.PAYLOAD=10]="PAYLOAD",s[s.ERROR=11]="ERROR",s[s.METADATA_PUSH=12]="METADATA_PUSH",s[s.RESUME=13]="RESUME",s[s.RESUME_OK=14]="RESUME_OK",s[s.EXT=63]="EXT",(o=n.Flags||(n.Flags={}))[o.NONE=0]="NONE",o[o.COMPLETE=64]="COMPLETE",o[o.FOLLOWS=128]="FOLLOWS",o[o.IGNORE=512]="IGNORE",o[o.LEASE=64]="LEASE",o[o.METADATA=256]="METADATA",o[o.NEXT=32]="NEXT",o[o.RESPOND=128]="RESPOND",o[o.RESUME_ENABLE=128]="RESUME_ENABLE",function(e){e.hasMetadata=function(t){return(t&e.METADATA)===e.METADATA},e.hasComplete=function(t){return(t&e.COMPLETE)===e.COMPLETE},e.hasNext=function(t){return(t&e.NEXT)===e.NEXT},e.hasFollows=function(t){return(t&e.FOLLOWS)===e.FOLLOWS},e.hasIgnore=function(t){return(t&e.IGNORE)===e.IGNORE},e.hasRespond=function(t){return(t&e.RESPOND)===e.RESPOND},e.hasLease=function(t){return(t&e.LEASE)===e.LEASE},e.hasResume=function(t){return(t&e.RESUME_ENABLE)===e.RESUME_ENABLE}}(n.Flags||(n.Flags={})),(i=n.Lengths||(n.Lengths={}))[i.FRAME=3]="FRAME",i[i.HEADER=6]="HEADER",i[i.METADATA=3]="METADATA",i[i.REQUEST=3]="REQUEST",(l=n.Frame||(n.Frame={})).isConnection=function(e){return 0===e.streamId},l.isRequest=function(e){return a.REQUEST_RESPONSE<=e.type&&e.type<=a.REQUEST_CHANNEL},function(t){var r=e&&e.__generator||function(e,t){var r,n,a,s,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(s){return function(i){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(a=2&s[0]?n.return:s[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,s[1])).done)return a;switch(n=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){o.label=s[1];break}if(6===s[0]&&o.label<a[1]){o.label=a[1],a=s;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(s);break}a[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(i){s=[6,i],n=0}finally{r=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,i])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.Deserializer=t.sizeOfFrame=t.serializeFrame=t.deserializeFrame=t.serializeFrameWithLength=t.deserializeFrames=t.deserializeFrameWithLength=t.writeUInt64BE=t.readUInt64BE=t.writeUInt24BE=t.readUInt24BE=t.MAX_VERSION=t.MAX_TTL=t.MAX_STREAM_ID=t.MAX_RESUME_LENGTH=t.MAX_REQUEST_N=t.MAX_REQUEST_COUNT=t.MAX_MIME_LENGTH=t.MAX_METADATA_LENGTH=t.MAX_LIFETIME=t.MAX_KEEPALIVE=t.MAX_CODE=t.FRAME_TYPE_OFFFSET=t.FLAGS_MASK=void 0;var n=d;t.FLAGS_MASK=1023,t.FRAME_TYPE_OFFFSET=10,t.MAX_CODE=2147483647,t.MAX_KEEPALIVE=2147483647,t.MAX_LIFETIME=2147483647,t.MAX_METADATA_LENGTH=16777215,t.MAX_MIME_LENGTH=255,t.MAX_REQUEST_COUNT=2147483647,t.MAX_REQUEST_N=2147483647,t.MAX_RESUME_LENGTH=65535,t.MAX_STREAM_ID=2147483647,t.MAX_TTL=2147483647,t.MAX_VERSION=65535;var a=4294967296;function s(e,t){return e.readUInt8(t)<<16|e.readUInt8(t+1)<<8|e.readUInt8(t+2)}function o(e,t,r){return r=e.writeUInt8(t>>>16,r),r=e.writeUInt8(t>>>8&255,r),e.writeUInt8(255&t,r)}function i(e,t){var r=e.readUInt32BE(t),n=e.readUInt32BE(t+4);return r*a+n}function l(e,t,r){var n=t/a|0,s=t%a;return r=e.writeUInt32BE(n,r),e.writeUInt32BE(s,r)}t.readUInt24BE=s,t.writeUInt24BE=o,t.readUInt64BE=i,t.writeUInt64BE=l;function u(e){var t=s(e,0);return h(e.slice(3,3+t))}function c(e){var t,n,a,o,i;return r(this,function(r){switch(r.label){case 0:t=0,r.label=1;case 1:return t+3<e.length?(n=s(e,t),(o=(a=t+3)+n)>e.length?[3,3]:(i=e.slice(a,o),[4,[h(i),t=o]])):[3,3];case 2:return r.sent(),[3,1];case 3:return[2]}})}function h(e){var r=0,a=e.readInt32BE(r);r+=4;var s=e.readUInt16BE(r);r+=2;var o=s>>>t.FRAME_TYPE_OFFFSET,l=s&t.FLAGS_MASK;switch(o){case n.FrameTypes.SETUP:return function(e,t,r){e.length;var a=6,s=e.readUInt16BE(a);a+=2;var o=e.readUInt16BE(a);a+=2;var i=e.readInt32BE(a);a+=4;var l=e.readInt32BE(a);a+=4;var u=null;if(r&n.Flags.RESUME_ENABLE){var c=e.readInt16BE(a);a+=2,u=e.slice(a,a+c),a+=c}var d=e.readUInt8(a);a+=1;var h=e.toString("ascii",a,a+d);a+=d;var m=e.readUInt8(a);a+=1;var p=e.toString("ascii",a,a+m);a+=m;var f={data:null,dataMimeType:p,flags:r,keepAlive:i,lifetime:l,majorVersion:s,metadata:null,metadataMimeType:h,minorVersion:o,resumeToken:u,streamId:0,type:n.FrameTypes.SETUP};return O(e,f,a),f}(e,0,l);case n.FrameTypes.PAYLOAD:return function(e,t,r){e.length;var a={data:null,flags:r,metadata:null,streamId:t,type:n.FrameTypes.PAYLOAD};return O(e,a,6),a}(e,a,l);case n.FrameTypes.ERROR:return function(e,t,r){e.length;var a=6,s=e.readInt32BE(a);a+=4;var o=e.length-a,i="";o>0&&(i=e.toString("utf8",a,a+o),a+=o);return{code:s,flags:r,message:i,streamId:t,type:n.FrameTypes.ERROR}}(e,a,l);case n.FrameTypes.KEEPALIVE:return function(e,t,r){e.length;var a=6,s=i(e,a);a+=8;var o=null;a<e.length&&(o=e.slice(a,e.length));return{data:o,flags:r,lastReceivedPosition:s,streamId:0,type:n.FrameTypes.KEEPALIVE}}(e,0,l);case n.FrameTypes.REQUEST_FNF:return function(e,t,r){e.length;var a={data:null,flags:r,metadata:null,streamId:t,type:n.FrameTypes.REQUEST_FNF};return O(e,a,6),a}(e,a,l);case n.FrameTypes.REQUEST_RESPONSE:return function(e,t,r){var a={data:null,flags:r,metadata:null,streamId:t,type:n.FrameTypes.REQUEST_RESPONSE};return O(e,a,6),a}(e,a,l);case n.FrameTypes.REQUEST_STREAM:return function(e,t,r){e.length;var a=6,s=e.readInt32BE(a);a+=4;var o={data:null,flags:r,metadata:null,requestN:s,streamId:t,type:n.FrameTypes.REQUEST_STREAM};return O(e,o,a),o}(e,a,l);case n.FrameTypes.REQUEST_CHANNEL:return function(e,t,r){e.length;var a=6,s=e.readInt32BE(a);a+=4;var o={data:null,flags:r,metadata:null,requestN:s,streamId:t,type:n.FrameTypes.REQUEST_CHANNEL};return O(e,o,a),o}(e,a,l);case n.FrameTypes.METADATA_PUSH:return function(e,t,r){return{flags:r,metadata:6===length?null:e.slice(6,length),streamId:0,type:n.FrameTypes.METADATA_PUSH}}(e,0,l);case n.FrameTypes.REQUEST_N:return function(e,t,r){e.length;var a=e.readInt32BE(6);return{flags:r,requestN:a,streamId:t,type:n.FrameTypes.REQUEST_N}}(e,a,l);case n.FrameTypes.RESUME:return function(e,t,r){e.length;var a=6,s=e.readUInt16BE(a);a+=2;var o=e.readUInt16BE(a);a+=2;var l=e.readInt16BE(a);a+=2;var u=e.slice(a,a+l);a+=l;var c=i(e,a);a+=8;var d=i(e,a);return a+=8,{clientPosition:d,flags:r,majorVersion:s,minorVersion:o,resumeToken:u,serverPosition:c,streamId:0,type:n.FrameTypes.RESUME}}(e,0,l);case n.FrameTypes.RESUME_OK:return function(e,t,r){e.length;var a=i(e,6);return{clientPosition:a,flags:r,streamId:0,type:n.FrameTypes.RESUME_OK}}(e,0,l);case n.FrameTypes.CANCEL:return function(e,t,r){return e.length,{flags:r,streamId:t,type:n.FrameTypes.CANCEL}}(e,a,l);case n.FrameTypes.LEASE:return function(e,t,r){var a=6,s=e.readUInt32BE(a);a+=4;var o=e.readUInt32BE(a);a+=4;var i=null;a<e.length&&(i=e.slice(a,e.length));return{flags:r,metadata:i,requestCount:o,streamId:0,ttl:s,type:n.FrameTypes.LEASE}}(e,0,l)}}function m(e){switch(e.type){case n.FrameTypes.SETUP:return function(e){var t=null!=e.resumeToken?e.resumeToken.byteLength:0,r=null!=e.metadataMimeType?Buffer.byteLength(e.metadataMimeType,"ascii"):0,a=null!=e.dataMimeType?Buffer.byteLength(e.dataMimeType,"ascii"):0,s=S(e),o=Buffer.allocUnsafe(6+p+(t?f+t:0)+r+a+s),i=b(e,o);i=o.writeUInt16BE(e.majorVersion,i),i=o.writeUInt16BE(e.minorVersion,i),i=o.writeUInt32BE(e.keepAlive,i),i=o.writeUInt32BE(e.lifetime,i),e.flags&n.Flags.RESUME_ENABLE&&(i=o.writeUInt16BE(t,i),null!=e.resumeToken&&(i+=e.resumeToken.copy(o,i)));i=o.writeUInt8(r,i),null!=e.metadataMimeType&&(i+=o.write(e.metadataMimeType,i,i+r,"ascii"));i=o.writeUInt8(a,i),null!=e.dataMimeType&&(i+=o.write(e.dataMimeType,i,i+a,"ascii"));return A(e,o,i),o}(e);case n.FrameTypes.PAYLOAD:return function(e){var t=S(e),r=Buffer.allocUnsafe(6+t),n=b(e,r);return A(e,r,n),r}(e);case n.FrameTypes.ERROR:return function(e){var t=null!=e.message?Buffer.byteLength(e.message,"utf8"):0,r=Buffer.allocUnsafe(6+E+t),n=b(e,r);n=r.writeUInt32BE(e.code,n),null!=e.message&&r.write(e.message,n,n+t,"utf8");return r}(e);case n.FrameTypes.KEEPALIVE:return function(e){var t=null!=e.data?e.data.byteLength:0,r=Buffer.allocUnsafe(6+y+t),n=b(e,r);n=l(r,e.lastReceivedPosition,n),null!=e.data&&e.data.copy(r,n);return r}(e);case n.FrameTypes.REQUEST_FNF:case n.FrameTypes.REQUEST_RESPONSE:return function(e){var t=S(e),r=Buffer.allocUnsafe(6+t),n=b(e,r);return A(e,r,n),r}(e);case n.FrameTypes.REQUEST_STREAM:case n.FrameTypes.REQUEST_CHANNEL:return function(e){var t=S(e),r=Buffer.allocUnsafe(6+g+t),n=b(e,r);return n=r.writeUInt32BE(e.requestN,n),A(e,r,n),r}(e);case n.FrameTypes.METADATA_PUSH:return function(e){var t=e.metadata;if(null!=t){var r=b(e,n=Buffer.allocUnsafe(6+t.byteLength));return t.copy(n,r),n}var n;return b(e,n=Buffer.allocUnsafe(6)),n}(e);case n.FrameTypes.REQUEST_N:return function(e){var t=Buffer.allocUnsafe(6+T),r=b(e,t);return t.writeUInt32BE(e.requestN,r),t}(e);case n.FrameTypes.RESUME:return function(e){var t=e.resumeToken.byteLength,r=Buffer.allocUnsafe(6+R+t),n=b(e,r);return n=r.writeUInt16BE(e.majorVersion,n),n=r.writeUInt16BE(e.minorVersion,n),n=r.writeUInt16BE(t,n),n+=e.resumeToken.copy(r,n),n=l(r,e.serverPosition,n),l(r,e.clientPosition,n),r}(e);case n.FrameTypes.RESUME_OK:return function(e){var t=Buffer.allocUnsafe(6+F),r=b(e,t);return l(t,e.clientPosition,r),t}(e);case n.FrameTypes.CANCEL:return function(e){var t=Buffer.allocUnsafe(6);return b(e,t),t}(e);case n.FrameTypes.LEASE:return function(e){var t=null!=e.metadata?e.metadata.byteLength:0,r=Buffer.allocUnsafe(6+v+t),n=b(e,r);n=r.writeUInt32BE(e.ttl,n),n=r.writeUInt32BE(e.requestCount,n),null!=e.metadata&&e.metadata.copy(r,n);return r}(e)}}t.deserializeFrameWithLength=u,t.deserializeFrames=c,t.serializeFrameWithLength=function(e){var t=m(e),r=Buffer.allocUnsafe(t.length+3);return o(r,t.length,0),t.copy(r,3),r},t.deserializeFrame=h,t.serializeFrame=m,t.sizeOfFrame=function(e){switch(e.type){case n.FrameTypes.SETUP:return function(e){var t=null!=e.resumeToken?e.resumeToken.byteLength:0,r=null!=e.metadataMimeType?Buffer.byteLength(e.metadataMimeType,"ascii"):0,n=null!=e.dataMimeType?Buffer.byteLength(e.dataMimeType,"ascii"):0,a=S(e);return 6+p+(t?f+t:0)+r+n+a}(e);case n.FrameTypes.PAYLOAD:return function(e){var t=S(e);return 6+t}(e);case n.FrameTypes.ERROR:return function(e){var t=null!=e.message?Buffer.byteLength(e.message,"utf8"):0;return 6+E+t}(e);case n.FrameTypes.KEEPALIVE:return function(e){var t=null!=e.data?e.data.byteLength:0;return 6+y+t}(e);case n.FrameTypes.REQUEST_FNF:case n.FrameTypes.REQUEST_RESPONSE:return function(e){var t=S(e);return 6+t}(e);case n.FrameTypes.REQUEST_STREAM:case n.FrameTypes.REQUEST_CHANNEL:return function(e){var t=S(e);return 6+g+t}(e);case n.FrameTypes.METADATA_PUSH:return function(e){return 6+(null!=e.metadata?e.metadata.byteLength:0)}(e);case n.FrameTypes.REQUEST_N:return 6+T;case n.FrameTypes.RESUME:return function(e){var t=e.resumeToken.byteLength;return 6+R+t}(e);case n.FrameTypes.RESUME_OK:return 6+F;case n.FrameTypes.CANCEL:return 6;case n.FrameTypes.LEASE:return function(e){var t=null!=e.metadata?e.metadata.byteLength:0;return 6+v+t}(e)}};var p=14,f=2;var E=4;var y=8;var v=8;var g=4;var T=4;var R=22;var F=8;function b(e,r){var n=r.writeInt32BE(e.streamId,0);return r.writeUInt16BE(e.type<<t.FRAME_TYPE_OFFFSET|e.flags&t.FLAGS_MASK,n)}function S(e){var t=0;return null!=e.data&&(t+=e.data.byteLength),n.Flags.hasMetadata(e.flags)&&(t+=3,null!=e.metadata&&(t+=e.metadata.byteLength)),t}function A(e,t,r){n.Flags.hasMetadata(e.flags)&&(null!=e.metadata?(r=o(t,e.metadata.byteLength,r),r+=e.metadata.copy(t,r)):r=o(t,0,r));null!=e.data&&e.data.copy(t,r)}function O(e,t,r){if(n.Flags.hasMetadata(t.flags)){var a=s(e,r);r+=3,a>0&&(t.metadata=e.slice(r,r+a),r+=a)}r<e.length&&(t.data=e.slice(r,e.length))}var N=function(){function e(){}return e.prototype.deserializeFrame=function(e){return h(e)},e.prototype.deserializeFrameWithLength=function(e){return u(e)},e.prototype.deserializeFrames=function(e){return c(e)},e}();t.Deserializer=N}(c);var h={};Object.defineProperty(h,"__esModule",{value:!0});var m={},p=e&&e.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(m,"__esModule",{value:!0}),m.Deferred=void 0;var f=function(){function e(){this._done=!1,this.onCloseCallbacks=[]}return Object.defineProperty(e.prototype,"done",{get:function(){return this._done},enumerable:!1,configurable:!0}),e.prototype.close=function(e){var t,r,n,a;if(this.done)console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));else if(this._done=!0,this._error=e,e)try{for(var s=p(this.onCloseCallbacks),o=s.next();!o.done;o=s.next()){(0,o.value)(e)}}catch(u){t={error:u}}finally{try{o&&!o.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}else try{for(var i=p(this.onCloseCallbacks),l=i.next();!l.done;l=i.next()){(0,l.value)()}}catch(c){n={error:c}}finally{try{l&&!l.done&&(a=i.return)&&a.call(i)}finally{if(n)throw n.error}}},e.prototype.onClose=function(e){this._done?e(this._error):this.onCloseCallbacks.push(e)},e}();m.Deferred=f;var E={};!function(t){var r=e&&e.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(t,"__esModule",{value:!0}),t.ErrorCodes=t.RSocketError=void 0;var n,a=function(e){function t(t,r){var n=e.call(this,r)||this;return n.code=t,n}return r(t,e),t}(Error);t.RSocketError=a,(n=t.ErrorCodes||(t.ErrorCodes={}))[n.RESERVED=0]="RESERVED",n[n.INVALID_SETUP=1]="INVALID_SETUP",n[n.UNSUPPORTED_SETUP=2]="UNSUPPORTED_SETUP",n[n.REJECTED_SETUP=3]="REJECTED_SETUP",n[n.REJECTED_RESUME=4]="REJECTED_RESUME",n[n.CONNECTION_CLOSE=258]="CONNECTION_CLOSE",n[n.CONNECTION_ERROR=257]="CONNECTION_ERROR",n[n.APPLICATION_ERROR=513]="APPLICATION_ERROR",n[n.REJECTED=514]="REJECTED",n[n.CANCELED=515]="CANCELED",n[n.INVALID=516]="INVALID",n[n.RESERVED_EXTENSION=4294967295]="RESERVED_EXTENSION"}(E);var y={};Object.defineProperty(y,"__esModule",{value:!0});var v,g={},T={};function R(){return v||(v=1,function(t){var r=e&&e.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),n=e&&e.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(a,s){function o(e){try{l(n.next(e))}catch(t){s(t)}}function i(e){try{l(n.throw(e))}catch(t){s(t)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,i)}l((n=n.apply(e,t||[])).next())})},a=e&&e.__generator||function(e,t){var r,n,a,s,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(s){return function(i){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(a=2&s[0]?n.return:s[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,s[1])).done)return a;switch(n=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){o.label=s[1];break}if(6===s[0]&&o.label<a[1]){o.label=a[1],a=s;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(s);break}a[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(i){s=[6,i],n=0}finally{r=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,i])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer=t.ResumableClientServerInputMultiplexerDemultiplexer=t.ClientServerInputMultiplexerDemultiplexer=t.StreamIdGenerator=void 0;var s=ze(),o=m,i=E,l=d;!function(e){e.create=function(e){return new t(e)};var t=function(){function e(e){this.currentId=e}return e.prototype.next=function(e){var t=this.currentId+2;e(t)&&(this.currentId=t)},e}()}(t.StreamIdGenerator||(t.StreamIdGenerator={}));var u=function(e){function t(t,r,n){var a=e.call(this)||this;return a.streamIdSupplier=t,a.outbound=r,a.closeable=n,a.registry={},n.onClose(a.close.bind(a)),a}return r(t,e),t.prototype.handle=function(e){if(l.Frame.isConnection(e)){if(e.type===s.FrameTypes.RESERVED)return;this.connectionFramesHandler.handle(e)}else if(l.Frame.isRequest(e)){if(this.registry[e.streamId])return;this.requestFramesHandler.handle(e,this)}else{var t=this.registry[e.streamId];if(!t)return;t.handle(e)}},t.prototype.connectionInbound=function(e){if(this.connectionFramesHandler)throw new Error("Connection frame handler has already been installed");this.connectionFramesHandler=e},t.prototype.handleRequestStream=function(e){if(this.requestFramesHandler)throw new Error("Stream handler has already been installed");this.requestFramesHandler=e},t.prototype.send=function(e){this.outbound.send(e)},Object.defineProperty(t.prototype,"connectionOutbound",{get:function(){return this},enumerable:!1,configurable:!0}),t.prototype.createRequestStream=function(e){var t=this;if(this.done)e.handleReject(new Error("Already closed"));else{var r=this.registry;this.streamIdSupplier.next(function(r){return e.handleReady(r,t)},Object.keys(r))}},t.prototype.connect=function(e){this.registry[e.streamId]=e},t.prototype.disconnect=function(e){delete this.registry[e.streamId]},t.prototype.close=function(t){if(this.done)e.prototype.close.call(this,t);else{for(var r in this.registry){this.registry[r].close(new Error("Closed. ".concat(t?"Original cause [".concat(t,"]."):"")))}e.prototype.close.call(this,t)}},t}(o.Deferred);t.ClientServerInputMultiplexerDemultiplexer=u;var c=function(e){function t(t,r,n,a,s,i,l){var u=e.call(this,t,r,new o.Deferred)||this;return u.frameStore=a,u.token=s,u.sessionTimeout=l,i instanceof Function?u.reconnector=i:u.sessionStore=i,n.onClose(u.handleConnectionClose.bind(u)),u}return r(t,e),t.prototype.send=function(t){if(l.Frame.isConnection(t)){if(t.type===s.FrameTypes.KEEPALIVE)t.lastReceivedPosition=this.frameStore.lastReceivedFramePosition;else if(t.type===s.FrameTypes.ERROR)return this.outbound.send(t),this.sessionStore&&delete this.sessionStore[this.token],void e.prototype.close.call(this,new i.RSocketError(t.code,t.message))}else this.frameStore.store(t);this.outbound.send(t)},t.prototype.handle=function(t){if(l.Frame.isConnection(t)){if(t.type===s.FrameTypes.KEEPALIVE)try{this.frameStore.dropTo(t.lastReceivedPosition)}catch(r){this.outbound.send({type:s.FrameTypes.ERROR,streamId:0,flags:s.Flags.NONE,code:r.code,message:r.message}),this.close(r)}else if(t.type===s.FrameTypes.ERROR)return e.prototype.handle.call(this,t),this.sessionStore&&delete this.sessionStore[this.token],void e.prototype.close.call(this,new i.RSocketError(t.code,t.message))}else this.frameStore.record(t);e.prototype.handle.call(this,t)},t.prototype.resume=function(e,t,r){switch(this.outbound=t,e.type){case s.FrameTypes.RESUME:if(clearTimeout(this.timeoutId),this.frameStore.lastReceivedFramePosition<e.clientPosition){var n=new i.RSocketError(s.ErrorCodes.REJECTED_RESUME,"Impossible to resume since first available client frame position is greater than last received server frame position");return this.outbound.send({type:s.FrameTypes.ERROR,streamId:0,flags:s.Flags.NONE,code:n.code,message:n.message}),void this.close(n)}try{this.frameStore.dropTo(e.serverPosition)}catch(a){return this.outbound.send({type:s.FrameTypes.ERROR,streamId:0,flags:s.Flags.NONE,code:a.code,message:a.message}),void this.close(a)}this.outbound.send({type:s.FrameTypes.RESUME_OK,streamId:0,flags:s.Flags.NONE,clientPosition:this.frameStore.lastReceivedFramePosition});break;case s.FrameTypes.RESUME_OK:try{this.frameStore.dropTo(e.clientPosition)}catch(a){this.outbound.send({type:s.FrameTypes.ERROR,streamId:0,flags:s.Flags.NONE,code:a.code,message:a.message}),this.close(a)}}this.frameStore.drain(this.outbound.send.bind(this.outbound)),r.onClose(this.handleConnectionClose.bind(this)),this.connectionFramesHandler.resume()},t.prototype.handleConnectionClose=function(e){return n(this,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:if(this.connectionFramesHandler.pause(),!this.reconnector)return[3,5];t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.reconnector(this,this.frameStore)];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),this.close(e),[3,4];case 4:return[3,6];case 5:this.timeoutId=setTimeout(this.close.bind(this),this.sessionTimeout),t.label=6;case 6:return[2]}})})},t}(u);t.ResumableClientServerInputMultiplexerDemultiplexer=c;var h=function(){function e(e,t,r){this.outbound=e,this.closeable=t,this.delegate=r,this.resumed=!1}return e.prototype.close=function(){this.delegate.close()},e.prototype.onClose=function(e){this.delegate.onClose(e)},Object.defineProperty(e.prototype,"connectionOutbound",{get:function(){return this.delegate.connectionOutbound},enumerable:!1,configurable:!0}),e.prototype.createRequestStream=function(e){this.delegate.createRequestStream(e)},e.prototype.connectionInbound=function(e){this.delegate.connectionInbound(e)},e.prototype.handleRequestStream=function(e){this.delegate.handleRequestStream(e)},e.prototype.handle=function(e){var t=this;if(!this.resumed)return e.type===s.FrameTypes.RESUME_OK?(this.resumed=!0,void this.delegate.resume(e,this.outbound,this.closeable)):(this.outbound.send({type:s.FrameTypes.ERROR,streamId:0,code:s.ErrorCodes.CONNECTION_ERROR,message:"Incomplete RESUME handshake. Unexpected frame ".concat(e.type," received"),flags:s.Flags.NONE}),this.closeable.close(),void this.closeable.onClose(function(){return t.delegate.close(new i.RSocketError(s.ErrorCodes.CONNECTION_ERROR,"Incomplete RESUME handshake. Unexpected frame ".concat(e.type," received")))}));this.delegate.handle(e)},e}();t.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer=h}(T)),T}var F={},b={},S={},A=e&&e.__generator||function(e,t){var r,n,a,s,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(s){return function(i){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(a=2&s[0]?n.return:s[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,s[1])).done)return a;switch(n=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){o.label=s[1];break}if(6===s[0]&&o.label<a[1]){o.label=a[1],a=s;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(s);break}a[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(i){s=[6,i],n=0}finally{r=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,i])}}};Object.defineProperty(S,"__esModule",{value:!0}),S.fragmentWithRequestN=S.fragment=S.isFragmentable=void 0;var O=d;S.isFragmentable=function(e,t,r){return 0!==t&&e.data.byteLength+(e.metadata?e.metadata.byteLength+O.Lengths.METADATA:0)+(r==O.FrameTypes.REQUEST_STREAM||r==O.FrameTypes.REQUEST_CHANNEL?O.Lengths.REQUEST:0)>t},S.fragment=function(e,t,r,n,a){var s,o,i,l,u,c,d,h,m,p,f,E;return void 0===a&&(a=!1),A(this,function(y){switch(y.label){case 0:return s=null!==(E=null===(f=t.data)||void 0===f?void 0:f.byteLength)&&void 0!==E?E:0,o=n!==O.FrameTypes.PAYLOAD,i=r,t.metadata?0!==(u=t.metadata.byteLength)?[3,1]:(i-=O.Lengths.METADATA,l=Buffer.allocUnsafe(0),[3,6]):[3,6];case 1:return c=0,o?(i-=O.Lengths.METADATA,d=Math.min(u,c+i),l=t.metadata.slice(c,d),i-=l.byteLength,c=d,0!==i?[3,3]:(o=!1,[4,{type:n,flags:O.Flags.FOLLOWS|O.Flags.METADATA,data:void 0,metadata:l,streamId:e}])):[3,3];case 2:y.sent(),l=void 0,i=r,y.label=3;case 3:return c<u?(i-=O.Lengths.METADATA,d=Math.min(u,c+i),l=t.metadata.slice(c,d),i-=l.byteLength,c=d,0!==i&&0!==s?[3,5]:[4,{type:O.FrameTypes.PAYLOAD,flags:O.Flags.NEXT|O.Flags.METADATA|(c===u&&a&&0===s?O.Flags.COMPLETE:O.Flags.FOLLOWS),data:void 0,metadata:l,streamId:e}]):[3,6];case 4:y.sent(),l=void 0,i=r,y.label=5;case 5:return[3,3];case 6:return h=0,o?(p=Math.min(s,h+i),m=t.data.slice(h,p),i-=m.byteLength,h=p,[4,{type:n,flags:O.Flags.FOLLOWS|(l?O.Flags.METADATA:O.Flags.NONE),data:m,metadata:l,streamId:e}]):[3,8];case 7:y.sent(),l=void 0,m=void 0,i=r,y.label=8;case 8:return h<s?(p=Math.min(s,h+i),m=t.data.slice(h,p),i-=m.byteLength,h=p,[4,{type:O.FrameTypes.PAYLOAD,flags:h===s?(a?O.Flags.COMPLETE:O.Flags.NONE)|O.Flags.NEXT|(l?O.Flags.METADATA:0):O.Flags.FOLLOWS|O.Flags.NEXT|(l?O.Flags.METADATA:0),data:m,metadata:l,streamId:e}]):[3,10];case 9:return y.sent(),l=void 0,m=void 0,i=r,[3,8];case 10:return[2]}})},S.fragmentWithRequestN=function(e,t,r,n,a,s){var o,i,l,u,c,d,h,m,p,f,E,y;return void 0===s&&(s=!1),A(this,function(v){switch(v.label){case 0:return o=null!==(y=null===(E=t.data)||void 0===E?void 0:E.byteLength)&&void 0!==y?y:0,i=!0,l=r,t.metadata?0!==(c=t.metadata.byteLength)?[3,1]:(l-=O.Lengths.METADATA,u=Buffer.allocUnsafe(0),[3,6]):[3,6];case 1:return d=0,i?(l-=O.Lengths.METADATA+O.Lengths.REQUEST,h=Math.min(c,d+l),u=t.metadata.slice(d,h),l-=u.byteLength,d=h,0!==l?[3,3]:(i=!1,[4,{type:n,flags:O.Flags.FOLLOWS|O.Flags.METADATA,data:void 0,requestN:a,metadata:u,streamId:e}])):[3,3];case 2:v.sent(),u=void 0,l=r,v.label=3;case 3:return d<c?(l-=O.Lengths.METADATA,h=Math.min(c,d+l),u=t.metadata.slice(d,h),l-=u.byteLength,d=h,0!==l&&0!==o?[3,5]:[4,{type:O.FrameTypes.PAYLOAD,flags:O.Flags.NEXT|O.Flags.METADATA|(d===c&&s&&0===o?O.Flags.COMPLETE:O.Flags.FOLLOWS),data:void 0,metadata:u,streamId:e}]):[3,6];case 4:v.sent(),u=void 0,l=r,v.label=5;case 5:return[3,3];case 6:return m=0,i?(l-=O.Lengths.REQUEST,f=Math.min(o,m+l),p=t.data.slice(m,f),l-=p.byteLength,m=f,[4,{type:n,flags:O.Flags.FOLLOWS|(u?O.Flags.METADATA:O.Flags.NONE),data:p,requestN:a,metadata:u,streamId:e}]):[3,8];case 7:v.sent(),u=void 0,p=void 0,l=r,v.label=8;case 8:return m<o?(f=Math.min(o,m+l),p=t.data.slice(m,f),l-=p.byteLength,m=f,[4,{type:O.FrameTypes.PAYLOAD,flags:m===o?(s?O.Flags.COMPLETE:O.Flags.NONE)|O.Flags.NEXT|(u?O.Flags.METADATA:0):O.Flags.FOLLOWS|O.Flags.NEXT|(u?O.Flags.METADATA:0),data:p,metadata:u,streamId:e}]):[3,10];case 9:return v.sent(),u=void 0,p=void 0,l=r,[3,8];case 10:return[2]}})};var N={};Object.defineProperty(N,"__esModule",{value:!0}),N.cancel=N.reassemble=N.add=void 0,N.add=function(e,t,r){return e.hasFragments?(e.data=e.data?Buffer.concat([e.data,t]):t,e.metadata&&r&&(e.metadata=Buffer.concat([e.metadata,r])),!0):(e.hasFragments=!0,e.data=t,r&&(e.metadata=r),!0)},N.reassemble=function(e,t,r){e.hasFragments=!1;var n=e.data?Buffer.concat([e.data,t]):t;if(e.data=void 0,e.metadata){var a=r?Buffer.concat([e.metadata,r]):e.metadata;return e.metadata=void 0,{data:n,metadata:a}}return{data:n}},N.cancel=function(e){e.hasFragments=!1,e.data=void 0,e.metadata=void 0};var _=e&&e.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),I=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),C=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&_(t,e,r);return I(t,e),t},D=e&&e.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(b,"__esModule",{value:!0}),b.RequestChannelResponderStream=b.RequestChannelRequesterStream=void 0;var L=E,M=S,P=d,w=C(N),x=function(){function e(e,t,r,n,a,s){this.payload=e,this.isComplete=t,this.receiver=r,this.fragmentSize=n,this.initialRequestN=a,this.leaseManager=s,this.streamType=P.FrameTypes.REQUEST_CHANNEL}return e.prototype.handleReady=function(e,t){var r,n;if(this.outboundDone)return!1;this.streamId=e,this.stream=t,t.connect(this);var a=this.isComplete;if(a&&(this.outboundDone=a),(0,M.isFragmentable)(this.payload,this.fragmentSize,P.FrameTypes.REQUEST_CHANNEL))try{for(var s=D((0,M.fragmentWithRequestN)(e,this.payload,this.fragmentSize,P.FrameTypes.REQUEST_CHANNEL,this.initialRequestN,a)),o=s.next();!o.done;o=s.next()){var i=o.value;this.stream.send(i)}}catch(l){r={error:l}}finally{try{o&&!o.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}else this.stream.send({type:P.FrameTypes.REQUEST_CHANNEL,data:this.payload.data,metadata:this.payload.metadata,requestN:this.initialRequestN,flags:(void 0!==this.payload.metadata?P.Flags.METADATA:P.Flags.NONE)|(a?P.Flags.COMPLETE:P.Flags.NONE),streamId:e});return this.hasExtension&&this.stream.send({type:P.FrameTypes.EXT,streamId:e,extendedContent:this.extendedContent,extendedType:this.extendedType,flags:this.flags}),!0},e.prototype.handleReject=function(e){this.inboundDone||(this.inboundDone=!0,this.outboundDone=!0,this.receiver.onError(e))},e.prototype.handle=function(e){var t,r=e.type;switch(r){case P.FrameTypes.PAYLOAD:var n=P.Flags.hasComplete(e.flags),a=P.Flags.hasNext(e.flags);if(n||!P.Flags.hasFollows(e.flags)){if(n&&(this.inboundDone=!0,this.outboundDone&&this.stream.disconnect(this),!a))return void this.receiver.onComplete();var s=this.hasFragments?w.reassemble(this,e.data,e.metadata):{data:e.data,metadata:e.metadata};return void this.receiver.onNext(s,n)}if(w.add(this,e.data,e.metadata))return;t="Unexpected frame size";break;case P.FrameTypes.CANCEL:if(this.outboundDone)return;return this.outboundDone=!0,this.inboundDone&&this.stream.disconnect(this),void this.receiver.cancel();case P.FrameTypes.REQUEST_N:if(this.outboundDone)return;if(this.hasFragments){t="Unexpected frame type [".concat(r,"] during reassembly");break}return void this.receiver.request(e.requestN);case P.FrameTypes.ERROR:var o=this.outboundDone;return this.inboundDone=!0,this.outboundDone=!0,this.stream.disconnect(this),w.cancel(this),o||this.receiver.cancel(),void this.receiver.onError(new L.RSocketError(e.code,e.message));case P.FrameTypes.EXT:return void this.receiver.onExtension(e.extendedType,e.extendedContent,P.Flags.hasIgnore(e.flags));default:t="Unexpected frame type [".concat(r,"]")}this.close(new L.RSocketError(L.ErrorCodes.CANCELED,t)),this.stream.send({type:P.FrameTypes.CANCEL,streamId:this.streamId,flags:P.Flags.NONE}),this.stream.disconnect(this)},e.prototype.request=function(e){this.inboundDone||(this.streamId?this.stream.send({type:P.FrameTypes.REQUEST_N,flags:P.Flags.NONE,requestN:e,streamId:this.streamId}):this.initialRequestN+=e)},e.prototype.cancel=function(){var e,t=this.inboundDone,r=this.outboundDone;t&&r||(this.inboundDone=!0,this.outboundDone=!0,r||this.receiver.cancel(),this.streamId?(this.stream.send({type:t?P.FrameTypes.ERROR:P.FrameTypes.CANCEL,flags:P.Flags.NONE,streamId:this.streamId,code:L.ErrorCodes.CANCELED,message:"Cancelled"}),this.stream.disconnect(this),w.cancel(this)):null===(e=this.leaseManager)||void 0===e||e.cancelRequest(this))},e.prototype.onNext=function(e,t){var r,n;if(!this.outboundDone)if(t&&(this.outboundDone=!0,this.inboundDone&&this.stream.disconnect(this)),(0,M.isFragmentable)(e,this.fragmentSize,P.FrameTypes.PAYLOAD))try{for(var a=D((0,M.fragment)(this.streamId,e,this.fragmentSize,P.FrameTypes.PAYLOAD,t)),s=a.next();!s.done;s=a.next()){var o=s.value;this.stream.send(o)}}catch(i){r={error:i}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}else this.stream.send({type:P.FrameTypes.PAYLOAD,streamId:this.streamId,flags:P.Flags.NEXT|(e.metadata?P.Flags.METADATA:P.Flags.NONE)|(t?P.Flags.COMPLETE:P.Flags.NONE),data:e.data,metadata:e.metadata})},e.prototype.onComplete=function(){this.streamId?this.outboundDone||(this.outboundDone=!0,this.stream.send({type:P.FrameTypes.PAYLOAD,streamId:this.streamId,flags:P.Flags.COMPLETE,data:null,metadata:null}),this.inboundDone&&this.stream.disconnect(this)):this.isComplete=!0},e.prototype.onError=function(e){if(!this.outboundDone){var t=this.inboundDone;this.outboundDone=!0,this.inboundDone=!0,this.stream.send({type:P.FrameTypes.ERROR,streamId:this.streamId,flags:P.Flags.NONE,code:e instanceof L.RSocketError?e.code:L.ErrorCodes.APPLICATION_ERROR,message:e.message}),this.stream.disconnect(this),t||this.receiver.onError(e)}},e.prototype.onExtension=function(e,t,r){if(!this.outboundDone)return this.streamId?void this.stream.send({streamId:this.streamId,type:P.FrameTypes.EXT,extendedType:e,extendedContent:t,flags:r?P.Flags.IGNORE:P.Flags.NONE}):(this.hasExtension=!0,this.extendedType=e,this.extendedContent=t,void(this.flags=r?P.Flags.IGNORE:P.Flags.NONE))},e.prototype.close=function(e){if(!this.inboundDone||!this.outboundDone){var t=this.inboundDone,r=this.outboundDone;this.inboundDone=!0,this.outboundDone=!0,w.cancel(this),r||this.receiver.cancel(),t||(e?this.receiver.onError(e):this.receiver.onComplete())}},e}();b.RequestChannelRequesterStream=x;var U=function(){function e(e,t,r,n,a){if(this.streamId=e,this.stream=t,this.fragmentSize=r,this.handler=n,this.streamType=P.FrameTypes.REQUEST_CHANNEL,t.connect(this),P.Flags.hasFollows(a.flags))return w.add(this,a.data,a.metadata),this.initialRequestN=a.requestN,void(this.isComplete=P.Flags.hasComplete(a.flags));var s={data:a.data,metadata:a.metadata},o=P.Flags.hasComplete(a.flags);this.inboundDone=o;try{this.receiver=n(s,a.requestN,o,this),this.outboundDone&&this.defferedError&&this.receiver.onError(this.defferedError)}catch(i){this.outboundDone&&!this.inboundDone?this.cancel():this.inboundDone=!0,this.onError(i)}}return e.prototype.handle=function(e){var t,r=e.type;switch(r){case P.FrameTypes.PAYLOAD:if(P.Flags.hasFollows(e.flags)){if(w.add(this,e.data,e.metadata))return;t="Unexpected frame size";break}var n=this.hasFragments?w.reassemble(this,e.data,e.metadata):{data:e.data,metadata:e.metadata},a=P.Flags.hasComplete(e.flags);if(this.receiver){if(a&&(this.inboundDone=!0,this.outboundDone&&this.stream.disconnect(this),!P.Flags.hasNext(e.flags)))return void this.receiver.onComplete();this.receiver.onNext(n,a)}else{(s=this.isComplete||a)&&(this.inboundDone=!0,this.outboundDone&&this.stream.disconnect(this));try{this.receiver=this.handler(n,this.initialRequestN,s,this),this.outboundDone&&this.defferedError}catch(l){this.outboundDone&&!this.inboundDone?this.cancel():this.inboundDone=!0,this.onError(l)}}return;case P.FrameTypes.REQUEST_N:if(!this.receiver||this.hasFragments){t="Unexpected frame type [".concat(r,"] during reassembly");break}return void this.receiver.request(e.requestN);case P.FrameTypes.ERROR:case P.FrameTypes.CANCEL:var s=this.inboundDone,o=this.outboundDone;if(this.inboundDone=!0,this.outboundDone=!0,this.stream.disconnect(this),w.cancel(this),!this.receiver)return;if(o||this.receiver.cancel(),!s){var i=r===P.FrameTypes.CANCEL?new L.RSocketError(L.ErrorCodes.CANCELED,"Cancelled"):new L.RSocketError(e.code,e.message);this.receiver.onError(i)}return;case P.FrameTypes.EXT:if(!this.receiver||this.hasFragments){t="Unexpected frame type [".concat(r,"] during reassembly");break}return void this.receiver.onExtension(e.extendedType,e.extendedContent,P.Flags.hasIgnore(e.flags));default:t="Unexpected frame type [".concat(r,"]")}this.stream.send({type:P.FrameTypes.ERROR,flags:P.Flags.NONE,code:L.ErrorCodes.CANCELED,message:t,streamId:this.streamId}),this.stream.disconnect(this),this.close(new L.RSocketError(L.ErrorCodes.CANCELED,t))},e.prototype.onError=function(e){if(this.outboundDone)console.warn("Trying to error for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));else{var t=this.inboundDone;this.outboundDone=!0,this.inboundDone=!0,this.stream.send({type:P.FrameTypes.ERROR,flags:P.Flags.NONE,code:e instanceof L.RSocketError?e.code:L.ErrorCodes.APPLICATION_ERROR,message:e.message,streamId:this.streamId}),this.stream.disconnect(this),t||(this.receiver?this.receiver.onError(e):this.defferedError=e)}},e.prototype.onNext=function(e,t){var r,n;if(!this.outboundDone){if(t&&(this.outboundDone=!0),(0,M.isFragmentable)(e,this.fragmentSize,P.FrameTypes.PAYLOAD))try{for(var a=D((0,M.fragment)(this.streamId,e,this.fragmentSize,P.FrameTypes.PAYLOAD,t)),s=a.next();!s.done;s=a.next()){var o=s.value;this.stream.send(o)}}catch(i){r={error:i}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}else this.stream.send({type:P.FrameTypes.PAYLOAD,flags:P.Flags.NEXT|(t?P.Flags.COMPLETE:P.Flags.NONE)|(e.metadata?P.Flags.METADATA:P.Flags.NONE),data:e.data,metadata:e.metadata,streamId:this.streamId});t&&this.inboundDone&&this.stream.disconnect(this)}},e.prototype.onComplete=function(){this.outboundDone||(this.outboundDone=!0,this.stream.send({type:P.FrameTypes.PAYLOAD,flags:P.Flags.COMPLETE,streamId:this.streamId,data:null,metadata:null}),this.inboundDone&&this.stream.disconnect(this))},e.prototype.onExtension=function(e,t,r){this.outboundDone&&this.inboundDone||this.stream.send({type:P.FrameTypes.EXT,streamId:this.streamId,flags:r?P.Flags.IGNORE:P.Flags.NONE,extendedType:e,extendedContent:t})},e.prototype.request=function(e){this.inboundDone||this.stream.send({type:P.FrameTypes.REQUEST_N,flags:P.Flags.NONE,streamId:this.streamId,requestN:e})},e.prototype.cancel=function(){this.inboundDone||(this.inboundDone=!0,this.stream.send({type:P.FrameTypes.CANCEL,flags:P.Flags.NONE,streamId:this.streamId}),this.outboundDone&&this.stream.disconnect(this))},e.prototype.close=function(e){if(this.inboundDone&&this.outboundDone)console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):""));else{var t=this.inboundDone,r=this.outboundDone;this.inboundDone=!0,this.outboundDone=!0,w.cancel(this);var n=this.receiver;n&&(r||n.cancel(),t||(e?n.onError(e):n.onComplete()))}},e}();b.RequestChannelResponderStream=U;var k={},q=e&&e.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),j=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),B=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&q(t,e,r);return j(t,e),t},Q=e&&e.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(k,"__esModule",{value:!0}),k.RequestFnfResponderStream=k.RequestFnFRequesterStream=void 0;var z=E,H=S,X=d,V=B(N),K=function(){function e(e,t,r,n){this.payload=e,this.receiver=t,this.fragmentSize=r,this.leaseManager=n,this.streamType=X.FrameTypes.REQUEST_FNF}return e.prototype.handleReady=function(e,t){var r,n;if(this.done)return!1;if(this.streamId=e,(0,H.isFragmentable)(this.payload,this.fragmentSize,X.FrameTypes.REQUEST_FNF))try{for(var a=Q((0,H.fragment)(e,this.payload,this.fragmentSize,X.FrameTypes.REQUEST_FNF)),s=a.next();!s.done;s=a.next()){var o=s.value;t.send(o)}}catch(i){r={error:i}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}else t.send({type:X.FrameTypes.REQUEST_FNF,data:this.payload.data,metadata:this.payload.metadata,flags:this.payload.metadata?X.Flags.METADATA:0,streamId:e});return this.done=!0,this.receiver.onComplete(),!0},e.prototype.handleReject=function(e){this.done||(this.done=!0,this.receiver.onError(e))},e.prototype.cancel=function(){var e;this.done||(this.done=!0,null===(e=this.leaseManager)||void 0===e||e.cancelRequest(this))},e.prototype.handle=function(e){e.type!=X.FrameTypes.ERROR?this.close(new z.RSocketError(z.ErrorCodes.CANCELED,"Received invalid frame")):this.close(new z.RSocketError(e.code,e.message))},e.prototype.close=function(e){this.done?console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):"")):e?this.receiver.onError(e):this.receiver.onComplete()},e}();k.RequestFnFRequesterStream=K;var Y=function(){function e(e,t,r,n){if(this.streamId=e,this.stream=t,this.handler=r,this.streamType=X.FrameTypes.REQUEST_FNF,X.Flags.hasFollows(n.flags))return V.add(this,n.data,n.metadata),void t.connect(this);var a={data:n.data,metadata:n.metadata};try{this.cancellable=r(a,this)}catch(s){}}return e.prototype.handle=function(e){var t;if(e.type==X.FrameTypes.PAYLOAD){if(!X.Flags.hasFollows(e.flags)){this.stream.disconnect(this);var r=V.reassemble(this,e.data,e.metadata);try{this.cancellable=this.handler(r,this)}catch(n){}return}if(V.add(this,e.data,e.metadata))return;t="Unexpected fragment size"}else t="Unexpected frame type [".concat(e.type,"]");this.done=!0,e.type!=X.FrameTypes.CANCEL&&e.type!=X.FrameTypes.ERROR&&this.stream.send({type:X.FrameTypes.ERROR,streamId:this.streamId,flags:X.Flags.NONE,code:z.ErrorCodes.CANCELED,message:t}),this.stream.disconnect(this),V.cancel(this)},e.prototype.close=function(e){var t;this.done?console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):"")):(this.done=!0,V.cancel(this),null===(t=this.cancellable)||void 0===t||t.cancel())},e.prototype.onError=function(e){},e.prototype.onComplete=function(){},e}();k.RequestFnfResponderStream=Y;var G={},W=e&&e.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),J=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),Z=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&W(t,e,r);return J(t,e),t},$=e&&e.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(G,"__esModule",{value:!0}),G.RequestResponseResponderStream=G.RequestResponseRequesterStream=void 0;var ee=E,te=S,re=d,ne=Z(N),ae=function(){function e(e,t,r,n){this.payload=e,this.receiver=t,this.fragmentSize=r,this.leaseManager=n,this.streamType=re.FrameTypes.REQUEST_RESPONSE}return e.prototype.handleReady=function(e,t){var r,n;if(this.done)return!1;if(this.streamId=e,this.stream=t,t.connect(this),(0,te.isFragmentable)(this.payload,this.fragmentSize,re.FrameTypes.REQUEST_RESPONSE))try{for(var a=$((0,te.fragment)(e,this.payload,this.fragmentSize,re.FrameTypes.REQUEST_RESPONSE)),s=a.next();!s.done;s=a.next()){var o=s.value;this.stream.send(o)}}catch(i){r={error:i}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}else this.stream.send({type:re.FrameTypes.REQUEST_RESPONSE,data:this.payload.data,metadata:this.payload.metadata,flags:this.payload.metadata?re.Flags.METADATA:0,streamId:e});return this.hasExtension&&this.stream.send({type:re.FrameTypes.EXT,streamId:e,extendedContent:this.extendedContent,extendedType:this.extendedType,flags:this.flags}),!0},e.prototype.handleReject=function(e){this.done||(this.done=!0,this.receiver.onError(e))},e.prototype.handle=function(e){var t,r=e.type;switch(r){case re.FrameTypes.PAYLOAD:var n=re.Flags.hasComplete(e.flags),a=re.Flags.hasNext(e.flags);if(n||!re.Flags.hasFollows(e.flags)){if(this.done=!0,this.stream.disconnect(this),!a)return void this.receiver.onComplete();var s=this.hasFragments?ne.reassemble(this,e.data,e.metadata):{data:e.data,metadata:e.metadata};return void this.receiver.onNext(s,!0)}if(!ne.add(this,e.data,e.metadata)){t="Unexpected fragment size";break}return;case re.FrameTypes.ERROR:return this.done=!0,this.stream.disconnect(this),ne.cancel(this),void this.receiver.onError(new ee.RSocketError(e.code,e.message));case re.FrameTypes.EXT:if(this.hasFragments){t="Unexpected frame type [".concat(r,"] during reassembly");break}return void this.receiver.onExtension(e.extendedType,e.extendedContent,re.Flags.hasIgnore(e.flags));default:t="Unexpected frame type [".concat(r,"]")}this.close(new ee.RSocketError(ee.ErrorCodes.CANCELED,t)),this.stream.send({type:re.FrameTypes.CANCEL,streamId:this.streamId,flags:re.Flags.NONE}),this.stream.disconnect(this)},e.prototype.cancel=function(){var e;this.done||(this.done=!0,this.streamId?(this.stream.send({type:re.FrameTypes.CANCEL,flags:re.Flags.NONE,streamId:this.streamId}),this.stream.disconnect(this),ne.cancel(this)):null===(e=this.leaseManager)||void 0===e||e.cancelRequest(this))},e.prototype.onExtension=function(e,t,r){if(!this.done)return this.streamId?void this.stream.send({streamId:this.streamId,type:re.FrameTypes.EXT,extendedType:e,extendedContent:t,flags:r?re.Flags.IGNORE:re.Flags.NONE}):(this.hasExtension=!0,this.extendedType=e,this.extendedContent=t,void(this.flags=r?re.Flags.IGNORE:re.Flags.NONE))},e.prototype.close=function(e){this.done||(this.done=!0,ne.cancel(this),e?this.receiver.onError(e):this.receiver.onComplete())},e}();G.RequestResponseRequesterStream=ae;var se=function(){function e(e,t,r,n,a){if(this.streamId=e,this.stream=t,this.fragmentSize=r,this.handler=n,this.streamType=re.FrameTypes.REQUEST_RESPONSE,t.connect(this),re.Flags.hasFollows(a.flags))ne.add(this,a.data,a.metadata);else{var s={data:a.data,metadata:a.metadata};try{this.receiver=n(s,this)}catch(o){this.onError(o)}}}return e.prototype.handle=function(e){var t,r;if(!this.receiver||this.hasFragments)if(e.type===re.FrameTypes.PAYLOAD){if(!re.Flags.hasFollows(e.flags)){var n=ne.reassemble(this,e.data,e.metadata);try{this.receiver=this.handler(n,this)}catch(a){this.onError(a)}return}if(ne.add(this,e.data,e.metadata))return;r="Unexpected fragment size"}else r="Unexpected frame type [".concat(e.type,"] during reassembly");else{if(e.type===re.FrameTypes.EXT)return void this.receiver.onExtension(e.extendedType,e.extendedContent,re.Flags.hasIgnore(e.flags));r="Unexpected frame type [".concat(e.type,"]")}this.done=!0,null===(t=this.receiver)||void 0===t||t.cancel(),e.type!==re.FrameTypes.CANCEL&&e.type!==re.FrameTypes.ERROR&&this.stream.send({type:re.FrameTypes.ERROR,flags:re.Flags.NONE,code:ee.ErrorCodes.CANCELED,message:r,streamId:this.streamId}),this.stream.disconnect(this),ne.cancel(this)},e.prototype.onError=function(e){this.done?console.warn("Trying to error for the second time. ".concat(e?"Dropping error [".concat(e,"]."):"")):(this.done=!0,this.stream.send({type:re.FrameTypes.ERROR,flags:re.Flags.NONE,code:e instanceof ee.RSocketError?e.code:ee.ErrorCodes.APPLICATION_ERROR,message:e.message,streamId:this.streamId}),this.stream.disconnect(this))},e.prototype.onNext=function(e,t){var r,n;if(!this.done){if(this.done=!0,(0,te.isFragmentable)(e,this.fragmentSize,re.FrameTypes.PAYLOAD))try{for(var a=$((0,te.fragment)(this.streamId,e,this.fragmentSize,re.FrameTypes.PAYLOAD,!0)),s=a.next();!s.done;s=a.next()){var o=s.value;this.stream.send(o)}}catch(i){r={error:i}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}else this.stream.send({type:re.FrameTypes.PAYLOAD,flags:re.Flags.NEXT|re.Flags.COMPLETE|(e.metadata?re.Flags.METADATA:0),data:e.data,metadata:e.metadata,streamId:this.streamId});this.stream.disconnect(this)}},e.prototype.onComplete=function(){this.done||(this.done=!0,this.stream.send({type:re.FrameTypes.PAYLOAD,flags:re.Flags.COMPLETE,streamId:this.streamId,data:null,metadata:null}),this.stream.disconnect(this))},e.prototype.onExtension=function(e,t,r){this.done||this.stream.send({type:re.FrameTypes.EXT,streamId:this.streamId,flags:r?re.Flags.IGNORE:re.Flags.NONE,extendedType:e,extendedContent:t})},e.prototype.close=function(e){var t;this.done?console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):"")):(ne.cancel(this),null===(t=this.receiver)||void 0===t||t.cancel())},e}();G.RequestResponseResponderStream=se;var oe={},ie=e&&e.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),le=e&&e.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),ue=e&&e.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&ie(t,e,r);return le(t,e),t},ce=e&&e.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(oe,"__esModule",{value:!0}),oe.RequestStreamResponderStream=oe.RequestStreamRequesterStream=void 0;var de=E,he=S,me=d,pe=ue(N),fe=function(){function e(e,t,r,n,a){this.payload=e,this.receiver=t,this.fragmentSize=r,this.initialRequestN=n,this.leaseManager=a,this.streamType=me.FrameTypes.REQUEST_STREAM}return e.prototype.handleReady=function(e,t){var r,n;if(this.done)return!1;if(this.streamId=e,this.stream=t,t.connect(this),(0,he.isFragmentable)(this.payload,this.fragmentSize,me.FrameTypes.REQUEST_STREAM))try{for(var a=ce((0,he.fragmentWithRequestN)(e,this.payload,this.fragmentSize,me.FrameTypes.REQUEST_STREAM,this.initialRequestN)),s=a.next();!s.done;s=a.next()){var o=s.value;this.stream.send(o)}}catch(i){r={error:i}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}else this.stream.send({type:me.FrameTypes.REQUEST_STREAM,data:this.payload.data,metadata:this.payload.metadata,requestN:this.initialRequestN,flags:void 0!==this.payload.metadata?me.Flags.METADATA:0,streamId:e});return this.hasExtension&&this.stream.send({type:me.FrameTypes.EXT,streamId:e,extendedContent:this.extendedContent,extendedType:this.extendedType,flags:this.flags}),!0},e.prototype.handleReject=function(e){this.done||(this.done=!0,this.receiver.onError(e))},e.prototype.handle=function(e){var t,r=e.type;switch(r){case me.FrameTypes.PAYLOAD:var n=me.Flags.hasComplete(e.flags),a=me.Flags.hasNext(e.flags);if(n||!me.Flags.hasFollows(e.flags)){if(n&&(this.done=!0,this.stream.disconnect(this),!a))return void this.receiver.onComplete();var s=this.hasFragments?pe.reassemble(this,e.data,e.metadata):{data:e.data,metadata:e.metadata};return void this.receiver.onNext(s,n)}if(!pe.add(this,e.data,e.metadata)){t="Unexpected fragment size";break}return;case me.FrameTypes.ERROR:return this.done=!0,this.stream.disconnect(this),pe.cancel(this),void this.receiver.onError(new de.RSocketError(e.code,e.message));case me.FrameTypes.EXT:if(this.hasFragments){t="Unexpected frame type [".concat(r,"] during reassembly");break}return void this.receiver.onExtension(e.extendedType,e.extendedContent,me.Flags.hasIgnore(e.flags));default:t="Unexpected frame type [".concat(r,"]")}this.close(new de.RSocketError(de.ErrorCodes.CANCELED,t)),this.stream.send({type:me.FrameTypes.CANCEL,streamId:this.streamId,flags:me.Flags.NONE}),this.stream.disconnect(this)},e.prototype.request=function(e){this.done||(this.streamId?this.stream.send({type:me.FrameTypes.REQUEST_N,flags:me.Flags.NONE,requestN:e,streamId:this.streamId}):this.initialRequestN+=e)},e.prototype.cancel=function(){var e;this.done||(this.done=!0,this.streamId?(this.stream.send({type:me.FrameTypes.CANCEL,flags:me.Flags.NONE,streamId:this.streamId}),this.stream.disconnect(this),pe.cancel(this)):null===(e=this.leaseManager)||void 0===e||e.cancelRequest(this))},e.prototype.onExtension=function(e,t,r){if(!this.done)return this.streamId?void this.stream.send({streamId:this.streamId,type:me.FrameTypes.EXT,extendedType:e,extendedContent:t,flags:r?me.Flags.IGNORE:me.Flags.NONE}):(this.hasExtension=!0,this.extendedType=e,this.extendedContent=t,void(this.flags=r?me.Flags.IGNORE:me.Flags.NONE))},e.prototype.close=function(e){this.done||(this.done=!0,pe.cancel(this),e?this.receiver.onError(e):this.receiver.onComplete())},e}();oe.RequestStreamRequesterStream=fe;var Ee=function(){function e(e,t,r,n,a){if(this.streamId=e,this.stream=t,this.fragmentSize=r,this.handler=n,this.streamType=me.FrameTypes.REQUEST_STREAM,t.connect(this),me.Flags.hasFollows(a.flags))return this.initialRequestN=a.requestN,void pe.add(this,a.data,a.metadata);var s={data:a.data,metadata:a.metadata};try{this.receiver=n(s,a.requestN,this)}catch(o){this.onError(o)}}return e.prototype.handle=function(e){var t,r;if(!this.receiver||this.hasFragments)if(e.type===me.FrameTypes.PAYLOAD){if(!me.Flags.hasFollows(e.flags)){var n=pe.reassemble(this,e.data,e.metadata);try{this.receiver=this.handler(n,this.initialRequestN,this)}catch(a){this.onError(a)}return}if(pe.add(this,e.data,e.metadata))return;r="Unexpected frame size"}else r="Unexpected frame type [".concat(e.type,"] during reassembly");else{if(e.type===me.FrameTypes.REQUEST_N)return void this.receiver.request(e.requestN);if(e.type===me.FrameTypes.EXT)return void this.receiver.onExtension(e.extendedType,e.extendedContent,me.Flags.hasIgnore(e.flags));r="Unexpected frame type [".concat(e.type,"]")}this.done=!0,pe.cancel(this),null===(t=this.receiver)||void 0===t||t.cancel(),e.type!==me.FrameTypes.CANCEL&&e.type!==me.FrameTypes.ERROR&&this.stream.send({type:me.FrameTypes.ERROR,flags:me.Flags.NONE,code:de.ErrorCodes.CANCELED,message:r,streamId:this.streamId}),this.stream.disconnect(this)},e.prototype.onError=function(e){this.done?console.warn("Trying to error for the second time. ".concat(e?"Dropping error [".concat(e,"]."):"")):(this.done=!0,this.stream.send({type:me.FrameTypes.ERROR,flags:me.Flags.NONE,code:e instanceof de.RSocketError?e.code:de.ErrorCodes.APPLICATION_ERROR,message:e.message,streamId:this.streamId}),this.stream.disconnect(this))},e.prototype.onNext=function(e,t){var r,n;if(!this.done){if(t&&(this.done=!0),(0,he.isFragmentable)(e,this.fragmentSize,me.FrameTypes.PAYLOAD))try{for(var a=ce((0,he.fragment)(this.streamId,e,this.fragmentSize,me.FrameTypes.PAYLOAD,t)),s=a.next();!s.done;s=a.next()){var o=s.value;this.stream.send(o)}}catch(i){r={error:i}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}else this.stream.send({type:me.FrameTypes.PAYLOAD,flags:me.Flags.NEXT|(t?me.Flags.COMPLETE:me.Flags.NONE)|(e.metadata?me.Flags.METADATA:me.Flags.NONE),data:e.data,metadata:e.metadata,streamId:this.streamId});t&&this.stream.disconnect(this)}},e.prototype.onComplete=function(){this.done||(this.done=!0,this.stream.send({type:me.FrameTypes.PAYLOAD,flags:me.Flags.COMPLETE,streamId:this.streamId,data:null,metadata:null}),this.stream.disconnect(this))},e.prototype.onExtension=function(e,t,r){this.done||this.stream.send({type:me.FrameTypes.EXT,streamId:this.streamId,flags:r?me.Flags.IGNORE:me.Flags.NONE,extendedType:e,extendedContent:t})},e.prototype.close=function(e){var t;this.done?console.warn("Trying to close for the second time. ".concat(e?"Dropping error [".concat(e,"]."):"")):(pe.cancel(this),null===(t=this.receiver)||void 0===t||t.cancel())},e}();oe.RequestStreamResponderStream=Ee,Object.defineProperty(F,"__esModule",{value:!0}),F.KeepAliveSender=F.KeepAliveHandler=F.DefaultConnectionFrameHandler=F.DefaultStreamRequestHandler=F.LeaseHandler=F.RSocketRequester=void 0;var ye=E,ve=d,ge=b,Te=k,Re=G,Fe=oe,be=function(){function e(e,t,r){this.connection=e,this.fragmentSize=t,this.leaseManager=r}return e.prototype.fireAndForget=function(e,t){var r=new Te.RequestFnFRequesterStream(e,t,this.fragmentSize,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(r):this.connection.multiplexerDemultiplexer.createRequestStream(r),r},e.prototype.requestResponse=function(e,t){var r=new Re.RequestResponseRequesterStream(e,t,this.fragmentSize,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(r):this.connection.multiplexerDemultiplexer.createRequestStream(r),r},e.prototype.requestStream=function(e,t,r){var n=new Fe.RequestStreamRequesterStream(e,r,this.fragmentSize,t,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(n):this.connection.multiplexerDemultiplexer.createRequestStream(n),n},e.prototype.requestChannel=function(e,t,r,n){var a=new ge.RequestChannelRequesterStream(e,r,n,this.fragmentSize,t,this.leaseManager);return this.leaseManager?this.leaseManager.requestLease(a):this.connection.multiplexerDemultiplexer.createRequestStream(a),a},e.prototype.metadataPush=function(e,t){throw new Error("Method not implemented.")},e.prototype.close=function(e){this.connection.close(e)},e.prototype.onClose=function(e){this.connection.onClose(e)},e}();F.RSocketRequester=be;var Se=function(){function e(e,t){this.maxPendingRequests=e,this.multiplexer=t,this.pendingRequests=[],this.expirationTime=0,this.availableLease=0}return e.prototype.handle=function(e){for(this.expirationTime=e.ttl+Date.now(),this.availableLease=e.requestCount;this.availableLease>0&&this.pendingRequests.length>0;){var t=this.pendingRequests.shift();this.availableLease--,this.multiplexer.createRequestStream(t)}},e.prototype.requestLease=function(e){var t=this.availableLease;if(t>0&&Date.now()<this.expirationTime)return this.availableLease=t-1,void this.multiplexer.createRequestStream(e);this.pendingRequests.length>=this.maxPendingRequests?e.handleReject(new ye.RSocketError(ye.ErrorCodes.REJECTED,"No available lease given")):this.pendingRequests.push(e)},e.prototype.cancelRequest=function(e){var t=this.pendingRequests.indexOf(e);t>-1&&this.pendingRequests.splice(t,1)},e}();F.LeaseHandler=Se;var Ae=function(){function e(e,t){this.rsocket=e,this.fragmentSize=t}return e.prototype.handle=function(e,t){switch(e.type){case ve.FrameTypes.REQUEST_FNF:return void(this.rsocket.fireAndForget&&new Te.RequestFnfResponderStream(e.streamId,t,this.rsocket.fireAndForget.bind(this.rsocket),e));case ve.FrameTypes.REQUEST_RESPONSE:return this.rsocket.requestResponse?void new Re.RequestResponseResponderStream(e.streamId,t,this.fragmentSize,this.rsocket.requestResponse.bind(this.rsocket),e):void this.rejectRequest(e.streamId,t);case ve.FrameTypes.REQUEST_STREAM:return this.rsocket.requestStream?void new Fe.RequestStreamResponderStream(e.streamId,t,this.fragmentSize,this.rsocket.requestStream.bind(this.rsocket),e):void this.rejectRequest(e.streamId,t);case ve.FrameTypes.REQUEST_CHANNEL:return this.rsocket.requestChannel?void new ge.RequestChannelResponderStream(e.streamId,t,this.fragmentSize,this.rsocket.requestChannel.bind(this.rsocket),e):void this.rejectRequest(e.streamId,t)}},e.prototype.rejectRequest=function(e,t){t.send({type:ve.FrameTypes.ERROR,streamId:e,flags:ve.Flags.NONE,code:ye.ErrorCodes.REJECTED,message:"No available handler found"})},e.prototype.close=function(){},e}();F.DefaultStreamRequestHandler=Ae;var Oe,Ne,_e=function(){function e(e,t,r,n,a){this.connection=e,this.keepAliveHandler=t,this.keepAliveSender=r,this.leaseHandler=n,this.rsocket=a}return e.prototype.handle=function(e){switch(e.type){case ve.FrameTypes.KEEPALIVE:return void this.keepAliveHandler.handle(e);case ve.FrameTypes.LEASE:return this.leaseHandler?void this.leaseHandler.handle(e):void 0;case ve.FrameTypes.ERROR:return void this.connection.close(new ye.RSocketError(e.code,e.message));case ve.FrameTypes.METADATA_PUSH:return void this.rsocket.metadataPush;default:this.connection.multiplexerDemultiplexer.connectionOutbound.send({type:ve.FrameTypes.ERROR,streamId:0,flags:ve.Flags.NONE,message:"Received unknown frame type",code:ye.ErrorCodes.CONNECTION_ERROR})}},e.prototype.pause=function(){var e;this.keepAliveHandler.pause(),null===(e=this.keepAliveSender)||void 0===e||e.pause()},e.prototype.resume=function(){var e;this.keepAliveHandler.start(),null===(e=this.keepAliveSender)||void 0===e||e.start()},e.prototype.close=function(e){var t;this.keepAliveHandler.close(),null===(t=this.rsocket.close)||void 0===t||t.call(this.rsocket,e)},e}();F.DefaultConnectionFrameHandler=_e,(Ne=Oe||(Oe={}))[Ne.Paused=0]="Paused",Ne[Ne.Running=1]="Running",Ne[Ne.Closed=2]="Closed";var Ie,Ce,De=function(){function e(e,t){this.connection=e,this.keepAliveTimeoutDuration=t,this.state=Oe.Paused,this.outbound=e.multiplexerDemultiplexer.connectionOutbound}return e.prototype.handle=function(e){this.keepAliveLastReceivedMillis=Date.now(),ve.Flags.hasRespond(e.flags)&&this.outbound.send({type:ve.FrameTypes.KEEPALIVE,streamId:0,data:e.data,flags:e.flags^ve.Flags.RESPOND,lastReceivedPosition:0})},e.prototype.start=function(){this.state===Oe.Paused&&(this.keepAliveLastReceivedMillis=Date.now(),this.state=Oe.Running,this.activeTimeout=setTimeout(this.timeoutCheck.bind(this),this.keepAliveTimeoutDuration))},e.prototype.pause=function(){this.state===Oe.Running&&(this.state=Oe.Paused,clearTimeout(this.activeTimeout))},e.prototype.close=function(){this.state=Oe.Closed,clearTimeout(this.activeTimeout)},e.prototype.timeoutCheck=function(){var e=Date.now()-this.keepAliveLastReceivedMillis;e>=this.keepAliveTimeoutDuration?this.connection.close(new Error("No keep-alive acks for ".concat(this.keepAliveTimeoutDuration," millis"))):this.activeTimeout=setTimeout(this.timeoutCheck.bind(this),Math.max(100,this.keepAliveTimeoutDuration-e))},e}();F.KeepAliveHandler=De,(Ce=Ie||(Ie={}))[Ce.Paused=0]="Paused",Ce[Ce.Running=1]="Running",Ce[Ce.Closed=2]="Closed";var Le=function(){function e(e,t){this.outbound=e,this.keepAlivePeriodDuration=t,this.state=Ie.Paused}return e.prototype.sendKeepAlive=function(){this.outbound.send({type:ve.FrameTypes.KEEPALIVE,streamId:0,data:void 0,flags:ve.Flags.RESPOND,lastReceivedPosition:0})},e.prototype.start=function(){this.state===Ie.Paused&&(this.state=Ie.Running,this.activeInterval=setInterval(this.sendKeepAlive.bind(this),this.keepAlivePeriodDuration))},e.prototype.pause=function(){this.state===Ie.Running&&(this.state=Ie.Paused,clearInterval(this.activeInterval))},e.prototype.close=function(){this.state=Ie.Closed,clearInterval(this.activeInterval)},e}();F.KeepAliveSender=Le;var Me,Pe,we={};function xe(){if(Me)return we;Me=1;var t=e&&e.__values||function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(we,"__esModule",{value:!0}),we.FrameStore=void 0;var r=ze(),n=c,a=function(){function e(){this.storedFrames=[],this._lastReceivedFramePosition=0,this._firstAvailableFramePosition=0,this._lastSentFramePosition=0}return Object.defineProperty(e.prototype,"lastReceivedFramePosition",{get:function(){return this._lastReceivedFramePosition},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"firstAvailableFramePosition",{get:function(){return this._firstAvailableFramePosition},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lastSentFramePosition",{get:function(){return this._lastSentFramePosition},enumerable:!1,configurable:!0}),e.prototype.store=function(e){this._lastSentFramePosition+=(0,n.sizeOfFrame)(e),this.storedFrames.push(e)},e.prototype.record=function(e){this._lastReceivedFramePosition+=(0,n.sizeOfFrame)(e)},e.prototype.dropTo=function(e){for(var t=e-this._firstAvailableFramePosition;t>0&&this.storedFrames.length>0;){var a=this.storedFrames.shift();t-=(0,n.sizeOfFrame)(a)}if(0!==t)throw new r.RSocketError(r.ErrorCodes.CONNECTION_ERROR,"State inconsistency. Expected bytes to drop ".concat(e-this._firstAvailableFramePosition," but actual ").concat(t));this._firstAvailableFramePosition=e},e.prototype.drain=function(e){var r,n;try{for(var a=t(this.storedFrames),s=a.next();!s.done;s=a.next()){e(s.value)}}catch(o){r={error:o}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}},e}();return we.FrameStore=a,we}function Ue(){if(Pe)return g;Pe=1;var t=e&&e.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(a,s){function o(e){try{l(n.next(e))}catch(t){s(t)}}function i(e){try{l(n.throw(e))}catch(t){s(t)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,i)}l((n=n.apply(e,t||[])).next())})},r=e&&e.__generator||function(e,t){var r,n,a,s,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(s){return function(i){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(a=2&s[0]?n.return:s[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,s[1])).done)return a;switch(n=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){o.label=s[1];break}if(6===s[0]&&o.label<a[1]){o.label=a[1],a=s;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(s);break}a[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(i){s=[6,i],n=0}finally{r=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,i])}}};Object.defineProperty(g,"__esModule",{value:!0}),g.RSocketConnector=void 0;var n=R(),a=d,s=F,o=xe(),i=function(){function e(e){this.config=e}return e.prototype.connect=function(){var e,i,l,u,c,d,h,m,p,f,E,y,v,g,T,R,F,b,S,A;return t(this,void 0,void 0,function(){var O,N,_,I,C,D,L,M,P,w=this;return r(this,function(x){switch(x.label){case 0:return O=this.config,N={type:a.FrameTypes.SETUP,dataMimeType:null!==(i=null===(e=O.setup)||void 0===e?void 0:e.dataMimeType)&&void 0!==i?i:"application/octet-stream",metadataMimeType:null!==(u=null===(l=O.setup)||void 0===l?void 0:l.metadataMimeType)&&void 0!==u?u:"application/octet-stream",keepAlive:null!==(d=null===(c=O.setup)||void 0===c?void 0:c.keepAlive)&&void 0!==d?d:6e4,lifetime:null!==(m=null===(h=O.setup)||void 0===h?void 0:h.lifetime)&&void 0!==m?m:3e5,metadata:null===(f=null===(p=O.setup)||void 0===p?void 0:p.payload)||void 0===f?void 0:f.metadata,data:null===(y=null===(E=O.setup)||void 0===E?void 0:E.payload)||void 0===y?void 0:y.data,resumeToken:null!==(g=null===(v=O.resume)||void 0===v?void 0:v.tokenGenerator())&&void 0!==g?g:null,streamId:0,majorVersion:1,minorVersion:0,flags:((null===(R=null===(T=O.setup)||void 0===T?void 0:T.payload)||void 0===R?void 0:R.metadata)?a.Flags.METADATA:a.Flags.NONE)|(O.lease?a.Flags.LEASE:a.Flags.NONE)|(O.resume?a.Flags.RESUME_ENABLE:a.Flags.NONE)},[4,O.transport.connect(function(e){return O.resume?new n.ResumableClientServerInputMultiplexerDemultiplexer(n.StreamIdGenerator.create(-1),e,e,new o.FrameStore,N.resumeToken.toString(),function(e,s){return t(w,void 0,void 0,function(){var t,o,i;return r(this,function(r){switch(r.label){case 0:return t=function(t){return t.send({type:a.FrameTypes.RESUME,streamId:0,flags:a.Flags.NONE,clientPosition:s.firstAvailableFramePosition,serverPosition:s.lastReceivedFramePosition,majorVersion:N.minorVersion,minorVersion:N.majorVersion,resumeToken:N.resumeToken}),new n.ResumeOkAwaitingResumableClientServerInputMultiplexerDemultiplexer(t,t,e)},o=-1,[4,(i=function(){return o++,O.resume.reconnectFunction(o).then(function(){return O.transport.connect(t).catch(i)})})()];case 1:return r.sent(),[2]}})})}):new n.ClientServerInputMultiplexerDemultiplexer(n.StreamIdGenerator.create(-1),e,e)})];case 1:return _=x.sent(),I=new s.KeepAliveSender(_.multiplexerDemultiplexer.connectionOutbound,N.keepAlive),C=new s.KeepAliveHandler(_,N.lifetime),D=O.lease?new s.LeaseHandler(null!==(F=O.lease.maxPendingRequests)&&void 0!==F?F:256,_.multiplexerDemultiplexer):void 0,L=null!==(b=O.responder)&&void 0!==b?b:{},M=new s.DefaultConnectionFrameHandler(_,C,I,D,L),P=new s.DefaultStreamRequestHandler(L,0),_.onClose(function(e){I.close(),C.close(),M.close(e)}),_.multiplexerDemultiplexer.connectionInbound(M),_.multiplexerDemultiplexer.handleRequestStream(P),_.multiplexerDemultiplexer.connectionOutbound.send(N),C.start(),I.start(),[2,new s.RSocketRequester(_,null!==(A=null===(S=O.fragmentation)||void 0===S?void 0:S.maxOutboundFragmentSize)&&void 0!==A?A:0,D)]}})})},e}();return g.RSocketConnector=i,g}var ke,qe={};function je(){if(ke)return qe;ke=1;var t=e&&e.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(a,s){function o(e){try{l(n.next(e))}catch(t){s(t)}}function i(e){try{l(n.throw(e))}catch(t){s(t)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(o,i)}l((n=n.apply(e,t||[])).next())})},r=e&&e.__generator||function(e,t){var r,n,a,s,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(s){return function(i){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(a=2&s[0]?n.return:s[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,s[1])).done)return a;switch(n=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(a=o.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){o.label=s[1];break}if(6===s[0]&&o.label<a[1]){o.label=a[1],a=s;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(s);break}a[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(i){s=[6,i],n=0}finally{r=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,i])}}};Object.defineProperty(qe,"__esModule",{value:!0}),qe.RSocketServer=void 0;var n=R(),a=E,s=d,o=F,i=xe(),l=function(){function e(e){var t,r;this.acceptor=e.acceptor,this.transport=e.transport,this.lease=e.lease,this.serverSideKeepAlive=e.serverSideKeepAlive,this.sessionStore=e.resume?{}:void 0,this.sessionTimeout=null!==(r=null===(t=e.resume)||void 0===t?void 0:t.sessionTimeout)&&void 0!==r?r:void 0}return e.prototype.bind=function(){return t(this,void 0,void 0,function(){var e=this;return r(this,function(l){switch(l.label){case 0:return[4,this.transport.bind(function(n,i){return t(e,void 0,void 0,function(){var e,t,l,u,c,d,h,m,p,f,E,y,v;return r(this,function(r){switch(r.label){case 0:switch(n.type){case s.FrameTypes.SETUP:return[3,1];case s.FrameTypes.RESUME:return[3,5]}return[3,6];case 1:return r.trys.push([1,3,,4]),this.lease&&!s.Flags.hasLease(n.flags)?(e=new a.RSocketError(a.ErrorCodes.REJECTED_SETUP,"Lease has to be enabled"),i.multiplexerDemultiplexer.connectionOutbound.send({type:s.FrameTypes.ERROR,streamId:0,flags:s.Flags.NONE,code:e.code,message:e.message}),i.close(e),[2]):s.Flags.hasLease(n.flags)&&!this.lease?(e=new a.RSocketError(a.ErrorCodes.REJECTED_SETUP,"Lease has to be disabled"),i.multiplexerDemultiplexer.connectionOutbound.send({type:s.FrameTypes.ERROR,streamId:0,flags:s.Flags.NONE,code:e.code,message:e.message}),i.close(e),[2]):(t=s.Flags.hasLease(n.flags)?new o.LeaseHandler(null!==(f=this.lease.maxPendingRequests)&&void 0!==f?f:256,i.multiplexerDemultiplexer):void 0,l=new o.RSocketRequester(i,null!==(y=null===(E=this.fragmentation)||void 0===E?void 0:E.maxOutboundFragmentSize)&&void 0!==y?y:0,t),[4,this.acceptor.accept({data:n.data,dataMimeType:n.dataMimeType,metadata:n.metadata,metadataMimeType:n.metadataMimeType,flags:n.flags,keepAliveMaxLifetime:n.lifetime,keepAliveInterval:n.keepAlive,resumeToken:n.resumeToken},l)]);case 2:return u=r.sent(),c=new o.KeepAliveHandler(i,n.lifetime),d=this.serverSideKeepAlive?new o.KeepAliveSender(i.multiplexerDemultiplexer.connectionOutbound,n.keepAlive):void 0,h=new o.DefaultConnectionFrameHandler(i,c,d,t,u),m=new o.DefaultStreamRequestHandler(u,0),i.onClose(function(e){null==d||d.close(),c.close(),h.close(e)}),i.multiplexerDemultiplexer.connectionInbound(h),i.multiplexerDemultiplexer.handleRequestStream(m),c.start(),null==d||d.start(),[3,4];case 3:return p=r.sent(),i.multiplexerDemultiplexer.connectionOutbound.send({type:s.FrameTypes.ERROR,streamId:0,code:a.ErrorCodes.REJECTED_SETUP,message:null!==(v=p.message)&&void 0!==v?v:"",flags:s.Flags.NONE}),i.close(p instanceof a.RSocketError?p:new a.RSocketError(a.ErrorCodes.REJECTED_SETUP,p.message)),[3,4];case 4:case 5:return[2];case 6:i.multiplexerDemultiplexer.connectionOutbound.send({type:s.FrameTypes.ERROR,streamId:0,code:a.ErrorCodes.UNSUPPORTED_SETUP,message:"Unsupported setup",flags:s.Flags.NONE}),i.close(new a.RSocketError(a.ErrorCodes.UNSUPPORTED_SETUP)),r.label=7;case 7:return[2]}})})},function(t,r){if(t.type===s.FrameTypes.RESUME){if(e.sessionStore){var o=e.sessionStore[t.resumeToken.toString()];return o?(o.resume(t,r,r),o):(r.send({type:s.FrameTypes.ERROR,streamId:0,code:a.ErrorCodes.REJECTED_RESUME,message:"No session found for the given resume token",flags:s.Flags.NONE}),void r.close())}return r.send({type:s.FrameTypes.ERROR,streamId:0,code:a.ErrorCodes.REJECTED_RESUME,message:"Resume is not enabled",flags:s.Flags.NONE}),void r.close()}if(t.type===s.FrameTypes.SETUP&&s.Flags.hasResume(t.flags)){if(!e.sessionStore){var l=new a.RSocketError(a.ErrorCodes.REJECTED_SETUP,"No resume support");return r.send({type:s.FrameTypes.ERROR,streamId:0,flags:s.Flags.NONE,code:l.code,message:l.message}),void r.close(l)}var u=new n.ResumableClientServerInputMultiplexerDemultiplexer(n.StreamIdGenerator.create(0),r,r,new i.FrameStore,t.resumeToken.toString(),e.sessionStore,e.sessionTimeout);return e.sessionStore[t.resumeToken.toString()]=u,u}return new n.ClientServerInputMultiplexerDemultiplexer(n.StreamIdGenerator.create(0),r,r)})];case 1:return[2,l.sent()]}})})},e}();return qe.RSocketServer=l,qe}var Be,Qe={};function ze(){return Be||(Be=1,function(t){var r=e&&e.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),n=e&&e.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),n(c,t),n(h,t),n(m,t),n(E,t),n(d,t),n(y,t),n(Ue(),t),n(je(),t),n(Qe,t)}(u)),u}Object.defineProperty(Qe,"__esModule",{value:!0});var He=ze(),Xe={},Ve={},Ke={},Ye=e&&e.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(Ke,"__esModule",{value:!0}),Ke.WebsocketDuplexConnection=void 0;var Ge=ze(),We=function(e){function t(t,r,n){var a=e.call(this)||this;return a.websocket=t,a.deserializer=r,a.handleClosed=function(e){a.close(new Error(e.reason||"WebsocketDuplexConnection: Socket closed unexpectedly."))},a.handleError=function(e){a.close(e.error)},a.handleMessage=function(e){try{var t=Buffer.from(e.data),r=a.deserializer.deserializeFrame(t);a.multiplexerDemultiplexer.handle(r)}catch(n){a.close(n)}},t.addEventListener("close",a.handleClosed),t.addEventListener("error",a.handleError),t.addEventListener("message",a.handleMessage),a.multiplexerDemultiplexer=n(a),a}return Ye(t,e),Object.defineProperty(t.prototype,"availability",{get:function(){return this.done?0:1},enumerable:!1,configurable:!0}),t.prototype.close=function(t){this.done||(this.websocket.removeEventListener("close",this.handleClosed),this.websocket.removeEventListener("error",this.handleError),this.websocket.removeEventListener("message",this.handleMessage),this.websocket.close(),delete this.websocket),e.prototype.close.call(this,t)},t.prototype.send=function(e){if(!this.done){var t=(0,Ge.serializeFrame)(e);this.websocket.send(t)}},t}(Ge.Deferred);Ke.WebsocketDuplexConnection=We,Object.defineProperty(Ve,"__esModule",{value:!0}),Ve.WebsocketClientTransport=void 0;var Je=ze(),Ze=Ke,$e=function(){function e(e){var t;this.url=e.url,this.factory=null!==(t=e.wsCreator)&&void 0!==t?t:function(e){return new WebSocket(e)}}return e.prototype.connect=function(e){var t=this;return new Promise(function(r,n){var a=t.factory(t.url);a.binaryType="arraybuffer";var s=function(){a.removeEventListener("open",s),a.removeEventListener("error",o),r(new Ze.WebsocketDuplexConnection(a,new Je.Deserializer,e))},o=function(e){a.removeEventListener("open",s),a.removeEventListener("error",o),n(e.error)};a.addEventListener("open",s),a.addEventListener("error",o)})},e}();Ve.WebsocketClientTransport=$e,function(t){var r=e&&e.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),n=e&&e.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),n(Ve,t)}(Xe);export{r as a,Xe as b,e as c,He as d,t as g};
