# 工具调用显示修复报告

## 问题描述

Claude Code Plus IntelliJ插件中，AI使用工具（如LS、Read、Grep等）时，用户看不到工具调用过程，只能看到最终回复。这导致用户无法了解AI是如何解决问题的。

## 问题分析

### 根本原因

通过分析Claude CLI的实际输出格式，发现工具调用过程是通过**3个分离的事件**进行的：

1. **工具调用事件** (`type: "assistant"`):
```json
{"type":"assistant","message":{"content":[{"type":"tool_use","id":"toolu_xxx","name":"LS","input":{"path":"..."}}]}}
```

2. **工具结果事件** (`type: "user"`):
```json  
{"type":"user","message":{"content":[{"tool_use_id":"toolu_xxx","type":"tool_result","content":"... 结果 ..."}]}}
```

3. **最终回复事件** (`type: "assistant"`):
```json
{"type":"assistant","message":{"content":[{"type":"text","text":"根据文件列表，我发现..."}]}}
```

### 原有实现的问题

1. **MessageConverter错误假设**: 原有代码假设工具调用和结果在同一个事件中，导致无法正确解析分离的事件
2. **SessionObject消息合并**: 工具调用消息被错误地合并到其他消息中，丢失了工具调用信息
3. **事件处理不完整**: 没有处理`tool_result`事件来更新工具调用状态

## 解决方案

### 1. MessageConverter修复

- **修改`extractToolCalls`方法**: 只处理`tool_use`事件，创建`RUNNING`状态的工具调用
- **新增`extractToolResults`方法**: 专门处理`tool_result`事件，提取工具结果信息

### 2. SessionObject事件流处理

- **工具结果事件处理**: 在接收到`type=user`且包含`tool_result`的事件时，调用工具结果关联逻辑
- **新增`updateToolCallResult`方法**: 根据工具ID更新对应工具调用的状态和结果
- **保持消息顺序**: 工具调用消息不再被错误合并，保持独立显示

### 3. UI组件适配

- **CompactToolCallDisplay使用**: 确保使用正确的工具调用展示组件
- **状态更新触发**: 通过`onMessageUpdate`触发UI重新渲染

## 修改的文件

### `/toolwindow/src/main/kotlin/com/claudecodeplus/ui/services/MessageConverter.kt`
- 修改`extractToolCalls`方法，只处理`tool_use`事件
- 新增`extractToolResults`方法处理`tool_result`事件

### `/toolwindow/src/main/kotlin/com/claudecodeplus/ui/models/SessionObject.kt`  
- 新增工具结果事件检测逻辑
- 新增`updateToolCallResult`方法
- 改进消息合并逻辑

### `/toolwindow/src/main/kotlin/com/claudecodeplus/ui/jewel/JewelChatApp.kt`
- 修复工具调用消息被意外合并的问题

## 预期效果

修复后，用户应该能够看到：

1. **工具调用开始**: 显示工具名称、参数和"正在执行"状态
2. **工具执行结果**: 工具完成后显示成功/失败状态和结果
3. **完整交互流程**: 清晰展示AI如何使用工具解决问题

## 测试验证

使用测试命令验证修复效果：
```
@docs/日志系统说明.md 请阅读这个文档，并告诉我主要内容
```

应该能看到：
1. Read工具的调用过程
2. 文档内容的读取结果  
3. AI基于文档内容的回复

## 技术要点

### Claude CLI事件流理解
- 工具调用是异步过程，通过多个分离事件完成
- 必须通过工具ID关联工具调用和结果
- 不能假设所有信息都在单个事件中

### 状态管理
- 工具调用状态: RUNNING → SUCCESS/FAILED
- 消息更新触发: 通过`onMessageUpdate`通知UI
- 时间戳记录: 记录开始和结束时间

### UI展示
- 使用CompactToolCallDisplay组件
- 支持实时状态更新
- 保持工具调用的可见性

---

*报告生成时间: 2025-08-26*