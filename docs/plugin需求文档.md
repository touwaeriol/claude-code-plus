# Claude Code Plus IntelliJ 插件需求文档

## 1. 概述

Claude Code Plus 插件是集成到 JetBrains IDE 中的 AI 编程助手，通过 Claude CLI 与 AI 进行交互，提供一致的用户体验。插件充分利用 IDE 的上下文和功能，为开发者提供智能化的编程辅助。

## 2. 功能需求

### 2.1 UI 界面需求

#### 2.1.1 工具窗口
- **位置**：IDE 右侧边栏
- **图标**：Claude Code 自定义图标
- **标题**：Claude Code
- **集成**：使用 `toolwindow` 模块的核心组件

#### 2.1.2 聊天界面布局

```
+----------------------------------+
|          工具栏                   |
| [新会话] [清空] [日志] [导出]      |
| [显示工具调用: ✓]                 |
+----------------------------------+
|                                  |
|          消息显示区域              |
|    （Markdown 渲染）              |
|                                  |
|                                  |
+----------------------------------+
|          状态栏                   |
|  会话ID: xxx | 消息数: 12         |
+----------------------------------+
|          输入区域                 |
|  [输入框..................] [发送] |
+----------------------------------+
```

### 2.2 消息显示格式

#### 2.2.1 用户消息
- **复用输入框组件设计** - 使用与 ChatInputArea 相同的视觉设计和布局
- **只读显示模式** - 不可编辑，不可交互
- **显示内容**：
  - 用户实际输入的文本内容
  - 选择的上下文标签（文件、网页等）
  - 使用的AI模型（显示但不可切换）
- **隐藏元素**：
  - Add Context 按钮（用户已完成输入）
  - 发送按钮（消息已发送）

#### 2.2.2 助手消息  
- 直接显示在主背景上，无额外背景容器
- 无需显示发送者标识
- 通过背景色差异自然区分对话双方
- 保持良好的可读性和对比度

#### 2.2.3 工具调用消息
参见工具窗口需求文档中的工具调用展示优化部分。

### 2.3 IDE 集成功能

#### 2.3.1 编辑器集成
- **FR-2.1**：支持从编辑器选中代码并发送到聊天
- **FR-2.2**：支持将AI回复中的代码片段插入到编辑器
- **FR-2.3**：支持编辑器内的快速操作（Quick Actions）
- **FR-2.4**：支持光标位置的上下文感知

#### 2.3.2 项目集成
- **FR-2.5**：自动检测当前项目结构
- **FR-2.6**：利用IDE的文件索引进行快速搜索
- **FR-2.7**：集成版本控制系统信息（Git状态等）
- **FR-2.8**：支持项目级别的配置和设置

#### 2.3.3 调试集成
- **FR-2.9**：访问当前调试会话的变量和堆栈信息
- **FR-2.10**：支持断点位置的上下文分析
- **FR-2.11**：集成错误和警告信息

### 2.4 内联引用系统

#### 2.4.1 引用触发机制
- **触发符号**：`@`
- **触发条件**：
  - `@` 前面是空格、换行或字符串开头
  - `@` 后面不是已有的引用格式
  - 避免在现有引用中重复触发

#### 2.4.2 IDE特定引用类型
除了标准引用类型外，插件还支持：
- **符号引用**：`@symbol://ClassName.methodName`
- **断点引用**：`@breakpoint://file:line`
- **问题引用**：`@issue://ERROR/WARNING/line`

#### 2.4.3 上下文选择器增强
- 利用IDE的符号索引提供更快的搜索
- 支持按类型过滤（类、方法、变量等）
- 显示符号的额外信息（如参数类型、返回值）

### 2.5 工具栏功能

- **新会话按钮**：开始新的对话会话
- **清空按钮**：清空当前显示的所有消息
- **日志按钮**：在IDE中打开当前会话的日志文件
- **导出按钮**：将对话导出为 Markdown 文件
- **显示工具调用复选框**：控制是否显示工具调用信息

### 2.6 快捷键支持

- **Alt+C**：聚焦到Claude输入框
- **Ctrl+Shift+C**：发送选中代码到Claude
- **Ctrl+Alt+C**：打开/关闭Claude工具窗口
- **⌘K**（Mac）/ **Ctrl+K**（Win/Linux）：触发上下文选择器

## 3. 主题适配需求

### 3.1 颜色方案
- **自动适配**：根据 IDE 当前主题（Light/Dark）自动调整颜色
- **用户消息背景**：
  - Light 主题：使用 UIManager 的 TextField.background
  - Dark 主题：使用 UIManager 的 TextField.background
- **对话区域背景**：使用 Editor.background
- **文本颜色**：使用 Editor.foreground
- **边框颜色**：使用 Component.borderColor

### 3.2 获取主题信息
- 使用 `UIUtil.isUnderDarcula()` 判断是否为深色主题
- 使用 `UIManager.getColor()` 获取主题颜色
- 监听主题变化并实时更新界面

## 4. 非功能性需求

### 4.1 性能要求
- **NFR-1.1**：插件启动时间不应超过2秒
- **NFR-1.2**：不应显著影响IDE的整体性能
- **NFR-1.3**：文件索引应使用IDE现有的索引，避免重复扫描

### 4.2 兼容性要求
- **NFR-2.1**：支持 IntelliJ IDEA 2022.3 及以上版本
- **NFR-2.2**：兼容所有基于 IntelliJ Platform 的 IDE
- **NFR-2.3**：支持社区版和专业版

### 4.3 可靠性要求
- **NFR-3.1**：Claude CLI 进程崩溃时能够自动恢复
- **NFR-3.2**：网络断开时提供离线功能（如查看历史）
- **NFR-3.3**：异常情况下不应导致IDE崩溃

## 5. 交互细节

### 5.1 输入框设计
参见工具窗口需求文档中的 ChatInputArea 组件规范。

### 5.2 消息发送流程
1. 用户输入消息
2. 选择模型（可选，默认为 Opus）
3. 按 Enter 发送（无需点击按钮）
4. 立即在界面显示用户消息
5. 输入框清空，恢复占位符文本
6. 显示 Claude 正在输入的指示
7. 流式显示 Claude 的回复（包括工具调用）
8. 回复完成后输入框保持可用状态

### 5.3 模型选择逻辑
- **Claude 4 Opus**：传递参数 "opus"，由服务端映射到具体模型
- **Claude 4 Sonnet**：传递参数 "sonnet"，由服务端映射到具体模型

## 6. 扩展点

### 6.1 动作扩展
- 提供扩展点允许第三方插件添加自定义动作
- 支持自定义工具调用的展示方式
- 允许扩展内联引用类型

### 6.2 配置扩展
- 支持项目级别的 `.claude` 配置文件
- 提供配置UI供用户自定义行为
- 支持导入/导出配置