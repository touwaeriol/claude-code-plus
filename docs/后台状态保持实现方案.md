# 后台状态保持实现方案

## 概述

实现了 IntelliJ IDEA 插件在工具窗口切换时的状态保持功能，确保查询执行过程中切换到其他工具窗口后，再切换回来时能够无缝继续显示进度和状态。

## 核心架构

### 1. 三层架构设计

```
┌─────────────────────────────────────────────┐
│              UI 层 (ChatViewNew)             │
│  - 显示消息和状态                            │
│  - 响应用户输入                              │
│  - 监听状态变化                              │
└─────────────────────────────────────────────┘
                       ↕
┌─────────────────────────────────────────────┐
│        状态同步层 (SessionStateSync)         │
│  - UI 和后台服务之间的桥梁                   │
│  - 状态转换和同步                            │
└─────────────────────────────────────────────┘
                       ↕
┌─────────────────────────────────────────────┐
│   后台服务层 (ClaudeCodePlusBackgroundService) │
│  - 应用级服务（生命周期独立于工具窗口）        │
│  - 管理所有会话状态（内存中）                  │
│  - 执行 Claude CLI 进程                       │
└─────────────────────────────────────────────┘
```

### 2. 关键组件

#### ClaudeCodePlusBackgroundService（应用级服务）
- **生命周期**：应用启动时创建，应用关闭时销毁
- **职责**：
  - 管理所有活跃的 Claude CLI 进程
  - 在内存中维护会话状态
  - 提供状态观察 Flow
  - 处理 CLI 输出并更新状态

#### ClaudeToolWindowListener（工具窗口监听器）
- **职责**：
  - 监听工具窗口的显示/隐藏事件
  - 记录活跃会话 ID
  - 触发状态恢复
  - 通知 UI 刷新

#### SessionStateSyncImpl（状态同步器）
- **职责**：
  - 封装后台服务调用
  - 提供统一的状态管理 API
  - 处理状态转换

## 实现细节

### 1. 工具窗口事件监听

```kotlin
// 使用 IntelliJ Platform 的消息总线机制
project.messageBus.connect().subscribe(
    ToolWindowManagerListener.TOPIC,
    toolWindowListener
)
```

### 2. 状态管理策略

#### 内存优先原则
- **运行时**：所有状态都保存在内存中
- **会话文件**：只在启动/恢复时读取一次
- **不监听文件变化**：避免性能开销和复杂性

#### 状态同步流程
1. **工具窗口隐藏时**：
   - 记录当前活跃的会话 ID
   - 状态继续在后台服务中维护
   - CLI 进程继续执行

2. **工具窗口显示时**：
   - 从后台服务恢复状态
   - 更新 UI 显示最新消息
   - 如果进程仍在执行，继续显示进度

### 3. 会话状态数据结构

```kotlin
data class SessionState(
    val sessionId: String,
    val projectPath: String,
    val messages: MutableList<EnhancedMessage>,
    val isGenerating: Boolean,
    val lastActivity: Long,
    val errorMessage: String?,
    val processId: Long?,
    val currentStreamingText: StringBuilder
)
```

### 4. UI 集成

ChatViewNew 组件通过以下方式与后台服务集成：

1. **状态监听**：
```kotlin
LaunchedEffect(sessionStateSync, sessionObject.sessionId) {
    // 监听后台服务的状态更新
    observeSessionState()
}
```

2. **工具窗口状态监听**：
```kotlin
DisposableEffect(sessionStateSync) {
    // 注册工具窗口状态变化监听
    registerToolWindowListener()
}
```

## 优势

1. **无缝体验**：用户切换工具窗口时不会丢失状态
2. **后台执行**：查询在后台继续执行，不受 UI 影响
3. **资源效率**：使用内存管理，避免频繁文件 I/O
4. **可扩展性**：支持多项目、多会话并发管理

## 注意事项

1. **内存管理**：定期清理过期会话（24小时未活动）
2. **错误处理**：优雅处理后台服务异常，提供回退机制
3. **性能优化**：使用 Flow 进行响应式状态更新，避免轮询

## 测试建议

1. 启动一个长时间运行的查询
2. 在查询执行过程中切换到其他工具窗口
3. 等待一段时间后切换回 Claude Code Plus
4. 验证：
   - 输入框内容保持不变
   - 对话历史完整显示
   - 如果查询仍在执行，能看到最新进度
   - 如果查询已完成，能看到完整结果

## 未来改进

1. **持久化支持**：可选的会话状态持久化到磁盘
2. **状态压缩**：对大量历史消息进行压缩存储
3. **智能预加载**：根据用户习惯预加载常用会话