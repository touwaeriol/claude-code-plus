# Claude Code Plus 需求文档

## 1. 项目概述

Claude Code Plus 是一个 IntelliJ IDEA 插件，提供类似 JetBrains AI Assistant 的聊天界面，用于与 Claude SDK 进行交互。

## 2. UI 界面需求

### 2.1 工具窗口
- **位置**：IDE 右侧边栏
- **图标**：Claude Code 自定义图标
- **标题**：Claude Code

### 2.2 聊天界面布局

```
+----------------------------------+
|          工具栏                   |
| [新会话] [清空] [日志] [导出]      |
| [显示工具调用: ✓]                 |
+----------------------------------+
|                                  |
|          消息显示区域              |
|    （Markdown 渲染）              |
|                                  |
|                                  |
+----------------------------------+
|          状态栏                   |
|  会话ID: xxx | 消息数: 12         |
+----------------------------------+
|          输入区域                 |
|  [输入框..................] [发送] |
+----------------------------------+
```

### 2.3 消息显示格式

#### 用户消息
- **复用输入框组件设计** - 使用与 ChatInputArea 相同的视觉设计和布局
- **只读显示模式** - 不可编辑，不可交互
- **显示内容**：
  - 用户实际输入的文本内容
  - 选择的上下文标签（文件、网页等）
  - 使用的AI模型（显示但不可切换）
- **隐藏元素**：
  - Add Context 按钮（用户已完成输入）
  - 发送按钮（消息已发送）
- **保持一致性**：
  - 统一的边框和背景设计
  - 相同的间距和字体规范
  - 与输入框相同的视觉层次结构

#### 助手消息  
- 直接显示在主背景上，无额外背景容器
- 无需显示发送者标识
- 通过背景色差异自然区分对话双方
- 保持良好的可读性和对比度

#### 处理状态
- 在助手回复区域显示"Generating..."文本
- 提供"Stop"按钮允许中断生成
- 生成完成后自动隐藏状态提示

#### 工具调用消息（紧凑模式）
```markdown
🔧 **工具调用**: `read_file` ➡️ `MainActivity.kt` [查看详情]
```

#### 工具调用消息（展开模式）
```markdown
🔧 **工具调用**: read_file
参数: 
```json
{
  "path": "/src/MainActivity.kt",
  "line_start": 1,
  "line_end": 50
}
```
📋 **结果**: 50 行代码已读取
```

#### 系统消息
- 不显示发送者标识
- 直接显示内容
- 用于欢迎消息、状态提示等

#### 错误消息
```markdown
### ❌ Error

> 错误信息内容

---
```

## 3. 功能需求

### 3.0 工具消息显示控制
- **显示开关**：工具栏中提供“显示工具调用”复选框
- **显示模式**：
  - 隐藏：完全不显示工具调用信息
  - 紧凑：单行显示工具名称和关键参数
  - 展开：显示完整的工具调用参数和结果
- **交互设计**：
  - 紧凑模式下，点击“[查看详情]”可以展开单个工具调用
  - 展开后可以点击“[收起]”恢复紧凑显示
  - 工具结果过长时自动折叠，显示前100字符和“...”

### 3.1 基础聊天功能
- **发送消息**：用户在输入框输入内容，按 Enter 或点击发送按钮
- **接收回复**：实时显示 Claude 的流式响应
- **消息历史**：保持对话上下文，支持滚动查看历史消息

### 3.2 会话管理
- **新会话**：清空当前对话，开始新的会话
- **会话持续**：在同一会话中保持上下文
- **首条消息**：第一条消息自动使用新会话，避免继承问题会话

### 3.3 工具栏功能
- **新会话按钮**：开始新的对话会话
- **清空按钮**：清空当前显示的所有消息
- **日志按钮**：显示当前会话的日志文件位置
- **导出按钮**：将对话导出为 Markdown 文件
- **显示工具调用复选框**：控制是否显示工具调用信息

### 3.4 状态栏功能
- **会话ID显示**：显示当前会话的唯一标识
- **消息计数**：显示当前会话中的消息数量
- **连接状态**：显示与 Claude SDK 的连接状态（可选）

## 4. 上下文引用功能

### 4.1 文件引用触发
- **触发符号**：`@`
- **触发条件**：
  - `@` 前后是空格、或者没有字符
  - 例如：`请查看 @MainActivity.kt 文件`

### 4.2 自动补全
- **搜索范围**：项目内所有文件
- **搜索策略**：
  1. 精确文件名匹配（优先级最高）
  2. 文件名包含搜索词
  3. 路径包含搜索词
- **结果限制**：最多显示 30 个结果
- **显示格式**：`文件名 - 相对路径`

### 4.3 文件引用格式

#### 输入格式
```
@文件名
@src/main/kotlin/Example.kt
@/absolute/path/to/file.txt
```

#### 发送后的处理
1. **提取文件引用**：识别消息中所有 `@文件路径` 格式的引用
2. **解析文件路径**：
   - 相对路径：基于项目根目录解析
   - 绝对路径：直接使用
   - 仅文件名：在项目中搜索匹配的文件
3. **读取文件内容**：自动读取被引用文件的内容
4. **构建增强消息**：将文件内容作为上下文附加到用户消息

### 4.4 显示效果

#### 用户消息中的显示
```markdown
### 👤 You

请帮我分析 [@MainActivity.kt](file:///path/to/MainActivity.kt) 中的代码

---
```

- 文件引用显示为**可点击的超链接**
- 点击链接在 IDE 中打开对应文件
- 鼠标悬停显示完整文件路径

#### 助手回复中的文件引用
- 如果 Claude 在回复中提到文件路径，自动转换为可点击链接
- 支持识别常见的文件路径格式

### 4.5 文件内容附加格式

发送给 Claude 的实际消息格式：
```
用户消息内容

<file path="/path/to/MainActivity.kt">
文件内容...
</file>
```

## 5. 主题适配需求

### 5.1 颜色方案
- **自动适配**：根据 IDE 当前主题（Light/Dark）自动调整颜色
- **用户消息背景**：
  - Light 主题：浅灰色 (#F5F5F5 或 UIManager 的 TextField.background)
  - Dark 主题：深灰色 (#2B2B2B 或 UIManager 的 TextField.background)
- **对话区域背景**：使用 Editor.background
- **文本颜色**：使用 Editor.foreground
- **边框颜色**：使用 Component.borderColor

### 5.2 获取主题信息
- 使用 `UIUtil.isUnderDarcula()` 判断是否为深色主题
- 使用 `UIManager.getColor()` 获取主题颜色
- 监听主题变化并实时更新界面

## 6. Markdown 渲染需求

### 6.1 支持的 Markdown 特性
- 标题（# ## ### 等）
- 粗体、斜体、删除线
- 代码块（支持语法高亮）
- 行内代码
- 列表（有序和无序）
- 引用块
- 表格
- 链接
- 图片（如果支持）

### 5.2 代码块渲染
```kotlin
// 代码块应该有语法高亮
fun main() {
    println("Hello World")
}
```

### 6.3 自定义样式
- 字体：系统默认字体
- 代码块背景：根据主题自适应
- 代码块内边距：10px
- 链接颜色：IDE 主题的链接颜色

## 6. 交互细节

### 6.1 输入框设计（ChatInputArea 组件）

#### 布局结构
```
┌─ 统一边框 ────────────────────────────────────────────┐
│ 📎 Add Context [上下文标签1] [上下文标签2] ...         │
│ ────────────────────────────────────────────────    │
│ 输入消息，使用 @ 内联引用文件，或 ⌘K 添加上下文...      │
│                                                    │
│ ────────────────────────────────────────────────    │
│ Claude 4 Opus ▼                              ↑    │
└────────────────────────────────────────────────────┘
```

#### 组件封装要求
- **统一组件**：所有输入相关功能封装在 `ChatInputArea` 组件中
- **功能完整性**：包含输入框、发送按钮、模型选择器、上下文选择等所有功能
- **避免功能丢失**：组件化后确保不会再出现按钮消失等问题

#### 视觉设计规范
- **统一边框**：整个输入区域使用一个统一的边框
- **无内嵌边框**：输入框内部不使用嵌套边框，保持简洁
- **同背景设计**：Add Context 按钮与输入框使用相同背景色
- **紧凑布局**：组件间距紧凑，提高空间利用率

#### 第一行布局（上下文行）
- **Add Context 按钮**：
  - 位置：行首
  - 背景：与整体输入框相同背景色（`JewelTheme.globalColors.panelBackground`）
  - 圆角：4dp
  - 高度：24dp
  - 字体大小：10sp
  - 内边距：horizontal 6dp, vertical 2dp
  - 点击行为：触发上下文选择器
- **上下文标签**：
  - 位置：Add Context 按钮右侧
  - 显示：水平滚动列表（LazyRow）
  - 间距：4dp
  - 支持删除操作
- **提示文字**：已移除，保持界面简洁

#### 输入框区域
- **多行支持**：最小高度 32dp，最大高度 120dp
- **占位符文本**："输入消息，使用 @ 内联引用文件，或 ⌘K 添加上下文..."
- **字体大小**：14sp
- **内边距**：4dp
- **无边框**：输入框本身无边框，依赖外层统一边框

#### 底部控制栏
- **左侧**：模型选择器
  - 样式：小巧无背景设计
  - 高度：24dp
  - 字体大小：9sp
  - 下拉箭头：7sp
  - 透明背景，与主题融合
- **右侧**：发送/停止按钮
  - 尺寸：24dp × 24dp
  - 图标大小：10sp
  - 状态切换：发送（↑）/ 停止（⏹）
  - 智能启用：根据输入内容和生成状态

#### 功能特性
- **快捷键支持**：
  - Enter：发送消息
  - Shift+Enter：换行
  - @：触发内联文件引用
  - ⌘K：触发上下文选择器
  - ESC：关闭上下文选择器
- **上下文管理**：
  - 三种添加方式：按钮点击、@符号、⌘K快捷键
  - 标签式显示：可视化上下文列表
  - 内联引用：@符号直接在文本中插入文件引用
- **状态管理**：
  - 生成中禁用输入和模型选择
  - 智能按钮切换（发送/停止）
  - 实时同步外部状态

#### 交互设计原则
- **Cursor 风格**：参考 Cursor 编辑器的设计理念
- **现代化体验**：符合主流聊天应用的交互习惯
- **键盘友好**：支持完整的键盘操作
- **响应式设计**：组件状态实时响应用户操作

### 6.2 消息发送流程
1. 用户输入消息
2. 选择模型（可选，默认为 Opus）
3. 按 Enter 发送（无需点击按钮）
4. 立即在界面显示用户消息
5. 输入框清空，恢复占位符文本
6. 显示 Claude 正在输入的指示
7. 流式显示 Claude 的回复（包括工具调用）
8. 回复完成后输入框保持可用状态

### 6.3 模型选择逻辑
- **Claude 4 Opus**：传递参数 "opus"，由服务端映射到具体模型
- **Claude 4 Sonnet**：传递参数 "sonnet"，由服务端映射到具体模型