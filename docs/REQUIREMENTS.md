# Claude Code Plus 需求文档

## 1. 项目概述

Claude Code Plus 是一个 IntelliJ IDEA 插件，提供类似 JetBrains AI Assistant 的聊天界面，用于与 Claude SDK 进行交互。

## 2. UI 界面需求

### 2.1 工具窗口
- **位置**：IDE 右侧边栏
- **图标**：Claude Code 自定义图标
- **标题**：Claude Code

### 2.2 聊天界面布局

```
+----------------------------------+
|          工具栏                   |
| [新会话] [清空] [日志] [导出]      |
+----------------------------------+
|                                  |
|          消息显示区域              |
|    （Markdown 渲染）              |
|                                  |
|                                  |
+----------------------------------+
|          输入区域                 |
|  [输入框..................] [发送] |
+----------------------------------+
```

### 2.3 消息显示格式

#### 用户消息
```markdown
### 👤 You

用户输入的内容

---
```

#### 助手消息
```markdown
### 🤖 Claude

助手的回复内容，支持完整的 Markdown 语法

---
```

#### 系统消息
- 不显示发送者标识
- 直接显示内容
- 用于欢迎消息、状态提示等

#### 错误消息
```markdown
### ❌ Error

> 错误信息内容

---
```

## 3. 功能需求

### 3.1 基础聊天功能
- **发送消息**：用户在输入框输入内容，按 Enter 或点击发送按钮
- **接收回复**：实时显示 Claude 的流式响应
- **消息历史**：保持对话上下文，支持滚动查看历史消息

### 3.2 会话管理
- **新会话**：清空当前对话，开始新的会话
- **会话持续**：在同一会话中保持上下文
- **首条消息**：第一条消息自动使用新会话，避免继承问题会话

### 3.3 工具栏功能
- **新会话按钮**：开始新的对话会话
- **清空按钮**：清空当前显示的所有消息
- **日志按钮**：显示当前会话的日志文件位置
- **导出按钮**：将对话导出为 Markdown 文件

## 4. 上下文引用功能

### 4.1 文件引用触发
- **触发符号**：`@`
- **触发条件**：
  - `@` 是输入的第一个字符
  - `@` 前面是空格、换行或制表符
  - 例如：`请查看 @MainActivity.kt 文件`

### 4.2 自动补全
- **搜索范围**：项目内所有文件
- **搜索策略**：
  1. 精确文件名匹配（优先级最高）
  2. 文件名包含搜索词
  3. 路径包含搜索词
- **结果限制**：最多显示 30 个结果
- **显示格式**：`文件名 - 相对路径`

### 4.3 文件引用格式

#### 输入格式
```
@文件名
@src/main/kotlin/Example.kt
@/absolute/path/to/file.txt
```

#### 发送后的处理
1. **提取文件引用**：识别消息中所有 `@文件路径` 格式的引用
2. **解析文件路径**：
   - 相对路径：基于项目根目录解析
   - 绝对路径：直接使用
   - 仅文件名：在项目中搜索匹配的文件
3. **读取文件内容**：自动读取被引用文件的内容
4. **构建增强消息**：将文件内容作为上下文附加到用户消息

### 4.4 显示效果

#### 用户消息中的显示
```markdown
### 👤 You

请帮我分析 [@MainActivity.kt](file:///path/to/MainActivity.kt) 中的代码

---
```

- 文件引用显示为**可点击的超链接**
- 点击链接在 IDE 中打开对应文件
- 鼠标悬停显示完整文件路径

#### 助手回复中的文件引用
- 如果 Claude 在回复中提到文件路径，自动转换为可点击链接
- 支持识别常见的文件路径格式

### 4.5 文件内容附加格式

发送给 Claude 的实际消息格式：
```
用户消息内容

<file path="/path/to/MainActivity.kt">
文件内容...
</file>
```

## 5. Markdown 渲染需求

### 5.1 支持的 Markdown 特性
- 标题（# ## ### 等）
- 粗体、斜体、删除线
- 代码块（支持语法高亮）
- 行内代码
- 列表（有序和无序）
- 引用块
- 表格
- 链接
- 图片（如果支持）

### 5.2 代码块渲染
```kotlin
// 代码块应该有语法高亮
fun main() {
    println("Hello World")
}
```

### 5.3 自定义样式
- 字体：系统默认字体
- 代码块背景：浅灰色 (#f5f5f5)
- 代码块内边距：10px
- 链接颜色：IDE 主题的链接颜色

## 6. 交互细节

### 6.1 输入框
- 单行输入
- 支持粘贴多行文本
- Enter 发送，Shift+Enter 换行（如果支持多行）
- 发送后自动清空

### 6.2 消息发送流程
1. 用户输入消息
2. 按 Enter 或点击发送
3. 立即在界面显示用户消息
4. 输入框清空并禁用
5. 显示 Claude 正在输入的指示（可选）
6. 流式显示 Claude 的回复
7. 回复完成后重新启用输入框

### 6.3 错误处理
- 连接失败：显示错误消息
- 超时：显示超时提示
- API 错误：显示具体错误信息

## 7. 性能要求

### 7.1 响应速度
- 消息发送：立即响应
- UI 更新：流畅无卡顿
- 文件搜索：< 200ms

### 7.2 资源使用
- 内存：合理使用，避免内存泄漏
- CPU：避免阻塞 UI 线程

## 8. 未来扩展

### 8.1 高级文件引用
- 支持引用特定行号：`@file.kt:10-20`
- 支持引用函数/类：`@MainActivity#onCreate`
- 支持引用多个文件

### 8.2 上下文增强
- 自动包含当前打开的文件
- 自动包含最近修改的文件
- 项目结构上下文

### 8.3 UI 增强
- 深色/浅色主题支持
- 字体大小调整
- 消息复制/分享功能
- 代码块一键复制

### 8.4 集成功能
- 与 IDE 的 diff 视图集成
- 与版本控制系统集成
- 快速修复建议应用