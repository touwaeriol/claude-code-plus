# å·¥å…·è°ƒç”¨äº‹ä»¶æµç¨‹è¯¦è§£

## å®Œæ•´çš„å·¥å…·è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ

å½“ç”¨æˆ·å‘é€æ¶ˆæ¯"@docs/æ—¥å¿—ç³»ç»Ÿè¯´æ˜.md è¯·é˜…è¯»è¿™ä¸ªæ–‡æ¡£"æ—¶ï¼ŒClaude CLIä¼šäº§ç”Ÿä»¥ä¸‹3ä¸ªåˆ†ç¦»çš„äº‹ä»¶ï¼š

### 1. å·¥å…·è°ƒç”¨äº‹ä»¶ (tool_use)
```json
{
  "type": "assistant",
  "message": {
    "content": [
      {
        "type": "tool_use",
        "id": "toolu_01ABC123",
        "name": "Read",
        "input": {
          "file_path": "/path/to/docs/æ—¥å¿—ç³»ç»Ÿè¯´æ˜.md"
        }
      }
    ]
  }
}
```

**å¤„ç†é€»è¾‘**:
- MessageConverter.extractToolCalls() è§£ææ­¤äº‹ä»¶
- åˆ›å»ºçŠ¶æ€ä¸º `RUNNING` çš„ ToolCall å¯¹è±¡
- UIæ˜¾ç¤ºï¼šğŸ”§ Read (æ­£åœ¨æ‰§è¡Œ...)

### 2. å·¥å…·ç»“æœäº‹ä»¶ (tool_result)  
```json
{
  "type": "user", 
  "message": {
    "content": [
      {
        "type": "tool_result",
        "tool_use_id": "toolu_01ABC123",
        "content": "# æ—¥å¿—ç³»ç»Ÿè¯´æ˜\n\næœ¬é¡¹ç›®ä½¿ç”¨ Logback ä½œä¸ºæ—¥å¿—æ¡†æ¶..."
      }
    ]
  }
}
```

**å¤„ç†é€»è¾‘**:
- SessionObject æ£€æµ‹åˆ° tool_result äº‹ä»¶
- é€šè¿‡ tool_use_id æ‰¾åˆ°å¯¹åº”çš„å·¥å…·è°ƒç”¨
- æ›´æ–°å·¥å…·è°ƒç”¨çŠ¶æ€ä¸º `SUCCESS`ï¼Œæ·»åŠ ç»“æœå†…å®¹
- UIæ˜¾ç¤ºï¼šâœ… Read (å·²å®Œæˆ) + ç»“æœé¢„è§ˆ

### 3. æœ€ç»ˆå›å¤äº‹ä»¶ (text)
```json
{
  "type": "assistant",
  "message": {
    "content": [
      {
        "type": "text", 
        "text": "æ ¹æ®æ–‡æ¡£å†…å®¹ï¼Œè¿™ä¸ªé¡¹ç›®çš„æ—¥å¿—ç³»ç»Ÿä¸»è¦ç‰¹ç‚¹æ˜¯..."
      }
    ]
  }
}
```

**å¤„ç†é€»è¾‘**:
- æ­£å¸¸çš„åŠ©æ‰‹æ¶ˆæ¯å¤„ç†
- UIæ˜¾ç¤ºï¼šAIçš„æ–‡æœ¬å›å¤

## å…³é”®å®ç°ç»†èŠ‚

### SessionObjectä¸­çš„äº‹ä»¶åˆ†ç¦»å¤„ç†

```kotlin
// 1. æ£€æµ‹tool_resultäº‹ä»¶å¹¶æ›´æ–°å·¥å…·è°ƒç”¨çŠ¶æ€
if (messageType == "user") {
    contentArray?.forEach { contentElement ->
        val type = contentObj["type"]?.jsonPrimitive?.content
        if (type == "tool_result") {
            val toolUseId = contentObj["tool_use_id"]?.jsonPrimitive?.content ?: ""
            val result = ToolResult.Success(resultContent)
            updateToolCallResult(toolUseId, result) // å…³é”®ï¼šé€šè¿‡IDå…³è”
        }
    }
    return // é‡è¦ï¼šä¸åˆ›å»ºæ–°æ¶ˆæ¯ï¼Œåªæ›´æ–°ç°æœ‰å·¥å…·è°ƒç”¨
}

// 2. å¤„ç†tool_useäº‹ä»¶ï¼Œåˆ›å»ºæ–°çš„å·¥å…·è°ƒç”¨
val enhancedMessage = parseClaudeCliMessage(jsonObject, jsonLine)
if (enhancedMessage.toolCalls.isNotEmpty()) {
    addMessage(enhancedMessage) // åˆ›å»ºåŒ…å«å·¥å…·è°ƒç”¨çš„æ–°æ¶ˆæ¯
}
```

### çŠ¶æ€è½¬æ¢æµç¨‹

```
åˆå§‹çŠ¶æ€: æ— å·¥å…·è°ƒç”¨
    â†“
tool_useäº‹ä»¶: åˆ›å»º ToolCall(status=RUNNING)
    â†“  
tool_resultäº‹ä»¶: æ›´æ–° ToolCall(status=SUCCESS/FAILED, result=...)
    â†“
textäº‹ä»¶: AIå›å¤ï¼ˆå·¥å…·è°ƒç”¨ä¿æŒå®ŒæˆçŠ¶æ€ï¼‰
```

## UIå±•ç¤ºæ•ˆæœ

### æ—¶åºå±•ç¤º
1. **ç¬¬1ç§’**: æ˜¾ç¤º "ğŸ”§ Read (æ­£åœ¨è¯»å–æ–‡ä»¶...)"
2. **ç¬¬3ç§’**: æ›´æ–°ä¸º "âœ… Read (å·²å®Œæˆ)" + ç»“æœæ‘˜è¦  
3. **ç¬¬5ç§’**: æ˜¾ç¤ºAIåŸºäºæ–‡ä»¶å†…å®¹çš„å›å¤

### å®Œæ•´çš„å·¥å…·è°ƒç”¨ä¿¡æ¯
- å·¥å…·åç§°: Read
- å‚æ•°: file_path="/path/to/file"
- çŠ¶æ€: RUNNING â†’ SUCCESS
- æ‰§è¡Œæ—¶é—´: 2.1s
- ç»“æœé¢„è§ˆ: "# æ—¥å¿—ç³»ç»Ÿè¯´æ˜\næœ¬é¡¹ç›®ä½¿ç”¨..."

## ä¸åŸæœ‰é”™è¯¯å®ç°çš„å¯¹æ¯”

### âŒ é”™è¯¯å®ç°
- åªå¤„ç† tool_use äº‹ä»¶ï¼Œå¿½ç•¥ tool_result
- å·¥å…·è°ƒç”¨æ°¸è¿œæ˜¾ç¤ºä¸º "æ­£åœ¨æ‰§è¡Œ"
- ç”¨æˆ·æ— æ³•çœ‹åˆ°å·¥å…·æ‰§è¡Œç»“æœ
- ç¼ºå°‘å®Œæ•´çš„å·¥å…·è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ

### âœ… æ­£ç¡®å®ç°  
- åˆ†åˆ«å¤„ç† tool_use å’Œ tool_result äº‹ä»¶
- é€šè¿‡ tool_use_id æ­£ç¡®å…³è”å·¥å…·è°ƒç”¨å’Œç»“æœ
- å®æ—¶æ›´æ–°å·¥å…·è°ƒç”¨çŠ¶æ€å’Œç»“æœ
- æä¾›å®Œæ•´çš„å·¥å…·æ‰§è¡Œå¯è§†åŒ–

## æµ‹è¯•éªŒè¯

ä½¿ç”¨æµ‹è¯•å‘½ä»¤éªŒè¯å®Œæ•´æµç¨‹:
```
@docs/æ—¥å¿—ç³»ç»Ÿè¯´æ˜.md è¯·å‘Šè¯‰æˆ‘è¿™ä¸ªæ–‡æ¡£çš„ä¸»è¦å†…å®¹
```

æœŸæœ›çœ‹åˆ°ï¼š
1. Readå·¥å…·è°ƒç”¨å¼€å§‹ (RUNNINGçŠ¶æ€)
2. Readå·¥å…·æ‰§è¡Œå®Œæˆ (SUCCESSçŠ¶æ€ + æ–‡ä»¶å†…å®¹)
3. AIåŸºäºæ–‡ä»¶å†…å®¹çš„æ™ºèƒ½å›å¤

---

*æ›´æ–°æ—¶é—´: 2025-08-26*