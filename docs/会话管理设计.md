# Claude Code Plus 会话管理设计文档

## 1. Claude Code 会话机制分析

### 1.1 会话存储
- **存储位置**: `~/.claude/projects/[encoded-project-path]/`
- **文件格式**: JSONL (JSON Lines)，每行一个 JSON 对象
- **文件命名**: UUID 格式，如 `161f9378-8799-4c13-b7fb-1287c5b7d627.jsonl`

### 1.2 会话数据结构
```json
{
  "sessionId": "UUID",          // 会话标识符
  "uuid": "UUID",               // 消息唯一标识
  "parentUuid": "UUID|null",    // 父消息ID（形成对话链）
  "type": "user|assistant",     // 消息类型
  "timestamp": "ISO8601",       // 时间戳
  "message": {                  // 消息内容
    "role": "user|assistant",
    "content": "...",
    "id": "msg_xxx",           // assistant 消息特有
    "model": "claude-xxx",     // assistant 消息特有
    "usage": {...}             // token 使用情况
  },
  "cwd": "/path/to/project",    // 工作目录
  "version": "1.0.38",          // Claude版本
  "isSidechain": false,         // 是否为侧链
  "userType": "external"        // 用户类型
}
```

### 1.3 会话命令
- `claude`: 创建新会话
- `claude -c`: 继续最近的会话
- `claude -r [sessionId]`: 恢复指定会话（交互式选择）
- `claude -p -r <sessionId>`: 非交互式恢复会话

## 2. 插件会话管理设计

### 2.1 核心功能
1. **会话列表管理**
   - 读取项目会话目录
   - 解析 JSONL 文件
   - 按时间排序展示

2. **会话状态维护**
   - 当前会话 ID
   - 会话消息链
   - 上下文管理

3. **会话切换**
   - 新建会话
   - 继续会话
   - 恢复历史会话

### 2.2 数据模型

```kotlin
// 会话信息
data class SessionInfo(
    val sessionId: String,
    val filePath: String,
    val lastModified: Long,
    val messageCount: Int,
    val firstMessage: String?,
    val lastMessage: String?
)

// 会话消息
data class SessionMessage(
    val uuid: String,
    val parentUuid: String?,
    val sessionId: String,
    val type: String,
    val timestamp: String,
    val message: MessageContent,
    val cwd: String,
    val version: String
)

// 消息内容
data class MessageContent(
    val role: String,
    val content: Any, // String 或 List<ContentPart>
    val id: String? = null,
    val model: String? = null,
    val usage: UsageInfo? = null
)

// 会话管理器
interface SessionManager {
    // 获取项目会话列表
    fun getSessionList(projectPath: String): List<SessionInfo>
    
    // 读取会话消息
    fun readSession(sessionId: String): List<SessionMessage>
    
    // 创建新会话
    fun createSession(projectPath: String): String
    
    // 添加消息到会话
    fun addMessage(sessionId: String, message: SessionMessage)
    
    // 获取最近会话
    fun getRecentSession(projectPath: String): SessionInfo?
    
    // 获取会话文件路径
    fun getSessionFilePath(projectPath: String, sessionId: String): String
}
```

### 2.3 UI 组件设计

```kotlin
// 会话历史面板
@Composable
fun SessionHistoryPanel(
    sessions: List<SessionInfo>,
    currentSessionId: String?,
    onSessionSelect: (SessionInfo) -> Unit,
    onNewSession: () -> Unit,
    onDeleteSession: (SessionInfo) -> Unit
) {
    // 工具栏
    Row {
        DefaultButton(onClick = onNewSession) { 
            Text("新建会话") 
        }
        Spacer(Modifier.weight(1f))
        // 搜索框
        TextField(...)
    }
    
    // 会话列表
    LazyColumn {
        items(sessions) { session ->
            SessionItem(
                session = session,
                isSelected = session.sessionId == currentSessionId,
                onClick = { onSessionSelect(session) },
                onDelete = { onDeleteSession(session) }
            )
        }
    }
}

// 会话项
@Composable
fun SessionItem(
    session: SessionInfo,
    isSelected: Boolean,
    onClick: () -> Unit,
    onDelete: () -> Unit
) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .clickable { onClick() }
            .background(if (isSelected) JewelTheme.globalColors.selectionActive else Color.Transparent)
            .padding(8.dp)
    ) {
        Column(modifier = Modifier.weight(1f)) {
            // 第一条消息预览
            Text(
                text = session.firstMessage ?: "新会话",
                style = JewelTheme.defaultTextStyle,
                maxLines = 1,
                overflow = TextOverflow.Ellipsis
            )
            // 时间和消息数
            Text(
                text = "${formatTime(session.lastModified)} · ${session.messageCount} 条消息",
                style = JewelTheme.defaultTextStyle.copy(
                    color = JewelTheme.globalColors.text.disabled
                ),
                fontSize = 12.sp
            )
        }
        // 删除按钮
        IconButton(onClick = onDelete) {
            Icon(Icons.Default.Delete, contentDescription = "删除")
        }
    }
}
```

### 2.4 与 Claude CLI 集成

```kotlin
class ClaudeCliSessionIntegration(
    private val sessionManager: SessionManager,
    private val claudeSdk: ClaudeSdk
) {
    // 继续会话（-c 参数）
    fun continueSession(projectPath: String): String? {
        val recentSession = sessionManager.getRecentSession(projectPath)
        return recentSession?.sessionId
    }
    
    // 恢复会话（-r 参数）
    fun resumeSession(sessionId: String): List<SessionMessage> {
        return sessionManager.readSession(sessionId)
    }
    
    // 同步会话到文件
    fun syncSessionToFile(sessionId: String, messages: List<EnhancedMessage>) {
        messages.forEach { message ->
            val sessionMessage = convertToSessionMessage(message, sessionId)
            sessionManager.addMessage(sessionId, sessionMessage)
        }
    }
}
```

### 2.5 历史会话加载流程

历史会话加载采用流式处理，通过 SessionLoader 组件实现：

```kotlin
// SessionLoader 支持两种模式
class SessionLoader(
    private val sessionHistoryService: SessionHistoryService,
    private val messageProcessor: MessageProcessor,
    private val isHistoryMode: Boolean = true  // 默认为历史模式
)
```

#### 消息流处理顺序
Claude CLI 的消息流顺序：
1. START（用户/助手消息开始）
2. TEXT/TOOL_USE（内容块）
3. END（消息结束）
4. TOOL_RESULT（工具执行结果）

#### 历史模式特点
- **不清理状态**：END消息时保持currentAssistantMessage和toolCalls
- **延迟完成**：在流结束时才完成最后的助手消息
- **支持乱序**：工具结果可以在END消息之后到达并正确关联

### 2.6 实现计划

1. **第一阶段：基础功能** ✅
   - 实现 SessionManager 接口
   - 读取和解析会话文件
   - 会话列表展示

2. **第二阶段：会话管理** ✅
   - 新建、切换、删除会话
   - 会话消息同步
   - 与现有聊天界面集成
   - 支持历史会话加载（含工具调用结果）

3. **第三阶段：高级功能**
   - 会话搜索和过滤
   - 会话导出/导入
   - 会话分组管理
   - 跨项目会话管理

## 3. 技术考虑

### 3.1 性能优化
- 使用懒加载读取会话文件
- 缓存已读取的会话数据
- 异步加载会话列表

### 3.2 兼容性
- 保持与 Claude CLI 的会话格式一致
- 支持读取和写入标准 JSONL 格式
- 处理不同版本的会话格式

### 3.3 错误处理
- 处理损坏的会话文件
- 处理权限问题
- 处理并发访问

## 4. 总结

通过实现上述会话管理功能，Claude Code Plus 插件将能够：
- 提供与 Claude CLI 一致的会话体验
- 支持会话的持久化和恢复
- 提供更好的会话历史管理界面
- 实现与 CLI 的无缝切换