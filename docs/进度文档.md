# 进度文档

## 项目架构与核心功能

### Claude CLI 集成
- **流式响应支持**：实现实时流式 JSON 响应处理
- **权限模式**：默认使用 `default` 模式，允许所有操作
- **版本验证**：支持 Claude CLI 1.0.31+ 版本

### 会话管理系统
- **会话持久化**：基于 Claude CLI 原生会话管理，使用 `--resume` 参数
- **历史记录**：启动时自动加载 JSONL 格式的会话历史
- **会话隔离**：支持新建会话和继续对话，与命令行工具共享会话
- **路径转换**：使用 ProjectPathUtils 处理项目路径格式转换

### UI交互优化
- **响应打断**：支持停止按钮和 ESC 键中断流式响应
- **文件引用**：`@` 符号触发文件搜索，支持键盘导航
- **输入框增强**：Shift+Enter 换行，自动高度调整，最多10行显示
- **键盘操作**：优化事件处理优先级，支持上下箭头导航

## 插件集成 (2025-07-05 完成)

### 插件结构
- **ToolWindowFactory**：`ClaudeCodePlusToolWindowFactory` 集成完成
- **UI 组件**：使用 `ChatAppWithSessionsPanel` 包装 toolwindow 模块的 Compose UI
- **依赖管理**：plugin 模块正确依赖 cli-wrapper 和 toolwindow 模块

### IntelliJ IDEA 集成
- **工具窗口**：插件在 IntelliJ IDEA 中作为工具窗口运行
- **Compose UI**：通过 `PluginComposeFactory` 工厂方法创建 Compose UI
- **主题支持**：使用 IntUiTheme 与 IntelliJ 主题同步（暗色/亮色模式）
- **服务适配**：通过 IdeaProjectServiceAdapter 和 IdeaFileIndexServiceAdapter 与 IntelliJ 平台集成

### 技术方案
- **Compose 集成策略**：
  - 创建 `PluginComposeFactory` 在 toolwindow 模块中处理 Compose 集成
  - 避免在 plugin 模块直接使用 ComposePanel，解决类加载器问题
  - 使用反射处理不同版本的 setContent 方法签名
- **依赖配置**：
  - toolwindow 模块使用 `compileOnly` 配置 Compose 依赖，避免与 IntelliJ 平台冲突
  - plugin 模块不直接依赖 Compose，通过 toolwindow 模块的工厂方法使用
- **错误处理**：完善的错误处理和回退机制，确保插件稳定运行
- **构建系统**：使用 IntelliJ Platform Gradle Plugin 2.6.0 进行构建

### 解决的问题
- **ComposePanel.setContent 方法签名不匹配**：通过在 toolwindow 模块创建工厂方法解决
- **类加载器冲突**：避免在 plugin 模块直接使用 Compose 类
- **版本兼容性**：使用反射处理不同 IntelliJ 版本的 API 差异

### 测试状态
- **构建成功**：项目完整构建通过，无编译错误
- **插件运行**：IntelliJ IDEA 插件环境成功启动
- **UI 集成**：Compose UI 成功集成到 IntelliJ 工具窗口

## 最新更新记录

### 2025-07-03 富文本输入系统实现

#### 实现原理
- **Visual Transformation**：使用 Compose 的 VisualTransformation API 实现富文本渲染
- **数据不变性**：底层数据保持 `@file://path` 格式，仅视觉层转换为 `@filename`
- **偏移映射**：精确处理原始文本和显示文本之间的光标位置映射
- **输入处理器**：拦截键盘事件，实现引用的整体删除和光标跳跃

#### 关键组件
1. **InlineReferenceVisualTransformation**
   - 解析文本中的所有引用格式
   - 构建带样式的 AnnotatedString（蓝色超链接）
   - 创建双向偏移映射（原始↔显示）

2. **InlineReferenceInputProcessor**
   - 处理退格键/Delete键的整体删除
   - 处理左右箭头的光标跳跃
   - 扩展选择范围到完整引用

3. **ChatInputField 集成**
   - 应用 visualTransformation
   - 在 onPreviewKeyEvent 中调用处理器
   - 保持原有的@符号触发逻辑

4. **显示样式统一**
   - 修复用户消息显示与输入框样式不一致问题
   - UnifiedInputArea 的 DISPLAY 模式使用相同的 Visual Transformation
   - 支持点击引用的正确偏移映射

#### 技术实现亮点
```kotlin
// Visual Transformation 实现
override fun filter(text: AnnotatedString): TransformedText {
    // 1. 解析引用：@file://src/main.kt
    // 2. 转换显示：@main.kt（蓝色超链接）
    // 3. 创建偏移映射
    return TransformedText(transformedText, offsetMapping)
}

// 整体删除实现
fun handleDelete(value: TextFieldValue, isBackspace: Boolean): TextFieldValue? {
    // 检测光标是否在引用边界
    // 如果是，删除整个引用
    // 返回新的文本和光标位置
}
```

### 2025-07-03 内联引用系统重构

#### 关键问题修复
- **上下文选择器自动弹出**：修复应用启动时选择器立即显示的问题
- **状态管理优化**：添加 `showContextSelector` 状态控制，避免意外显示
- **选择后自动关闭**：选择文件/网页后立即关闭选择器，提升用户体验

#### 可扩展引用格式系统
- **架构重构**：从硬编码正则表达式改为基于枚举的可扩展系统
- **支持多种格式**：`@file://`、`@https://`、`@git://`、`@symbol://`等7种引用类型
- **自动化生成**：正则表达式根据枚举定义自动生成，类型安全
- **验证机制**：每种引用类型都有独立的格式验证规则

#### 数据一致性保证
- **存储格式**：统一使用 `@file://path` 格式存储和发送
- **显示优化**：UI只显示文件名（如 `@main.kt`），但保留完整信息
- **历史兼容**：重新加载会话时能正确识别和渲染引用
- **AI兼容**：Claude能理解标准的 `@file://` 格式

#### 技术实现亮点
```kotlin
// 可扩展的引用类型定义
enum class InlineReferenceScheme(val prefix: String, val displayName: String) {
    FILE("file://", "文件"),
    HTTPS("https://", "网页"),
    GIT("git://", "Git仓库")
    // 新类型只需在此添加一行即可
}

// 自动生成检测模式
fun generateParsePattern(): Regex {
    val prefixes = getAllPrefixes().joinToString("|") { Regex.escape(it) }
    return Regex("@($prefixes[^\\s]+)")
}
```

#### 验证结果
- ✅ 上下文选择器正常显示/隐藏
- ✅ @符号触发机制准确
- ✅ 文件引用格式一致性
- ✅ 历史会话兼容性
- ✅ 可扩展架构验证

### 2025-07-01 模型选择功能完善

#### 核心问题修复
- **硬编码Bug修复**：解决 `sendMessage` 函数中模型参数被硬编码为 "sonnet" 的问题
- **参数传递验证**：确保选择的模型正确传递到 Claude CLI
- **默认模型调整**：将默认模型从 SONNET 改为 OPUS

#### UI组件重构
- **Jewel Popup集成**：使用 Jewel 的 Popup 组件替换自定义实现
- **向上展开设计**：模型选择器向上弹出，避免遮挡输入内容
- **小巧无边框**：优化按钮尺寸、字体大小、间距，移除边框设计
- **主题一致性**：使用 Jewel 主题色彩，确保与整体UI风格统一

#### 技术实现
```kotlin
// 模型枚举映射
enum class AiModel(val displayName: String, val cliName: String) {
    OPUS("Claude 4 Opus", "opus"),
    SONNET("Claude 4 Sonnet", "sonnet")
}

// 响应式状态管理
var selectedModel by remember { mutableStateOf(AiModel.OPUS) }
```

#### 验证结果
- ✅ 模型切换功能正常 (Opus ↔ Sonnet)
- ✅ CLI参数正确传递 (`"model":"claude-opus-4-20250514"`)
- ✅ 状态同步正确
- ✅ UI设计符合要求

### 代码提交记录
1. **【刘雄风】fix：修复模型选择功能硬编码问题并设置默认模型为Opus**
2. **【刘雄风】refactor：重构模型选择器UI，使用Jewel Popup组件并优化小巧无边框设计**
3. **【刘雄风】chore：更新文档，记录模型选择功能修复和UI优化的详细内容**

## 技术栈与依赖

### 核心技术
- **Kotlin** - 主要开发语言
- **Jetpack Compose Desktop** - UI框架
- **Jewel UI** - JetBrains官方UI组件库
- **Kotlin Coroutines** - 异步处理

### 关键组件
- **ClaudeCliWrapper** - Claude CLI封装与流式处理
- **OptimizedSessionManager** - 会话管理与缓存
- **EnhancedSmartInputArea** - 增强输入组件
- **CompactModelSelector** - 模型选择器

### 项目结构
```
claude-code-plus/
├── cli-wrapper/          # CLI封装层
├── toolwindow/          # UI组件与业务逻辑
├── plugin/              # IDEA插件集成
└── docs/               # 项目文档
```

## 开发与测试

### 测试环境
- **工具窗口测试**：`toolwindow-test` 模块提供独立测试环境
- **单元测试**：覆盖核心组件功能
- **集成测试**：验证 Claude CLI 通信

### 构建与运行
```bash
# 构建项目
./gradlew build

# 运行测试应用
cd toolwindow-test && ../gradlew run

# 运行插件测试
./gradlew runIde
```

## 历史版本演进

### 架构演进
1. **初期**：Node.js 服务 + 文件监听
2. **中期**：直接 CLI 集成 + 复杂会话管理
3. **现期**：简化架构 + 流式响应 + Compose UI

### 主要里程碑
- **2025-06-21**：完成 Claude CLI 集成与会话管理
- **2025-06-22**：UI交互优化与错误修复
- **2025-07-01**：模型选择功能完善与UI重构
- **2025-07-03**：实现富文本输入系统，支持内联引用
- **2025-07-04**：重构为 Jewel + AnnotatedString 架构，解决输入法兼容性
- **2025-07-04**：完成组件重命名，移除 Simple 前缀，清理技术债务
- **2025-07-05**：分析 Claude Code CLI 会话管理机制，完成会话管理设计

## 最新进展（2025-07-05）

### 插件集成完成
- ✅ **基础集成**：成功将 toolwindow 模块集成到 plugin 模块中
  - 修复了 plugin.xml 中的 ToolWindowFactory 路径配置
  - 配置了所有必要的服务适配器（IdeaProjectServiceAdapter、IdeaFileIndexServiceAdapter）
  - 添加了动态主题检测（UIUtil.isUnderDarcula()）
  - 插件可正常加载，工具窗口成功显示

- ✅ **Compose UI 集成**：成功集成 toolwindow 模块的完整 Compose UI
  - 直接使用 ChatAppWithSessions 组件（包含输入框和聊天对话框）
  - 通过 ComposePanel 包装 Compose UI 在 IntelliJ 中显示
  - 添加了错误处理和后备方案
  - 保持了原有的会话管理、文件引用等完整功能

- ✅ **功能完整性**：Claude Code Plus 现在完全可用
  - 支持与 Claude AI 进行智能对话
  - 支持文件引用和上下文管理
  - 支持会话管理（新建、继续、切换）
  - 支持模型选择（Opus、Sonnet）
  - 支持流式响应和请求中断
  - 支持富文本输入和内联引用

### 会话管理功能分析与设计
- ✅ 分析了 Claude Code CLI 的会话存储机制
  - 会话存储在 `~/.claude/projects/[encoded-project-path]/` 目录
  - 使用 JSONL 格式存储，每行一个 JSON 对象
  - 支持 `-c` (继续最近会话) 和 `-r` (恢复指定会话) 参数
- ✅ 创建了[会话管理设计文档](SESSION_MANAGEMENT_DESIGN.md)
  - 定义了会话数据模型
  - 设计了 SessionManager 接口
  - 规划了 UI 组件结构
  - 制定了实现计划

### 懒加载演示实现
- ✅ 创建了 SimpleLazySessionDemo 组件
  - 展示了如何实现大型会话的懒加载
  - 支持分页加载（每页20条消息）
  - 实现了滚动到底部自动加载更多
  - 添加了加载状态指示器
  - 展示了虚拟滚动的最佳实践

### 技术要点
- **懒加载策略**：
  - 初始加载最新的20条消息
  - 监听滚动状态，当接近底部时自动加载更多
  - 使用 `snapshotFlow` 监听 LazyListState 变化
  - 避免一次性加载所有历史消息导致的性能问题
- **状态管理**：
  - 分离 `allMessages`（所有消息）和 `displayedMessages`（已显示消息）
  - 使用 `currentPage` 跟踪当前加载页数
  - 使用 `isLoading` 防止重复加载
- **用户体验**：
  - 加载时显示进度指示器
  - 显示已加载/总消息数
  - 平滑的滚动和加载动画

## 待完成功能

### 高优先级
- [ ] **会话历史管理功能**（已完成设计，待实现）
  - [ ] SessionManager 接口实现
  - [ ] 会话列表 UI 组件
  - [ ] 与现有聊天界面集成
  - [ ] 会话切换和恢复功能
- [ ] **快捷键支持**
  - [ ] Cmd/Ctrl+Enter 发送消息
  - [ ] Cmd/Ctrl+N 新建会话
  - [ ] Cmd/Ctrl+Shift+F 搜索消息

### 中优先级
- [ ] **消息搜索功能**
  - [ ] 全文搜索
  - [ ] 按日期过滤
  - [ ] 高亮搜索结果
- [ ] **主题切换**
  - [ ] 深色/浅色模式切换
  - [ ] 自定义配色方案
- [ ] **导出对话功能**
  - [ ] Markdown 格式导出
  - [ ] JSON 格式导出
  - [ ] PDF 导出（可选）

### 低优先级
- [ ] **多标签页支持**
  - [ ] 同时打开多个会话
  - [ ] 标签页切换
  - [ ] 标签页管理
- [ ] **语音输入支持**
  - [ ] 集成系统语音识别
  - [ ] 语音转文字
- [ ] **性能优化**
  - [ ] 大型会话的懒加载
  - [ ] 消息虚拟化滚动
  - [ ] 缓存优化

## 代码清理记录

### 2025-07-05 测试模块清理
- ✅ 清理 toolwindow-test 模块，只保留会话管理相关测试
- ✅ 删除非会话管理相关的测试文件：
  - ContextSelectorTestApp.kt（上下文选择器测试）
  - MockContextSearchService.kt（模拟搜索服务）
  - SimpleFileIndexService.kt（文件索引服务）
  - TestFileIndexServiceAdapter.kt（适配器）
- ✅ 保留的会话管理测试文件：
  - TestSessionManager.kt - GUI测试会话管理基本操作
  - TestFullSessionManager.kt - 测试完整会话管理集成
  - TestSessionCLI.kt - 命令行测试会话管理核心功能
  - TestSessionPanelOnly.kt - 测试SessionListPanel组件
  - TestSessionDebug.kt - 会话存储调试工具
  - TestSimpleInputArea.kt - 简化为测试入口文件