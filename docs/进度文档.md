# 进度文档

## 项目架构与核心功能

### Claude CLI 集成
- **流式响应支持**：实现实时流式 JSON 响应处理
- **权限模式**：默认使用 `default` 模式，允许所有操作
- **版本验证**：支持 Claude CLI 1.0.31+ 版本

### 会话管理系统
- **会话持久化**：基于 Claude CLI 原生会话管理，使用 `--resume` 参数
- **历史记录**：启动时自动加载 JSONL 格式的会话历史
- **会话隔离**：支持新建会话和继续对话，与命令行工具共享会话
- **路径转换**：使用 ProjectPathUtils 处理项目路径格式转换

### UI交互优化
- **响应打断**：支持停止按钮和 ESC 键中断流式响应
- **文件引用**：`@` 符号触发文件搜索，支持键盘导航
- **输入框增强**：Shift+Enter 换行，自动高度调整，最多10行显示
- **键盘操作**：优化事件处理优先级，支持上下箭头导航

## 最新更新记录

### 2025-07-01 模型选择功能完善

#### 核心问题修复
- **硬编码Bug修复**：解决 `sendMessage` 函数中模型参数被硬编码为 "sonnet" 的问题
- **参数传递验证**：确保选择的模型正确传递到 Claude CLI
- **默认模型调整**：将默认模型从 SONNET 改为 OPUS

#### UI组件重构
- **Jewel Popup集成**：使用 Jewel 的 Popup 组件替换自定义实现
- **向上展开设计**：模型选择器向上弹出，避免遮挡输入内容
- **小巧无边框**：优化按钮尺寸、字体大小、间距，移除边框设计
- **主题一致性**：使用 Jewel 主题色彩，确保与整体UI风格统一

#### 技术实现
```kotlin
// 模型枚举映射
enum class AiModel(val displayName: String, val cliName: String) {
    OPUS("Claude 4 Opus", "opus"),
    SONNET("Claude 4 Sonnet", "sonnet")
}

// 响应式状态管理
var selectedModel by remember { mutableStateOf(AiModel.OPUS) }
```

#### 验证结果
- ✅ 模型切换功能正常 (Opus ↔ Sonnet)
- ✅ CLI参数正确传递 (`"model":"claude-opus-4-20250514"`)
- ✅ 状态同步正确
- ✅ UI设计符合要求

### 代码提交记录
1. **【刘雄风】fix：修复模型选择功能硬编码问题并设置默认模型为Opus**
2. **【刘雄风】refactor：重构模型选择器UI，使用Jewel Popup组件并优化小巧无边框设计**
3. **【刘雄风】chore：更新文档，记录模型选择功能修复和UI优化的详细内容**

## 技术栈与依赖

### 核心技术
- **Kotlin** - 主要开发语言
- **Jetpack Compose Desktop** - UI框架
- **Jewel UI** - JetBrains官方UI组件库
- **Kotlin Coroutines** - 异步处理

### 关键组件
- **ClaudeCliWrapper** - Claude CLI封装与流式处理
- **OptimizedSessionManager** - 会话管理与缓存
- **EnhancedSmartInputArea** - 增强输入组件
- **CompactModelSelector** - 模型选择器

### 项目结构
```
claude-code-plus/
├── cli-wrapper/          # CLI封装层
├── toolwindow/          # UI组件与业务逻辑
├── plugin/              # IDEA插件集成
└── docs/               # 项目文档
```

## 开发与测试

### 测试环境
- **工具窗口测试**：`toolwindow-test` 模块提供独立测试环境
- **单元测试**：覆盖核心组件功能
- **集成测试**：验证 Claude CLI 通信

### 构建与运行
```bash
# 构建项目
./gradlew build

# 运行测试应用
cd toolwindow-test && ../gradlew run

# 运行插件测试
./gradlew runIde
```

## 历史版本演进

### 架构演进
1. **初期**：Node.js 服务 + 文件监听
2. **中期**：直接 CLI 集成 + 复杂会话管理
3. **现期**：简化架构 + 流式响应 + Compose UI

### 主要里程碑
- **2025-06-21**：完成 Claude CLI 集成与会话管理
- **2025-06-22**：UI交互优化与错误修复
- **2025-07-01**：模型选择功能完善与UI重构