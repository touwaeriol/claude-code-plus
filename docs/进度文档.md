# Claude Code Plus 进度文档

## 2025-06-18 更新

### Node.js 服务打包和自动启动优化

#### 1. 修复了 Claude SDK 导入错误
- **问题**: Claude API 错误 "TypeError: (0 , import_claude_code_sdk.query)(...) is not a function"
- **解决方案**: 
  - 将包名从 'claude-code-sdk' 更正为 '@anthropic-ai/claude-code'
  - 更新了 query 函数的使用方式以匹配官方 SDK
  - 成功集成官方 SDK

#### 2. 实现了 Node.js 服务打包到插件
- **构建流程**:
  - TypeScript 编译为兼容 Node.js 18+ 的 JavaScript
  - 使用 prepare-production.js 准备生产环境
  - 自动复制所有必要的依赖到资源目录
  - 创建 ESM wrapper 解决模块加载问题

#### 3. 添加了自动启动功能
- **实现细节**:
  - 在 SimpleMarkdownToolWindowFactory 中添加服务启动逻辑
  - 添加详细的日志输出用于调试
  - 实现健康检查确保服务正常运行
  - 资源提取到临时目录并启动 Node.js 进程

#### 4. 当前状态
- **已完成**:
  - Node.js 服务可以独立启动并监听 18080 端口
  - 健康检查端点正常工作
  - 资源文件正确打包到插件
  - ESM 和 CommonJS 兼容性问题已解决
  - 改为手动启动模式，提供了启动脚本和详细文档
  - **已删除插件自动启动 Node 服务的功能**（2025-06-18）

- **使用方式**:
  - 运行 `./start-node-service.sh` 启动服务
  - 或手动进入 `src/main/resources/claude-node` 运行 `node server-esm-wrapper.mjs`
  - 服务需要手动启动，插件不再自动启动服务

### 技术要点

#### Node.js 服务
- **目录结构**: `claude-sdk-wrapper/`
- **主要文件**:
  - `src/server.ts`: Express 服务器主文件
  - `src/services/claudeService.ts`: Claude SDK 集成
  - `dist/production/`: 生产环境文件
  - `server-esm-wrapper.mjs`: ESM 包装器

#### IntelliJ 插件
- **目录结构**: `src/main/kotlin/com/claudecodeplus/`
- **核心组件**:
  - `sdk/NodeResourceExtractor.kt`: 资源提取器
  - `toolwindow/SimpleMarkdownToolWindowFactory.kt`: UI 和服务启动
  - `sdk/ClaudeAPIClient.kt`: HTTP 客户端

#### 构建配置
- **Gradle 任务**:
  - `checkNodeEnvironment`: 检查 Node.js 环境
  - `buildNodeService`: 构建服务
  - `cleanNodeResources`: 清理资源
- **自动化**: 
  - 构建时自动准备 Node.js 服务
  - 打包时包含所有依赖

#### 5. 自动构建配置
- **Gradle 配置优化**:
  - 每次编译（compileKotlin）时自动构建 Node.js 服务
  - 在 buildPlugin 任务前确保服务已构建
  - processResources 和 prepareSandbox 任务依赖 buildNodeService
  - 服务自动打包到 `src/main/resources/claude-node` 目录

- **快速启动方式**:
  - 项目根目录：`./start-node-service.sh`
  - Resource 目录：`cd src/main/resources/claude-node && ./start.sh`
  - 或直接运行：`node src/main/resources/claude-node/server-esm-wrapper.mjs`

### 后续计划

1. **手动启动方式优化**: 提供更便捷的服务启动工具
2. **优化进程管理**: 确保服务稳定运行
3. **完善错误处理**: 添加更好的错误提示
4. **性能优化**: 减少资源文件大小

### 环境要求

1. **Node.js 版本**: 需要 Node.js 18+
2. **API 配置**: 需要配置 Anthropic API Key
3. **开发工具**: IntelliJ IDEA 2025.1+

## 2025-06-19 更新

### UI 重新设计 - 现代化对话界面

#### 1. 移除发送按钮，添加模型选择器
- **参考设计**: 基于提供的参考图片重新设计输入面板
- **主要改动**:
  - 完全移除发送按钮
  - 在输入框底部添加模型选择器
  - 实现 "@ Add Context" 按钮
  - 添加占位符文本 "Plan, search, build anything"

#### 2. 对话显示样式重新设计
- **用户消息**:
  - 使用引用块样式（> 前缀）创建背景容器
  - 与输入框保持相同的背景色
  - 移除发送者标识（👤 You）
- **AI 回复**:
  - 直接显示在主背景上，无额外容器
  - 移除发送者标识（🤖 Claude）
  - 更清晰的视觉层次
- **处理状态**:
  - 显示 "Generating..." 而非 "正在输入..."
  - 计划添加停止按钮（待实现）

#### 3. 主题自适应支持
- **需求文档更新**: 添加主题适配章节
- **技术方案**:
  - 使用 `UIUtil.isUnderDarcula()` 判断深色主题
  - 使用 `UIManager.getColor()` 获取主题颜色
  - 支持 Light/Dark 主题自动切换

#### 4. 模型选择功能
- **支持三种模型**:
  - Default (Opus/Sonnet) - 自动切换
  - Opus - claude-3-opus-20240229
  - Sonnet - claude-3-5-sonnet-20241022
- **集成方式**: 
  - 模型参数通过 options 传递给 Node 服务
  - Enter 键直接发送，使用选中的模型

#### 5. 代码实现
- **更新文件**:
  - `SimpleMarkdownToolWindowFactory.kt`: 主要 UI 重构
  - `REQUIREMENTS.md`: 更新设计规范
  - 添加 `formatUserMessage()` 方法处理用户消息样式
  - 重构消息显示逻辑，移除所有发送者标识

#### 6. 当前状态
- **已完成**:
  - ✅ 移除发送按钮
  - ✅ 添加模型选择器
  - ✅ 实现新的对话显示样式
  - ✅ 移除发送者标识
  - ✅ 更新需求文档
- **待完成**:
  - ⏳ 添加停止生成按钮
  - ⏳ 实现主题颜色自动适配
  - ⏳ 优化消息容器的视觉效果

#### 7. MCP (Model Context Protocol) 服务配置功能
- **需求来源**: 用户要求在 NewChat 右边添加设置菜单，配置 MCP 服务
- **实现内容**:
  - **UI 改动**:
    - 在 "+ New Chat" 按钮右边添加三个点（⋯）按钮
    - 点击弹出菜单，包含 "MCP 服务配置" 选项
    - 点击进入 IDEA 设置页面的专门配置区域
  
  - **配置页面**:
    - 创建 `McpConfigurable` 配置页面类
    - 支持三个级别的配置：User、Local、Project
    - 每个级别都有独立的选项卡和 JSON 编辑器
    - 提供示例配置帮助用户理解格式
  
  - **配置存储**:
    - 创建 `McpSettingsService` 应用级服务
    - 创建 `ProjectMcpSettingsService` 项目级服务
    - User 和 Local 级别存储在 `claude-code-plus-mcp.xml`
    - Project 级别存储在工作区文件中
  
  - **配置格式支持**:
    - 单个服务配置：直接定义服务对象
    - 多个服务配置：使用 "mcpServers" 包装
    - 支持 Docker、uvx 等多种命令
    - 支持环境变量配置
  
  - **集成方式**:
    - MCP 配置通过 `ClaudeOptions` 传递给 Claude SDK
    - 配置优先级：Project > Local > User
    - 在发送消息时自动包含当前项目的 MCP 配置
  
- **技术要点**:
  - 使用 Jackson 库进行 JSON 解析和验证
  - 在 plugin.xml 中注册配置页面和服务
  - 扩展 `ClaudeOptions` 类支持 MCP 配置
  - 通过 `getMcpConfigForProject` 方法获取合并后的配置

#### 8. 项目命名规范化和 UI 优化
- **需求来源**: 优化项目中的命名规范，移除 Simple 等不规范命名
- **实现内容**:
  - **重命名核心类**:
    - `SimpleMarkdownToolWindowFactory` → `ClaudeCodePlusToolWindowFactory`
    - 工具窗口 ID 从 `ClaudeCodeSimple` → `ClaudeCodePlus`
  
  - **UI 布局优化**:
    - 将 "+ New Chat" 按钮移到工具窗口标题栏（文字显示，非图标）
    - 将设置功能移到工具窗口的齿轮菜单，显示为 "Settings"
    - 删除了原工具栏中的冗余按钮
    - 使用 IntelliJ 平台标准 API：`setTitleActions()` 和 `setAdditionalGearActions()`
  
  - **设置页面层级优化**:
    - 在 IDEA 设置中创建 Tools > Claude Code Plus > MCP 的层级结构
    - 齿轮菜单的 "Settings" 直接打开到 Claude Code Plus 设置组（Tools > Claude Code Plus）
    - MCP 作为子配置项，简洁明了
    - 点击 Settings 后自动导航到正确的设置页面位置
  
  - **插件描述更新**:
    - 更新了 plugin.xml 中的描述信息
    - 添加了主要功能列表，更专业的插件描述

- **代码质量提升**:
  - 清理了不必要的导入
  - 统一了命名规范，使用 Claude Code Plus 作为项目标识
  - 保持了代码的整洁性和可维护性

#### 9. UI 优化和默认模型设置（2025-06-19）
- **需求来源**: 
  - New Chat 按钮显示为图标而非文字
  - 需要默认使用 Claude 4 Opus 模型
  
- **实现内容**:
  - **修复 New Chat 按钮显示**:
    - 添加 `templatePresentation` 设置强制显示文字
    - 设置 `templatePresentation.text = "+ New Chat"`
    - 设置 `templatePresentation.icon = null` 确保不显示图标
  
  - **默认模型改为 Claude 4 Opus**:
    - 调整模型选项顺序，将 "claude-4-opus" 放在第一位
    - 保持 `selectedIndex = 0` 默认选择第一项（即 Opus）
    - 更新模型映射逻辑，确保正确转换为 API 格式
    - 设置默认值为 "opus" 而非 "sonnet"

#### 10. MCP 配置层级修复和文件引用功能改进（2025-06-19）
- **需求来源**:
  - MCP 配置显示在顶层，需要移到 Tools > Claude Code Plus 下
  - @ 文件引用需要使用 IDEA 原生搜索功能
  - 文件引用需要显示为超链接，悬停显示完整路径

- **实现内容**:
  - **修复 MCP 配置层级**:
    - 修改 plugin.xml 中的 `groupId` 从 "com.claudecodeplus.settings" 改为 "tools"
    - 确保配置显示在 Tools > Claude Code Plus > MCP 的正确层级
  
  - **改进文件引用功能**:
    - 使用 IDEA 的 FilenameIndex API 搜索所有文件类型
    - 支持搜索文件名和文件路径
    - 添加自定义列表渲染器，显示文件图标和路径
    - 文件列表显示格式：**文件名** - 路径（灰色）
    - 悬停提示显示完整路径
  
  - **改进文件选择交互**:
    - 单击只选中文件，不自动插入
    - 双击或回车确认插入文件引用
    - 支持键盘上下键导航文件列表
  
  - **文件引用显示为超链接**:
    - 在 Markdown 渲染中将 @文件路径 转换为 [@文件路径](file://绝对路径)
    - 显示完整相对路径，保持用户输入的格式
    - 支持点击打开文件（需要 Markdown 渲染器支持）
    - 发送给 AI 时也使用相同的 Markdown 链接格式
    - 文件未找到时保持原样 @文件路径

- **技术改进**:
  - 简化搜索逻辑，移除对 PsiShortNamesCache 的依赖
  - 使用 IDEA 标准的文件类型图标
  - 改进文件路径处理，支持相对路径和绝对路径

#### 11. 停止响应功能实现（2025-06-19）
- **需求来源**:
  - Claude Code SDK 支持中断响应
  - 用户需要能够停止 AI 响应，重新输入问题
  - 需要防止在 AI 响应时发送新消息

- **实现内容**:
  - **停止按钮功能**:
    - 在输入面板的中间添加停止按钮（默认隐藏）
    - AI 开始响应时显示停止按钮，完成后自动隐藏
    - 点击停止按钮取消当前流式任务
  
  - **ESC 键支持**:
    - 在 AI 响应期间按 ESC 键可以停止生成
    - 非响应期间 ESC 键关闭文件选择弹窗
  
  - **输入控制**:
    - AI 响应期间禁用输入框（`inputArea.isEnabled = false`）
    - 用户尝试发送消息时弹出提示框
    - 响应完成或被取消后自动重新启用输入框
  
  - **协程任务管理**:
    - 使用 `currentStreamJob` 跟踪当前流式任务
    - 支持 `CancellationException` 处理用户取消
    - 在各种结束场景下都正确重置 UI 状态

- **技术要点**:
  - Claude SDK 使用 `AbortController` 支持取消
  - Kotlin 协程的 Job 可以通过 `cancel()` 方法取消
  - 需要在多个地方（成功、错误、取消）重置 UI 状态
  - 使用 `inputArea.putClientProperty()` 存储组件引用

#### 12. Node 服务并发控制和中断功能（2025-06-19）
- **需求来源**:
  - Node 服务需要支持中断功能
  - 一个 Node 服务只能同时处理一个请求
  - 插件需要能查询服务状态

- **实现内容**:
  - **Node 服务端改进**:
    - 添加 `isProcessing` 状态跟踪
    - 添加类级别的 `currentAbortController`
    - 实现 `abort()` 方法支持中断当前请求
    - 新增 `/abort` POST 接口用于中断请求
    - 健康检查接口返回 `is_processing` 状态
    - 在 `streamMessage` 中检查并发，拒绝并发请求
  
  - **Kotlin 插件端改进**:
    - 修改 `checkHealth()` 返回 `HealthStatus` 数据类
    - 添加 `abortCurrentRequest()` 方法调用服务端中断接口
    - 发送消息前检查服务状态：
      - 服务未就绪时显示错误
      - 服务繁忙时提示用户等待或中断
    - 停止按钮和 ESC 键同时调用客户端和服务端中断
  
  - **并发控制机制**:
    - 服务端通过 `isProcessing` 标志控制并发
    - 请求开始时设置为 true，结束时重置为 false
    - 新请求到达时检查标志，如果繁忙则返回错误
    - 插件端在发送前先查询状态，避免无效请求

- **技术要点**:
  - 使用 `AbortController` 的 `abort()` 方法中断 SDK 请求
  - 在 `finally` 块中确保状态清理
  - 健康检查接口扩展，返回处理状态
  - 客户端和服务端双重中断机制

#### 13. Unix Socket + JSON-RPC 通信实现（2025-06-19）
- **需求来源**:
  - 用户要求使用 Unix Socket 替代 HTTP 通信
  - 需要支持流式响应和并发控制
  - 插件启动时自动启动 Node 服务

- **实现内容**:
  - **Node 服务端改进**:
    - 创建 `UnixSocketService` 实现 JSON-RPC 2.0 协议
    - 在临时目录创建 Unix Socket 文件
    - 输出 `SOCKET_PATH:xxx` 供 Java 客户端读取
    - 支持流式响应通过 JSON-RPC 通知
    - 实现并发控制和中断机制
    - 删除了 HTTP 和消息队列模式
  
  - **Java/Kotlin 客户端实现**:
    - 创建 `UnixSocketClient` 使用 JDK 16+ Unix Domain Socket
    - 通过 ProcessBuilder 启动 Node 服务
    - 从进程输出读取 Socket 路径
    - 实现 JSON-RPC 协议的请求响应
    - 支持流式响应处理
  
  - **自动构建和启动**:
    - Gradle 配置自动编译 Node 服务
    - 服务打包到 resources/claude-node 目录
    - 插件初始化时自动启动 Node 服务
    - 服务生命周期与插件绑定
  
  - **编译错误修复**:
    - 修复 NodeResourceExtractor 方法调用
    - 修复 apiClient 空安全调用
    - 修复 HealthStatus 导入和参数
    - 修复方法定义位置和语法错误

- **技术要点**:
  - Unix Domain Socket 提供更高性能和安全性
  - JSON-RPC 2.0 标准协议，支持流式通知
  - 双向中断机制（客户端 Job + 服务端 AbortController）
  - 服务生命周期管理，确保资源正确释放

---
*最后更新: 2025-06-19*