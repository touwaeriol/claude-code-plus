# Claude Code Plus 功能说明

## 核心功能

### 1. 流式响应

插件支持实时流式响应，用户可以看到 AI 逐字生成的内容，而不需要等待完整响应。

### 2. 响应打断功能

插件实现了多种方式来打断正在进行的 AI 响应：

#### 2.1 停止按钮

- **位置**：输入框底部中央
- **行为**：点击后立即取消当前的响应生成
- **实现**：`ClaudeCodePlusToolWindowFactory.kt:514-522`

```kotlin
stopButton.addActionListener {
    // 取消当前的流式任务
    currentStreamJob?.cancel()
    logger.info("Stream cancelled by stop button")
    // 切换按钮状态
}
```

#### 2.2 ESC 键快捷方式

- **触发**：按下 ESC 键
- **行为**：如果正在生成响应，立即停止；否则关闭文件引用弹窗
- **实现**：`ClaudeCodePlusToolWindowFactory.kt:561-595`

```kotlin
e.keyCode == KeyEvent.VK_ESCAPE -> {
    if (currentStreamJob?.isActive == true) {
        currentStreamJob?.cancel()
        logger.info("Stream cancelled by user")
        // 更新UI状态
    }
}
```

#### 2.3 实现原理

打断功能的核心是使用 Kotlin 协程的取消机制：

1. **协程任务管理**：
   ```kotlin
   private var currentStreamJob: kotlinx.coroutines.Job? = null
   ```

2. **启动新任务前取消旧任务**：
   ```kotlin
   // 取消之前的任务（如果有）
   currentStreamJob?.cancel()
   ```

3. **进程级别的清理**：
   ```kotlin
   // ClaudeCliWrapper.kt:139
   finally {
       process.destroy()  // 确保进程被终止
   }
   ```

### 3. 上下文选择功能

插件提供了三种方式来添加上下文信息：

#### 3.1 Add Context 按钮

**位置**：输入框顶部左侧
**样式**：
- 高度：24dp，字体大小：10sp
- 背景色：与输入框相同的面板背景色
- 圆角：4dp，内边距：水平 6dp，垂直 2dp

**功能**：
- 点击触发上下文选择器弹窗
- 支持文件、网页等多种类型的上下文
- 选择后以标签形式显示在按钮右侧

#### 3.2 @ 符号内联引用

**触发方式**：在输入框中输入 `@` 符号
**行为**：
- 输入 `@` 后立即弹出文件搜索框
- 支持模糊搜索项目内所有文件
- 支持键盘导航（上下箭头选择，Enter 确认）
- 选择后文件路径直接插入到文本中的 @ 位置

**显示效果**：
- 选中的文件在消息中显示为 `@文件名`
- 文件内容自动附加到发送的消息中

#### 3.3 ⌘K 快捷键

**触发**：按下 ⌘K（Command+K）组合键
**功能**：与 Add Context 按钮相同，触发上下文选择器
**优势**：键盘友好，快速访问

#### 3.4 上下文标签管理

**显示位置**：Add Context 按钮右侧的水平滚动区域
**标签特性**：
- 水平滚动布局（LazyRow）
- 标签间距：4dp
- 支持删除操作（点击标签上的 × 按钮）
- 实时同步：添加或删除后立即更新显示

**标签类型**：
- 文件上下文：显示文件名和图标
- 网页上下文：显示网页标题
- 其他类型：根据内容类型显示相应图标和名称

### 4. ChatInputArea 统一输入组件

插件实现了统一的聊天输入区域组件，封装了所有输入相关功能，确保界面完整性和用户体验。该组件支持两种模式：**输入模式**和**只读显示模式**。

#### 4.1 组件设计特点

- **统一封装**：输入框、发送按钮、模型选择器、上下文选择等功能统一封装
- **Cursor 风格**：参考 Cursor 编辑器的现代化设计理念
- **响应式设计**：组件状态实时响应用户操作和系统状态

#### 4.2 视觉设计

**统一边框设计**：
- 整个输入区域使用一个统一的边框包围
- 内部组件无嵌套边框，保持视觉简洁
- Add Context 按钮与输入框使用相同背景色

**紧凑布局**：
- 组件间距紧凑，提高空间利用率
- 小巧的按钮和选择器（24dp 高度）
- 优化的字体大小和内边距

#### 4.3 多模型支持

插件支持 Claude 的多个模型，用户可以根据需求选择不同的模型：

**支持的模型**：
- **Claude 4 Opus**（默认）- 最强大的模型，适合复杂任务
- **Claude 4 Sonnet** - 平衡性能和速度的模型

**模型选择器**：
- **位置**：输入框底部左侧
- **样式**：小巧无背景设计，透明融入主题
- **尺寸**：高度 24dp，字体 9sp
- **交互方式**：
  - 点击显示下拉菜单
  - 菜单向上弹出，不遮挡输入内容
  - 选择后立即切换，新消息将使用选定的模型

#### 4.3 实现原理

**模型参数传递**：
```kotlin
// 模型枚举定义
enum class AiModel(val displayName: String, val cliName: String) {
    OPUS("Claude 4 Opus", "opus"),
    SONNET("Claude 4 Sonnet", "sonnet")
}

// 传递到 Claude CLI
val command = listOf("claude", "--model", selectedModel.cliName, ...)
```

**状态管理**：
```kotlin
// 响应式模型状态
var selectedModel by remember { mutableStateOf(AiModel.OPUS) }

// 状态同步
LaunchedEffect(currentModel) {
    if (internalModel != currentModel) {
        internalModel = currentModel
    }
}
```

#### 4.4 模型切换验证

发送消息时会在调试日志中显示：
```
DEBUG: Selected model: Claude 4 Opus (CLI: opus)
```

Claude CLI 初始化时确认模型：
```json
{"model":"claude-opus-4-20250514","permissionMode":"bypassPermissions"}
```

#### 4.4 发送/停止按钮

**位置**：输入框底部右侧
**设计特点**：
- 尺寸：24dp × 24dp（紧凑设计）
- 图标大小：10sp
- 智能状态切换：
  - 待发送状态：显示发送图标（↑）
  - 生成中状态：显示停止图标（⏹）
  - 智能启用：根据输入内容和生成状态自动启用/禁用

**交互行为**：
- 发送模式：点击发送当前输入的消息
- 停止模式：点击停止当前正在进行的 AI 响应生成
- 键盘支持：Enter 键等价于点击发送按钮

#### 4.5 用户消息显示组件

**设计理念**：用户消息使用与输入框相同的组件设计，确保视觉一致性

**显示模式特点**：
- **复用设计**：使用 ChatInputArea 的相同视觉布局和样式
- **只读模式**：所有组件不可交互，纯展示用途
- **选择性显示**：根据消息内容智能显示/隐藏相关元素

**显示内容**：
- 第一行：上下文标签（仅在有上下文时显示，无上下文时隐藏整行）
- 第二行：用户输入的文本内容（必显示）
- 第三行：使用的AI模型和时间戳（必显示，模型不可切换）

**隐藏元素**：
- Add Context 按钮（用户已完成上下文选择）
- 发送按钮（消息已发送）
- 所有交互功能（点击、编辑等）

**保持一致性**：
- 统一的8dp圆角边框
- 相同的背景色和间距
- 一致的字体大小和颜色
- 相同的组件高度（24dp）

### 5. 会话管理

- **新建会话**：点击标题栏的 "+ New Chat" 按钮
- **导出会话**：点击工具栏的"导出"按钮，保存为 Markdown 文件
- **清空会话**：点击工具栏的"清空"按钮

### 6. MCP (Model Context Protocol) 支持

支持配置 MCP 服务器来扩展 Claude 的能力：

- 全局配置
- 项目级别配置
- 配置合并机制

## 快捷键汇总

| 快捷键 | 功能 |
|--------|------|
| Enter | 发送消息 |
| Shift+Enter | 输入换行 |
| ESC | 停止生成/关闭弹窗 |
| @ | 触发内联文件引用 |
| ⌘K | 触发上下文选择器 |
| ↑/↓ | 在文件列表中导航 |

## UI 状态管理

### 发送消息时的状态变化

1. **发送前**：
   - 发送按钮可见
   - 停止按钮隐藏

2. **发送中**：
   - 发送按钮隐藏
   - 停止按钮显示
   - 显示 "_Generating..._" 提示

3. **完成/取消后**：
   - 停止按钮隐藏
   - 发送按钮显示
   - 输入框获得焦点

### 错误处理

- 网络错误
- CLI 进程错误
- JSON 解析错误
- 取消操作（显示"已停止生成"）

## 权限模式

默认使用 `default` 模式，允许所有操作。可选模式：

- `default` - 允许所有操作
- `strict` - 限制敏感操作
- `none` - 禁止所有工具使用