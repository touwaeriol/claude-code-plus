# 上下文选择功能需求文档

## 功能概述

实现类似 Cursor 的上下文选择功能，支持文件和Web URL的智能选择，提供直观的两步式选择流程和紧凑的展示界面。

## 详细需求

### 1. 触发机制

#### 1.1 基本触发条件
- **触发符号**：输入 `@` 字符
- **位置要求**：`@` 符号前后没有其他字符（独立存在）
- **触发时机**：实时检测，无需额外按键

#### 1.2 触发示例
```
✅ 正确触发：
- "请帮我分析 @ 这个文件"
- "@ 参考这个网页"
- 输入框开头直接输入 "@"

❌ 不会触发：
- "test@example.com"（邮箱格式）
- "user@domain"（用户名格式）
- "@github"（紧贴字符）
```

### 2. 上下文类型

#### 2.1 支持的类型
1. **File** - 文件选择
   - 图标：📁 或文件类型图标
   - 描述：项目文件、源代码、文档等
   
2. **Web** - 网页URL
   - 图标：🌐 或链接图标
   - 描述：网页链接、API文档、在线资源等

#### 2.2 未来扩展类型（预留）
3. **Terminal** - 终端输出
4. **Git** - Git相关信息
5. **Symbol** - 代码符号
6. **Selection** - 选中的代码
7. **Workspace** - 工作区信息

### 3. 两步式选择流程

#### 3.1 第一步：选择上下文类型
- **展示位置**：`@` 符号正下方弹出
- **展示内容**：
  ```
  📁 File     选择项目文件
  🌐 Web      输入网页链接
  ```
- **交互方式**：
  - 鼠标点击选择
  - 键盘上下箭头 + Enter选择
  - 直接输入字符默认进入文件选择

#### 3.2 第二步：选择具体上下文

##### 文件选择模式
- **初始展示**：显示项目根目录文件列表
- **搜索功能**：继续输入字符进行实时过滤
- **显示格式**：
  ```
  📄 Main.kt                     /src/main/kotlin/Main.kt
  📁 components/                 /src/main/kotlin/components/
  📄 README.md                   /README.md
  ```
- **文件信息**：
  - 主显示：文件名（粗体）
  - 副显示：相对路径（灰色、小字体）
  - 悬停提示：完整绝对路径

##### Web URL模式
- **输入提示**：显示输入框 "请输入网页URL..."
- **验证功能**：实时验证URL格式
- **支持协议**：http://, https://, file://
- **示例展示**：显示常用格式示例

### 4. UI设计规范

#### 4.1 弹出器位置
- **锚点**：`@` 符号位置
- **方向**：优先向下弹出，空间不足时向上
- **偏移**：水平居中对齐 `@` 符号

#### 4.2 主题适配
- **背景色**：`JewelTheme.globalColors.panelBackground`
- **边框**：1px，`JewelTheme.globalColors.borders.normal`
- **文字色**：`JewelTheme.globalColors.text.normal`
- **选中高亮**：`JewelTheme.globalColors.borders.focused`（15%透明度）

#### 4.3 尺寸规范
- **弹出器宽度**：300dp（固定）
- **最大高度**：400dp（超出显示滚动条）
- **圆角**：4dp
- **内边距**：8dp
- **行高**：32dp

#### 4.4 动画效果
- **出现动画**：淡入 + 轻微缩放（150ms）
- **消失动画**：淡出（100ms）
- **选中动画**：背景色渐变（200ms）

### 5. 文件索引与搜索

#### 5.1 索引范围
- **包含**：所有项目文件（源码、配置、文档）
- **排除**：
  - `.git/` 目录
  - `node_modules/` 目录
  - 编译产物目录（`build/`, `target/`, `dist/`）
  - IDE配置文件（`.idea/`, `.vscode/`）

#### 5.2 搜索算法
- **模糊搜索**：支持部分匹配
- **权重排序**：
  1. 文件名完全匹配（权重：100）
  2. 文件名前缀匹配（权重：80）
  3. 文件名包含匹配（权重：60）
  4. 路径包含匹配（权重：40）
- **最大结果**：50个文件（性能考虑）

#### 5.3 文件类型图标
```kotlin
fun getFileIcon(fileName: String): String {
    return when (fileName.substringAfterLast('.').lowercase()) {
        "kt" -> "🔷"
        "java" -> "☕"
        "js", "ts" -> "💛"
        "py" -> "🐍"
        "md" -> "📝"
        "json" -> "📋"
        "xml" -> "🔖"
        "yml", "yaml" -> "⚙️"
        else -> "📄"
    }
}
```

### 6. 交互行为

#### 6.1 键盘操作
- **↑/↓箭头键**：在列表中上下导航选择项
  - 自动循环：到达边界时停留在第一项/最后一项
  - 平滑滚动：选中项自动滚动到可见区域
  - 视觉反馈：选中项高亮显示
- **Enter键**：确认选择当前高亮项
  - 文件选择：立即选择当前文件并关闭选择器
  - 类型选择：进入对应的选择模式
- **Esc键**：取消操作并关闭弹出器
  - 搜索框有内容时：清空搜索内容
  - 搜索框为空时：关闭整个选择器
- **PageUp/PageDown键**：快速翻页导航
  - PageUp：向上跳转5项
  - PageDown：向下跳转5项
- **Home/End键**：快速定位
  - Home：跳转到列表第一项
  - End：跳转到列表最后一项
- **字符输入**：实时过滤搜索
  - 文件模式：按文件名/路径过滤
  - Web模式：URL输入验证
  - 去抖动：300ms延迟，避免频繁搜索

#### 6.2 鼠标操作
- **点击选择项**：选择并更新选中状态
- **悬停显示**：显示文件完整路径或详细信息
- **点击外部区域**：关闭弹出器
- **滚轮滚动**：在长列表中导航

#### 6.3 组合操作
- **键盘导航 + 鼠标点击**：无缝切换操作方式
- **搜索过滤 + 键盘选择**：过滤后保持键盘导航
- **快速选择模式**：
  - 输入@后直接输入字符 → 自动进入文件搜索
  - 输入@后按下键盘 → 显示类型选择器

#### 6.4 上下文标签显示
- **文件标签格式**：选择后在输入框上方显示 `@filename` 标签
- **Web标签格式**：直接显示 `@http://` 或 `@https://` + 完整URL
- **背景样式**：使用与输入框相同的背景颜色进行区分
- **文件悬停提示**：显示完整路径（从 `@file://` 格式中提取）
- **Web悬停提示**：显示网页标题或其他元信息
- **路径支持**：自动识别和显示绝对路径或相对路径
- **删除功能**：标签右侧显示 `×` 按钮，点击移除上下文

### 7. 实现技术规范

#### 7.1 核心组件
1. **ContextSelectorPopup** - 主弹出器容器
2. **ContextTypeSelector** - 类型选择器
3. **FileContextSelector** - 文件选择器
4. **WebContextSelector** - Web URL选择器
5. **ContextItem** - 选择项组件

#### 7.2 数据模型
```kotlin
sealed class ContextType {
    object File : ContextType()
    object Web : ContextType()
}

data class FileContextItem(
    val name: String,
    val relativePath: String,
    val absolutePath: String,
    val isDirectory: Boolean,
    val fileType: String
)

data class WebContextItem(
    val url: String,
    val title: String? = null,
    val description: String? = null
)
```

#### 7.3 服务接口
```kotlin
interface ContextSearchService {
    suspend fun searchFiles(query: String): List<FileContextItem>
    fun validateUrl(url: String): Boolean
}
```

### 8. 测试环境实现

#### 8.1 toolwindow-test 组件
- **MockFileIndexService**：模拟文件索引
- **SimpleFileSearchService**：基础文件搜索
- **TestContextProvider**：测试数据提供

#### 8.2 插件环境实现
- **IdeaFileIndexService**：使用 IntelliJ FileIndex API
- **IdeaContextSearchService**：集成 IDE 搜索功能
- **PsiContextProvider**：基于 PSI 的上下文提供

### 9. 性能要求

#### 9.1 响应时间
- **弹出显示**：< 50ms
- **搜索响应**：< 200ms
- **文件索引**：< 500ms（初始化）

#### 9.2 内存使用
- **文件索引缓存**：< 50MB
- **搜索结果缓存**：< 10MB
- **UI组件内存**：< 5MB

### 10. 可访问性

#### 10.1 键盘导航
- **Tab序列**：合理的焦点顺序
- **快捷键**：支持常用快捷键
- **屏幕阅读器**：正确的语义标记

#### 10.2 视觉辅助
- **高对比度**：支持高对比度主题
- **字体缩放**：响应系统字体设置
- **颜色区分**：不依赖颜色传达信息

### 11. 错误处理

#### 11.1 文件访问错误
- **权限不足**：显示友好提示
- **文件不存在**：从结果中移除
- **索引失败**：降级到基础搜索

#### 11.2 网络相关错误
- **URL格式错误**：实时提示用户
- **连接超时**：显示离线模式
- **DNS解析失败**：提供建议

### 12. 国际化支持

#### 12.1 文本资源
- **中文**：默认语言
- **英文**：备选语言
- **提示信息**：支持多语言切换

#### 12.2 文件路径
- **路径分隔符**：跨平台兼容
- **字符编码**：UTF-8支持
- **特殊字符**：正确处理和显示

## 实现进度

### ✅ 已完成

#### 核心数据模型和架构
- **ContextModels.kt** - 完整的数据模型定义
  - ContextType（文件、Web、未来扩展类型）
  - FileContextItem（文件信息模型）
  - WebContextItem（Web信息模型）  
  - ContextSelectionState（选择状态管理）
  - ContextSelectionResult（选择结果）
  - SearchWeight（搜索权重配置）
  - ContextSelectorConfig（配置参数）

#### 服务接口层
- **ContextSearchService.kt** - 搜索服务接口
  - 文件搜索（同步/异步）
  - URL验证和信息获取
  - 搜索权重计算
  - 文件排除规则

#### UI组件层
- **ContextSelectorPopup.kt** - 主弹出容器
  - 弹出器位置计算和管理
  - 状态路由和生命周期管理
  - @符号检测工具函数
  - 上下文引用字符串生成

- **ContextTypeSelector.kt** - 类型选择器
  - 两种上下文类型选择（File/Web）
  - 键盘导航支持（↑↓Enter Esc）
  - 选中状态高亮和动画
  - Jewel主题适配

- **FileContextSelector.kt** - 文件选择器
  - 实时搜索和去抖动
  - 搜索结果按权重排序
  - 文件类型图标显示
  - 紧凑的文件信息展示
  - 加载状态和空结果处理

- **WebContextSelector.kt** - Web选择器  
  - URL格式验证
  - 页面信息获取和预览
  - 输入提示和示例展示
  - 错误状态处理

#### 测试环境
- **MockContextSearchService.kt** - 模拟搜索服务
  - 完整的测试数据集
  - 真实的搜索算法模拟
  - 网络请求延迟模拟
  - 动态测试数据管理

- **ContextSelectorTestApp.kt** - 独立测试应用
  - 完整的交互测试环境
  - 实时状态调试显示
  - 选择结果历史记录
  - @符号触发检测验证

### 🔄 开发中

#### 插件集成
- **IdeaContextSearchService** - IntelliJ集成服务（待实现）
- **插件输入框集成** - 与EnhancedSmartInputArea集成（待实现）
- **真实文件索引** - 基于IntelliJ FileIndex API（待实现）

#### 高级功能
- **上下文预览** - 文件内容预览（待实现）
- **最近使用记录** - 选择历史管理（待实现）
- **快捷键支持** - 全局快捷键绑定（待实现）

### 📋 待实现

#### 性能优化
- **文件索引缓存** - 提升大项目搜索性能
- **虚拟滚动** - 处理大量搜索结果
- **搜索结果缓存** - 减少重复搜索

#### 用户体验
- **智能排序** - 基于使用频率的结果排序
- **模糊搜索** - 更智能的搜索匹配算法
- **自动补全** - 文件路径自动补全

#### 可访问性
- **屏幕阅读器** - 完整的无障碍支持
- **高对比度** - 高对比度主题适配
- **键盘导航** - 完整的键盘操作支持

### 技术特点

#### 架构设计
- **分层架构**：UI层、服务层、数据层清晰分离
- **依赖注入**：通过接口实现服务层解耦
- **状态管理**：使用Compose状态和密封类管理复杂状态
- **响应式设计**：基于Flow的实时搜索

#### UI设计原则
- **Jewel原生组件**：完全使用JetBrains Jewel设计系统
- **主题一致性**：自动适配IDE主题和配色
- **紧凑设计**：最小化界面占用，突出内容
- **直观交互**：类似Cursor的用户体验

#### 性能考虑
- **去抖动搜索**：200ms延迟避免频繁搜索
- **结果限制**：最多50个结果保证性能
- **异步处理**：所有IO操作都是异步的
- **内存管理**：合理的缓存策略和资源回收

### 下一步计划

1. **插件集成**：将上下文选择器集成到主输入框
2. **IntelliJ服务**：实现基于IDE的真实文件搜索
3. **用户测试**：在实际项目中测试和优化体验
4. **文档完善**：编写用户使用指南和开发文档
5. **性能优化**：针对大型项目进行性能调优 