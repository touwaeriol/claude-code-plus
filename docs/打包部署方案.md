# Claude Code Plus æ‰“åŒ…éƒ¨ç½²æ–¹æ¡ˆ

## æ‰“åŒ…åçš„ ClaudeCliWrapper è°ƒç”¨æ¶æ„

### é—®é¢˜ä¸æŒ‘æˆ˜

å½“åº”ç”¨æ‰“åŒ…æˆå¯æ‰§è¡Œç¨‹åºåï¼Œé¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š

1. **èµ„æºå®šä½é—®é¢˜**: JARå†…éƒ¨è·¯å¾„ vs æ–‡ä»¶ç³»ç»Ÿè·¯å¾„
2. **Node.js è„šæœ¬æ‰§è¡Œ**: æ— æ³•ä»JARå†…ç›´æ¥æ‰§è¡Œ `.js` æ–‡ä»¶  
3. **ä¾èµ–ç®¡ç†**: `node_modules` å¿…é¡»åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­
4. **å·¥ä½œç›®å½•ä¸ç¡®å®š**: ç”¨æˆ·å¯èƒ½ä»ä»»æ„ä½ç½®å¯åŠ¨ç¨‹åº

### è§£å†³æ–¹æ¡ˆæ¶æ„

```
æ‰“åŒ…åçš„å¯æ‰§è¡Œç¨‹åºå¯åŠ¨
    â†“
ClaudeCliWrapper.getNodeScriptPath()
    â†“
æ£€æµ‹è¿è¡Œæ¨¡å¼: isPackagedMode()
    â†“
[æ‰“åŒ…æ¨¡å¼] â†’ PackagedDeploymentStrategy.ensureNodejsRuntime()
    â†“
1. è·å–èµ„æºç›®å½•: ~/.claude-code-plus/
2. ä»JARæå–: claude-sdk-wrapper.js, package.json
3. æ£€æŸ¥å¹¶å®‰è£…: npm install (å¦‚æœéœ€è¦)
4. è¿”å›: (è„šæœ¬æ–‡ä»¶, å·¥ä½œç›®å½•)
    â†“
æ­£å¸¸çš„ Node.js è„šæœ¬è°ƒç”¨æµç¨‹
```

## æ ¸å¿ƒå®ç°ç­–ç•¥

### 1. **æ¨¡å¼æ£€æµ‹**

```kotlin
private fun isPackagedMode(): Boolean {
    return try {
        val location = ClaudeCliWrapper::class.java.protectionDomain?.codeSource?.location?.toString()
        // JARæ¨¡å¼ + æ— æ³•æ‰¾åˆ°å¼€å‘ç¯å¢ƒè„šæœ¬ = æ‰“åŒ…æ¨¡å¼
        location?.endsWith(".jar") == true && !findDevelopmentModeScript().exists()
    } catch (e: Exception) {
        false
    }
}
```

### 2. **èµ„æºéƒ¨ç½²ç­–ç•¥**

#### **èµ„æºç›®å½•é€‰æ‹©**
1. **ä¼˜å…ˆ**: `CLAUDE_CODE_PLUS_HOME` ç¯å¢ƒå˜é‡æŒ‡å®šçš„ç›®å½•
2. **é»˜è®¤**: `~/.claude-code-plus/` ç”¨æˆ·ç›®å½•

#### **æ–‡ä»¶æå–å’Œéƒ¨ç½²**
```kotlin
fun ensureNodejsRuntime(): Pair<File, File> {
    val resourceDir = getResourceDirectory()  // ~/.claude-code-plus/
    val cliWrapperDir = File(resourceDir, "cli-wrapper")
    
    // ä»JARæå–å¿…è¦æ–‡ä»¶
    extractResourceToFile("/nodejs/claude-sdk-wrapper.js", File(cliWrapperDir, "claude-sdk-wrapper.js"))
    extractResourceToFile("/nodejs/package.json", File(cliWrapperDir, "package.json"))
    
    // æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–
    ensureNodeDependencies(cliWrapperDir)
    
    return Pair(scriptFile, cliWrapperDir)
}
```

### 3. **ä¾èµ–ç®¡ç†**

#### **æ™ºèƒ½ä¾èµ–æ£€æµ‹**
```kotlin
private fun isNodeModulesValid(nodeModules: File): Boolean {
    val claudeCodeModule = File(nodeModules, "@anthropic-ai/claude-code")
    return claudeCodeModule.exists() && claudeCodeModule.isDirectory
}
```

#### **è‡ªåŠ¨å®‰è£…ä¾èµ–**
```kotlin
private fun installNodeDependencies(cliWrapperDir: File) {
    val processBuilder = ProcessBuilder("npm", "install")
    processBuilder.directory(cliWrapperDir)
    processBuilder.environment()["NODE_ENV"] = "production"
    
    val process = processBuilder.start()
    val exitCode = process.waitFor()
    // ... é”™è¯¯å¤„ç†
}
```

## æ‰“åŒ…é…ç½®

### **Gradle æ„å»ºé…ç½®**

```kotlin
// JAR æ‰“åŒ… - åªåŒ…å«å¿…è¦æ–‡ä»¶ï¼Œä¸åŒ…å« node_modules
tasks.named<Jar>("jar") {
    from(".") {
        include("claude-sdk-wrapper.js")
        include("package.json")
        include("README.md")
        exclude("node_modules/**")  // è¿è¡Œæ—¶åŠ¨æ€å®‰è£…
        exclude("**/*.log")
        into("nodejs")
    }
}

// ç”Ÿäº§ç¯å¢ƒä¾èµ–å®‰è£…
tasks.register<Exec>("installNodeDependencies") {
    commandLine("npm", "install", "--production")
    environment("NODE_ENV", "production")
}
```

### **åˆ†å‘åŒ…åˆ›å»º**
```kotlin
tasks.register<Zip>("createDistribution") {
    from(".") {
        include("claude-sdk-wrapper.js")
        include("package.json") 
        include("README.md")
        into("cli-wrapper")
    }
    archiveFileName.set("claude-code-plus-nodejs-runtime.zip")
}
```

## éƒ¨ç½²åœºæ™¯æ”¯æŒ

### **åœºæ™¯ 1: å¼€å‘ç¯å¢ƒ**
```
é¡¹ç›®ç»“æ„:
claude-code-plus/
â”œâ”€â”€ cli-wrapper/
â”‚   â”œâ”€â”€ claude-sdk-wrapper.js
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ node_modules/
â”œâ”€â”€ desktop/                    â† å¯åŠ¨ä½ç½®
â””â”€â”€ settings.gradle.kts

å·¥ä½œæ–¹å¼: é€šè¿‡ç›®å½•éå†æŸ¥æ‰¾è„šæœ¬
```

### **åœºæ™¯ 2: JAR æ‰“åŒ…**
```
ç”¨æˆ·ç¯å¢ƒ:
~/.claude-code-plus/
â”œâ”€â”€ cli-wrapper/
â”‚   â”œâ”€â”€ claude-sdk-wrapper.js  â† ä»JARæå–
â”‚   â”œâ”€â”€ package.json           â† ä»JARæå–  
â”‚   â””â”€â”€ node_modules/          â† è¿è¡Œæ—¶å®‰è£…

å·¥ä½œæ–¹å¼: èµ„æºæå– + ä¾èµ–è‡ªåŠ¨å®‰è£…
```

### **åœºæ™¯ 3: åˆ†å‘éƒ¨ç½²**
```
åˆ†å‘åŒ…:
claude-code-plus-nodejs-runtime.zip
â”œâ”€â”€ cli-wrapper/
â”‚   â”œâ”€â”€ claude-sdk-wrapper.js
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ README.md
â””â”€â”€ app.jar

å®‰è£…æ­¥éª¤:
1. è§£å‹åˆ†å‘åŒ…
2. è®¾ç½® CLAUDE_CODE_PLUS_HOME ç¯å¢ƒå˜é‡
3. è¿è¡Œåº”ç”¨ï¼Œè‡ªåŠ¨å®‰è£…ä¾èµ–
```

## ç¯å¢ƒæ£€æŸ¥æœºåˆ¶

### **è¿è¡Œæ—¶éªŒè¯**
```kotlin
fun checkEnvironment(): EnvironmentCheck {
    val checks = mutableMapOf<String, Boolean>()
    val issues = mutableListOf<String>()
    
    // æ£€æŸ¥ Node.js >= 18
    // æ£€æŸ¥ npm å¯ç”¨æ€§
    // æ£€æŸ¥ ANTHROPIC_API_KEY
    
    return EnvironmentCheck(checks, issues)
}
```

### **ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯**
```
ç¯å¢ƒæ£€æŸ¥å¤±è´¥:
âŒ Node.js æœªå®‰è£…: è¯·å®‰è£… Node.js 18+ ç‰ˆæœ¬
âŒ ANTHROPIC_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®
âŒ npm ä¸å¯ç”¨: è¯·ç¡®ä¿ npm åœ¨ PATH ä¸­

å»ºè®®è§£å†³æ–¹æ¡ˆ:
1. è®¿é—® https://nodejs.org å®‰è£… Node.js
2. è®¾ç½® API Key: export ANTHROPIC_API_KEY="your-key"
3. éªŒè¯å®‰è£…: node --version && npm --version
```

## æ€§èƒ½ä¼˜åŒ–

### **1. å»¶è¿Ÿåˆå§‹åŒ–**
- åªåœ¨é¦–æ¬¡ä½¿ç”¨æ—¶æå–èµ„æºå’Œå®‰è£…ä¾èµ–
- åç»­å¯åŠ¨ç›´æ¥ä½¿ç”¨å·²æœ‰çš„ç¯å¢ƒ

### **2. ç¼“å­˜éªŒè¯**
- é€šè¿‡æ–‡ä»¶æ—¶é—´æˆ³å’Œç‰ˆæœ¬æ£€æŸ¥é¿å…é‡å¤å®‰è£…
- æ™ºèƒ½æ£€æµ‹ä¾èµ–å®Œæ•´æ€§

### **3. å¹¶è¡Œå¤„ç†**
- æ–‡ä»¶æå–å’Œä¾èµ–æ£€æŸ¥å¹¶è¡Œæ‰§è¡Œ
- å¼‚æ­¥å®‰è£…ä¾èµ–ï¼Œæ˜¾ç¤ºè¿›åº¦

## ç”¨æˆ·ä½“éªŒ

### **é¦–æ¬¡å¯åŠ¨**
```
ğŸ”„ æ­£åœ¨åˆå§‹åŒ– Node.js è¿è¡Œç¯å¢ƒ...
ğŸ“ åˆ›å»ºèµ„æºç›®å½•: ~/.claude-code-plus/
ğŸ“¦ æå–è¿è¡Œæ—¶æ–‡ä»¶...
â¬‡ï¸  å®‰è£…ä¾èµ–åŒ… (@anthropic-ai/claude-code)...
âœ… åˆå§‹åŒ–å®Œæˆï¼
```

### **åç»­å¯åŠ¨**  
```
âœ… Node.js è¿è¡Œç¯å¢ƒå°±ç»ª
ğŸš€ å¯åŠ¨ Claude Code Plus...
```

## æ€»ç»“

**æ‰“åŒ…åçš„è°ƒç”¨æ–¹å¼**:
1. **æ™ºèƒ½æ¨¡å¼æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«å¼€å‘ vs æ‰“åŒ…ç¯å¢ƒ
2. **èµ„æºåŠ¨æ€éƒ¨ç½²**: ä»JARæå–åˆ°ç”¨æˆ·ç›®å½•
3. **ä¾èµ–è‡ªåŠ¨ç®¡ç†**: è¿è¡Œæ—¶æ£€æŸ¥å’Œå®‰è£…npmä¾èµ–  
4. **è·¨å¹³å°å…¼å®¹**: æ”¯æŒ Windows/macOS/Linux
5. **ç”¨æˆ·å‹å¥½**: æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œè¿›åº¦æç¤º

è¿™æ ·ç”¨æˆ·åªéœ€è¦ï¼š
- âœ… å®‰è£… Node.js 18+
- âœ… è®¾ç½® ANTHROPIC_API_KEY
- âœ… è¿è¡Œå¯æ‰§è¡Œç¨‹åº

ç¨‹åºä¼šè‡ªåŠ¨å¤„ç†æ‰€æœ‰å¤æ‚çš„èµ„æºå®šä½å’Œä¾èµ–ç®¡ç†ï¼