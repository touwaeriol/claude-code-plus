# Claude Code Plus 打包部署方案

## 打包后的 ClaudeCliWrapper 调用架构

### 问题与挑战

当应用打包成可执行程序后，面临以下挑战：

1. **资源定位问题**: JAR内部路径 vs 文件系统路径
2. **Node.js 脚本执行**: 无法从JAR内直接执行 `.js` 文件  
3. **依赖管理**: `node_modules` 必须在文件系统中
4. **工作目录不确定**: 用户可能从任意位置启动程序

### 解决方案架构

```
打包后的可执行程序启动
    ↓
ClaudeCliWrapper.getNodeScriptPath()
    ↓
检测运行模式: isPackagedMode()
    ↓
[打包模式] → PackagedDeploymentStrategy.ensureNodejsRuntime()
    ↓
1. 获取资源目录: ~/.claude-code-plus/
2. 从JAR提取: claude-sdk-wrapper.js, package.json
3. 检查并安装: npm install (如果需要)
4. 返回: (脚本文件, 工作目录)
    ↓
正常的 Node.js 脚本调用流程
```

## 核心实现策略

### 1. **模式检测**

```kotlin
private fun isPackagedMode(): Boolean {
    return try {
        val location = ClaudeCliWrapper::class.java.protectionDomain?.codeSource?.location?.toString()
        // JAR模式 + 无法找到开发环境脚本 = 打包模式
        location?.endsWith(".jar") == true && !findDevelopmentModeScript().exists()
    } catch (e: Exception) {
        false
    }
}
```

### 2. **资源部署策略**

#### **资源目录选择**
1. **优先**: `CLAUDE_CODE_PLUS_HOME` 环境变量指定的目录
2. **默认**: `~/.claude-code-plus/` 用户目录

#### **文件提取和部署**
```kotlin
fun ensureNodejsRuntime(): Pair<File, File> {
    val resourceDir = getResourceDirectory()  // ~/.claude-code-plus/
    val cliWrapperDir = File(resourceDir, "cli-wrapper")
    
    // 从JAR提取必要文件
    extractResourceToFile("/nodejs/claude-sdk-wrapper.js", File(cliWrapperDir, "claude-sdk-wrapper.js"))
    extractResourceToFile("/nodejs/package.json", File(cliWrapperDir, "package.json"))
    
    // 检查并安装依赖
    ensureNodeDependencies(cliWrapperDir)
    
    return Pair(scriptFile, cliWrapperDir)
}
```

### 3. **依赖管理**

#### **智能依赖检测**
```kotlin
private fun isNodeModulesValid(nodeModules: File): Boolean {
    val claudeCodeModule = File(nodeModules, "@anthropic-ai/claude-code")
    return claudeCodeModule.exists() && claudeCodeModule.isDirectory
}
```

#### **自动安装依赖**
```kotlin
private fun installNodeDependencies(cliWrapperDir: File) {
    val processBuilder = ProcessBuilder("npm", "install")
    processBuilder.directory(cliWrapperDir)
    processBuilder.environment()["NODE_ENV"] = "production"
    
    val process = processBuilder.start()
    val exitCode = process.waitFor()
    // ... 错误处理
}
```

## 打包配置

### **Gradle 构建配置**

```kotlin
// JAR 打包 - 只包含必要文件，不包含 node_modules
tasks.named<Jar>("jar") {
    from(".") {
        include("claude-sdk-wrapper.js")
        include("package.json")
        include("README.md")
        exclude("node_modules/**")  // 运行时动态安装
        exclude("**/*.log")
        into("nodejs")
    }
}

// 生产环境依赖安装
tasks.register<Exec>("installNodeDependencies") {
    commandLine("npm", "install", "--production")
    environment("NODE_ENV", "production")
}
```

### **分发包创建**
```kotlin
tasks.register<Zip>("createDistribution") {
    from(".") {
        include("claude-sdk-wrapper.js")
        include("package.json") 
        include("README.md")
        into("cli-wrapper")
    }
    archiveFileName.set("claude-code-plus-nodejs-runtime.zip")
}
```

## 部署场景支持

### **场景 1: 开发环境**
```
项目结构:
claude-code-plus/
├── cli-wrapper/
│   ├── claude-sdk-wrapper.js
│   ├── package.json
│   └── node_modules/
├── desktop/                    ← 启动位置
└── settings.gradle.kts

工作方式: 通过目录遍历查找脚本
```

### **场景 2: JAR 打包**
```
用户环境:
~/.claude-code-plus/
├── cli-wrapper/
│   ├── claude-sdk-wrapper.js  ← 从JAR提取
│   ├── package.json           ← 从JAR提取  
│   └── node_modules/          ← 运行时安装

工作方式: 资源提取 + 依赖自动安装
```

### **场景 3: 分发部署**
```
分发包:
claude-code-plus-nodejs-runtime.zip
├── cli-wrapper/
│   ├── claude-sdk-wrapper.js
│   ├── package.json
│   └── README.md
└── app.jar

安装步骤:
1. 解压分发包
2. 设置 CLAUDE_CODE_PLUS_HOME 环境变量
3. 运行应用，自动安装依赖
```

## 环境检查机制

### **运行时验证**
```kotlin
fun checkEnvironment(): EnvironmentCheck {
    val checks = mutableMapOf<String, Boolean>()
    val issues = mutableListOf<String>()
    
    // 检查 Node.js >= 18
    // 检查 npm 可用性
    // 检查 ANTHROPIC_API_KEY
    
    return EnvironmentCheck(checks, issues)
}
```

### **用户友好的错误信息**
```
环境检查失败:
❌ Node.js 未安装: 请安装 Node.js 18+ 版本
❌ ANTHROPIC_API_KEY 环境变量未设置
❌ npm 不可用: 请确保 npm 在 PATH 中

建议解决方案:
1. 访问 https://nodejs.org 安装 Node.js
2. 设置 API Key: export ANTHROPIC_API_KEY="your-key"
3. 验证安装: node --version && npm --version
```

## 性能优化

### **1. 延迟初始化**
- 只在首次使用时提取资源和安装依赖
- 后续启动直接使用已有的环境

### **2. 缓存验证**
- 通过文件时间戳和版本检查避免重复安装
- 智能检测依赖完整性

### **3. 并行处理**
- 文件提取和依赖检查并行执行
- 异步安装依赖，显示进度

## 用户体验

### **首次启动**
```
🔄 正在初始化 Node.js 运行环境...
📁 创建资源目录: ~/.claude-code-plus/
📦 提取运行时文件...
⬇️  安装依赖包 (@anthropic-ai/claude-code)...
✅ 初始化完成！
```

### **后续启动**  
```
✅ Node.js 运行环境就绪
🚀 启动 Claude Code Plus...
```

## 总结

**打包后的调用方式**:
1. **智能模式检测**: 自动识别开发 vs 打包环境
2. **资源动态部署**: 从JAR提取到用户目录
3. **依赖自动管理**: 运行时检查和安装npm依赖  
4. **跨平台兼容**: 支持 Windows/macOS/Linux
5. **用户友好**: 清晰的错误信息和进度提示

这样用户只需要：
- ✅ 安装 Node.js 18+
- ✅ 设置 ANTHROPIC_API_KEY
- ✅ 运行可执行程序

程序会自动处理所有复杂的资源定位和依赖管理！