# Claude Code Plus 架构说明

## 项目概述

Claude Code Plus 是一个跨平台的 AI 编程助手，提供两种使用方式：
1. **IntelliJ IDEA 插件** - 深度集成到 IDE 中
2. **独立桌面应用** - 基于 Compose Desktop 的跨平台应用

两种方式共享核心组件，通过直接调用 Claude CLI 命令行工具来提供 AI 功能。

## 核心架构

### 1. 直接调用 Claude CLI

本插件采用直接调用系统中已安装的 Claude CLI 的方式，而不是通过 Node.js 服务中转。这种设计具有以下优势：

- **简化架构**：无需维护额外的 Node.js 服务层
- **减少依赖**：不需要 Node.js 运行时
- **提高性能**：减少了进程间通信的开销
- **易于部署**：用户只需安装 Claude CLI 即可使用

### 2. 工作原理

```
用户输入 -> IntelliJ 插件 -> ClaudeCliWrapper -> claude CLI -> Claude API
    ^                                                              |
    |<--------------------- 流式响应 <-----------------------------|
```

## 核心组件

### ClaudeCliWrapper (`/cli-wrapper/src/main/kotlin/com/claudecodeplus/sdk/ClaudeCliWrapper.kt`)

这是与 Claude CLI 交互的核心组件，负责：

1. **构建命令行参数**：将 Kotlin 数据结构转换为 claude CLI 的命令行参数
2. **进程管理**：使用 `ProcessBuilder` 创建和管理 claude 进程
3. **流式响应处理**：解析 claude CLI 的 JSON 流输出
4. **会话管理**：处理会话 ID 和恢复功能
5. **错误处理**：捕获并处理进程错误和异常

#### 关键实现细节：

```kotlin
// 使用流式 JSON 输出格式
args.addAll(listOf("--output-format", "stream-json", "--verbose"))

// 会话管理 - 只在有明确的会话ID时使用 --resume
if (options.resume != null && options.resume.isNotBlank()) {
    args.addAll(listOf("--resume", options.resume))
}

// 权限模式设置
if (options.permissionMode != "default") {
    args.addAll(listOf("--permission-mode", options.permissionMode))
}
```

### UI 组件架构 (`/toolwindow/src/main/kotlin/com/claudecodeplus/ui/`)

基于 Compose 的现代化 UI 架构：

#### 核心 UI 组件：
- `JewelChatApp` - 主聊天应用组件
- `JewelChatPanel` - 聊天面板实现
- `ProjectTabBar` - 项目标签栏
- `SessionListPanel` - 会话列表面板
- `MultiTabChatView` - 多标签聊天视图（桌面版隐藏标签栏）

#### 服务层：
- `ProjectManager` - 项目管理服务
- `ChatTabManager` - 标签管理服务（后台运行）
- `SessionHistoryService` - 会话历史服务
- `MessageProcessor` - 消息处理服务

#### 桌面应用特定组件：
- `Main.kt` - 桌面应用入口
- `ServiceContainer` - 依赖注入容器
- `DesktopProjectService` - 桌面项目服务实现
- `SimpleFileIndexService` - 简单文件索引服务

### 数据模型

#### SDK 数据模型 (`/cli-wrapper/src/main/kotlin/com/claudecodeplus/sdk/DataClasses.kt`)
定义了与 Claude CLI 交互的数据结构：
- `MessageType`：消息类型枚举
- `SDKMessage`：SDK 消息结构
- `MessageData`：消息数据内容

#### UI 数据模型 (`/toolwindow/src/main/kotlin/com/claudecodeplus/ui/models/`)
定义了 UI 层使用的数据结构：
- `ChatModels.kt` - 聊天相关模型（EnhancedMessage、ToolCall、ContextReference等）
- `UnifiedModels.kt` - 统一的数据模型
- `ConfigModels.kt` - 配置相关模型

## 会话管理架构

### 项目和会话的关系
- 每个项目可以包含多个会话
- 会话通过项目 ID 与项目关联
- 切换项目时自动加载该项目的会话列表

### 会话生命周期
1. **占位会话创建**：用户点击"新建会话"时创建占位会话（id为null）
2. **Claude 会话创建**：发送第一条消息时，Claude CLI 创建实际的会话并返回会话 ID
3. **会话 ID 映射**：占位会话的 null ID 更新为 Claude 返回的真实 ID
4. **会话持久化**：会话文件由 Claude CLI 管理，存储在 `~/.claude/projects/` 目录中

### 标签管理（后台）
- 桌面应用隐藏了 MultiTabChatView 的标签栏
- ChatTabManager 仍在后台管理标签状态
- 每个会话对应一个隐藏的标签
- 通过会话列表选择会话，而非标签切换

## 配置和设置

### MCP (Model Context Protocol) 支持

支持 MCP 配置，允许用户扩展 Claude 的能力：

- **全局配置**：在插件设置中配置
- **项目配置**：在项目根目录的 `.claude/config.json` 中配置
- **配置合并**：项目配置会覆盖全局配置

## 测试

### 单元测试 (`/src/test/kotlin/com/claudecodeplus/sdk/ClaudeCliWrapperTest.kt`)

包含了对 ClaudeCliWrapper 的全面测试：

- 基本查询功能测试
- 错误处理测试
- 参数构建测试
- Claude CLI 可用性检查

运行测试：
```bash
# 运行所有测试
./gradlew test

# 运行包含实际 Claude API 调用的测试
RUN_CLAUDE_TESTS=true ./gradlew test
```

## 依赖项

### 运行时依赖

- **Claude CLI**：必须在系统中安装并配置
  ```bash
  npm install -g @anthropic-ai/claude-cli
  claude auth
  ```

### 开发依赖

- Kotlin 2.1.0
- IntelliJ Platform SDK 2025.1.2
- Kotlin Coroutines 1.7.3
- Jackson (JSON 处理)

## 构建和部署

```bash
# 构建插件
./gradlew buildPlugin

# 运行开发环境
./gradlew runIde

# 运行测试
./gradlew test
```

## 支持的功能

除了基本的消息发送和接收，插件还支持以下高级功能：

### 1. 响应打断

- **停止按钮**：UI 中提供停止按钮，可随时中断 AI 响应
- **ESC 快捷键**：按 ESC 键快速停止生成
- **实现机制**：使用 Kotlin 协程的 `Job.cancel()` 和进程的 `process.destroy()`

### 2. 流式响应

- 实时显示 AI 生成的内容
- 使用 `--output-format stream-json` 参数获取流式输出
- 通过 Kotlin Flow 处理异步数据流

### 3. 会话管理

- 支持新建会话
- 支持会话导出
- 未来可扩展支持会话历史

详细功能说明请参考 [FEATURES.md](./FEATURES.md)

## 注意事项

1. **Claude CLI 版本兼容性**：插件依赖于 claude CLI 的命令行接口，需要注意版本兼容性
2. **权限设置**：默认使用 "default" 权限模式，允许所有操作。在生产环境中可能需要调整
3. **错误处理**：CLI 进程可能因各种原因失败（网络、认证等），需要适当的错误处理
4. **进程管理**：确保在打断或错误时正确清理子进程，避免进程泄漏

## 未来改进方向

1. 支持更多的 Claude CLI 功能
2. 改进错误处理和用户提示
3. 添加会话历史管理
4. 支持自定义快捷键
5. 优化流式响应的显示效果# Jewel 组件迁移指南

本文档详细说明了如何将项目中的原生 Compose 组件替换为 IntelliJ Jewel 组件，以获得更好的 IDE 集成和一致的用户体验。

## 为什么要使用 Jewel 组件？

1. **原生 IntelliJ 外观**: Jewel 组件完全匹配 IntelliJ IDEA 的设计语言
2. **主题一致性**: 自动跟随 IDE 的明暗主题切换
3. **平台适配**: 针对不同操作系统（macOS、Windows、Linux）的原生行为
4. **性能优化**: 专为 IDE 环境优化的组件实现
5. **无缝集成**: 与 IntelliJ 插件系统完美配合

## 组件替换对照表

### 1. 文本组件

| 原生组件 | Jewel 组件 | 主要改进 |
|---------|-----------|---------|
| `androidx.compose.material.Text` | `org.jetbrains.jewel.ui.component.Text` | 自动主题集成，更好的颜色管理 |
| `androidx.compose.foundation.text.BasicText` | `org.jetbrains.jewel.ui.component.Text` | 统一的文本样式系统 |

**迁移示例**:
```kotlin
// 原生 Compose
Text(
    "Hello World",
    style = TextStyle(
        color = Color.White,
        fontSize = 14.sp
    )
)

// Jewel 组件
Text(
    "Hello World",
    color = JewelTheme.globalColors.text.normal,
    fontSize = 14.sp
)
```

### 2. 滚动容器

| 原生组件 | Jewel 组件 | 主要改进 |
|---------|-----------|---------|
| `LazyColumn` | `VerticallyScrollableContainer` | 原生滚动条样式，平台特定行为 |
| `LazyRow` | `HorizontallyScrollableContainer` | 自动隐藏/显示逻辑 |

**迁移示例**:
```kotlin
// 原生 Compose
LazyColumn(
    modifier = Modifier.fillMaxSize(),
    verticalArrangement = Arrangement.spacedBy(8.dp),
    contentPadding = PaddingValues(16.dp)
) {
    items(messages) { message ->
        MessageItem(message)
    }
}

// Jewel 组件
VerticallyScrollableContainer(
    scrollState = rememberScrollState(),
    modifier = Modifier.fillMaxSize()
) {
    Column(
        modifier = Modifier.padding(16.dp),
        verticalArrangement = Arrangement.spacedBy(8.dp)
    ) {
        messages.forEach { message ->
            MessageItem(message)
        }
    }
}
```

### 3. 按钮组件

| 原生组件 | Jewel 组件 | 主要改进 |
|---------|-----------|---------|
| `Button` | `DefaultButton` | IntelliJ 按钮样式，交互状态 |
| `OutlinedButton` | `OutlinedButton` | 原生轮廓按钮样式 |
| `IconButton` | `IconButton` | 完整的图标按钮实现 |

**迁移示例**:
```kotlin
// 原生 Compose
Button(
    onClick = { onSend() },
    modifier = Modifier.size(32.dp)
) {
    Text("发送")
}

// Jewel 组件
DefaultButton(
    onClick = { onSend() },
    modifier = Modifier.size(32.dp)
) {
    Text("发送")
}
```

### 4. 输入框组件

| 原生组件 | Jewel 组件 | 主要改进 |
|---------|-----------|---------|
| `BasicTextField` | `TextField` | 原生输入框样式，焦点管理 |
| `OutlinedTextField` | `TextField` | 统一的输入框组件 |
| `TextArea` | `TextArea` | 多行文本输入组件 |

**迁移示例**:
```kotlin
// 原生 Compose
BasicTextField(
    value = text,
    onValueChange = onTextChange,
    textStyle = TextStyle(color = Color.White),
    modifier = Modifier.fillMaxWidth()
)

// Jewel 组件
TextField(
    value = text,
    onValueChange = onTextChange,
    modifier = Modifier.fillMaxWidth()
)
```

### 5. 分隔线组件

| 原生组件 | Jewel 组件 | 主要改进 |
|---------|-----------|---------|
| `Divider` | `org.jetbrains.jewel.ui.component.Divider` | 原生分隔线样式，方向支持 |

**迁移示例**:
```kotlin
// 原生 Compose
Divider(
    color = Color.Gray,
    thickness = 1.dp
)

// Jewel 组件
Divider(
    orientation = Orientation.Horizontal,
    modifier = Modifier.height(1.dp)
)
```

### 6. 其他高级组件

| 原生组件 | Jewel 组件 | 主要改进 |
|---------|-----------|---------|
| `DropdownMenu` | `Menu` | IntelliJ 风格菜单 |
| `Card` | 使用 `Box` + `Jewel` 样式 | 更好的主题集成 |
| `Switch` | `Checkbox` (切换模式) | 原生切换控件 |
| `RadioButton` | `RadioButton` | 原生单选按钮 |

## 完整迁移示例

### 迁移前（原生 Compose）:
```kotlin
@Composable
fun OriginalChatView() {
    Column {
        LazyColumn {
            items(messages) { message ->
                Card {
                    Text(message.content, color = Color.White)
                }
            }
        }
        Divider(color = Color.Gray)
        Row {
            BasicTextField(value = text, onValueChange = {})
            Button(onClick = {}) {
                Text("发送")
            }
        }
    }
}
```

### 迁移后（Jewel）:
```kotlin
@Composable
fun JewelConversationView() {
    Column {
        VerticallyScrollableContainer(rememberScrollState()) {
            Column {
                messages.forEach { message ->
                    Box(
                        modifier = Modifier.background(
                            JewelTheme.globalColors.panelBackground,
                            RoundedCornerShape(8.dp)
                        )
                    ) {
                        Text(
                            message.content,
                            color = JewelTheme.globalColors.text.normal
                        )
                    }
                }
            }
        }
        Divider(orientation = Orientation.Horizontal)
        Row {
            TextField(value = text, onValueChange = {})
            DefaultButton(onClick = {}) {
                Text("发送")
            }
        }
    }
}
```

## 注意事项

### 1. 导入更改
确保更新导入语句：
```kotlin
// 移除
import androidx.compose.material.*
import androidx.compose.foundation.lazy.*

// 添加
import org.jetbrains.jewel.ui.component.*
import org.jetbrains.jewel.foundation.theme.JewelTheme
```

### 2. 主题系统
使用 Jewel 的主题系统而不是硬编码颜色：
```kotlin
// 避免
color = Color.White

// 推荐
color = JewelTheme.globalColors.text.normal
```

### 3. 样式简化
Jewel 组件自动处理样式，无需复杂的 `TextStyle`：
```kotlin
// 原生 Compose
Text(
    "标题",
    style = TextStyle(
        fontSize = 16.sp,
        fontWeight = FontWeight.Bold,
        color = Color.White
    )
)

// Jewel
Text(
    "标题",
    fontSize = 16.sp,
    fontWeight = FontWeight.Bold,
    color = JewelTheme.globalColors.text.normal
)
```

### 4. 渐进式迁移
可以逐步迁移，新旧组件可以共存：
1. 先迁移核心组件（Text、Button）
2. 然后迁移布局容器（ScrollableContainer）
3. 最后迁移高级组件（Menu、Dialog）

## 性能影响

使用 Jewel 组件的性能影响：
- **正面**: 更好的内存管理，专为 IDE 优化
- **负面**: 略微增加的初始化开销
- **整体**: 对用户体验有显著提升

## 兼容性

- **IntelliJ 版本**: 2023.1+
- **Compose 版本**: 与项目当前版本兼容
- **平台支持**: Windows、macOS、Linux

## 下一步

1. 按照优先级迁移组件（Text → Button → Container → Advanced）
2. 测试主题切换功能
3. 验证不同平台的行为一致性
4. 更新相关文档和示例代码

## 迁移优化统计

### 组件替换统计
本项目已完成以下组件的全面替换：

- **LazyColumn** → **VerticallyScrollableContainer**: 4个文件
- **LazyRow** → **HorizontallyScrollableContainer**: 3个文件  
- **BasicTextField** → **TextField**: 3个文件
- **OutlinedButton** → **Button**: 2个文件
- **Material DropdownMenu** → **Jewel Dropdown**: 1个文件

### 已优化的核心文件

1. **JewelConversationView.kt**
   - 使用 `VerticallyScrollableContainer` 替代 `LazyColumn`
   - 使用 `TextField` 替代 `BasicTextField`
   - 完全使用 `JewelTheme.globalColors`

2. **EnhancedSmartInputArea.kt**
   - 优化了上下文菜单和建议系统
   - 使用 Jewel 主题系统
   - 提升了滚动性能

3. **MarkdownRenderer.kt**
   - 使用 Jewel 按钮组件
   - 保持代码渲染功能完整性

4. **ModelSelector.kt**
   - 替换为 Jewel Dropdown
   - 使用主题色彩系统 