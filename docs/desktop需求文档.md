# Claude Code Plus 桌面应用需求文档

## 1. 概述

Claude Code Plus 桌面应用是一个独立的、跨平台的客户端，用于与 Claude AI 进行交互。它为开发人员提供了丰富的、类似 IDE 的用户体验，独立于任何特定的集成开发环境。该应用程序利用共享的 `cli-wrapper` 进行 Claude CLI 交互，并使用 `toolwindow` 模块作为其核心 UI 组件，确保在适用的情况下与 JetBrains 插件的功能保持一致。

## 2. 功能需求

### 2.1 应用程序布局和结构

*   **FR-1.1**：应用程序采用多层级的界面结构，顶部为项目标签栏，主区域为会话列表和聊天界面。
*   **FR-1.2**：项目标签栏显示所有打开的项目，支持快速切换不同项目。
*   **FR-1.3**：主视图为两栏布局，左侧为当前项目的会话列表，右侧为聊天界面。
*   **FR-1.4**：应用程序使用 `toolwindow` 模块中的 `MultiTabChatView` 组件，但隐藏了对话标签栏。
*   **FR-1.5**：聊天界面复用 `toolwindow` 模块提供的基础对话框 UI。

#### 桌面应用完整 UI 示意图

```
+----------------------------------------------------------------------------------------------------+
| Claude Code Plus Desktop                                                              [-] [□] [×] |
+----------------------------------------------------------------------------------------------------+
| 工具栏：[新建对话] [管理对话] [搜索] | Claude Code Plus | [模板] [导出] [设置]                    |
+----------------------------------------------------------------------------------------------------+
| [项目 A (5)] [项目 B (3)] [项目 C (2)] [+]                                    <- 项目标签栏        |
+----------------------------------------------------------------------------------------------------+
|                                                                                                    |
| +--------------------------+ +---------------------------------------------------------------------+ |
| | 项目 A 的会话 (5)        | |                                                                     | |
| | ----------------------   | |  ┌─────────────────────────────────────────────────────────────┐  | |
| | [+ 新建会话]             | |  │              工具窗口基础对话框 UI（引用）                    │  | |
| |                          | |  │                                                               │  | |
| | • 会话 1                 | |  │  参见：工具窗口需求 - 基础聊天界面布局                       │  | |
| | • 会话 2 (当前)          | |  │                                                               │  | |
| | • 会话 3                 | |  │  包含：                                                       │  | |
| | • 会话 4                 | |  │  - 消息显示区域（用户/Claude对话）                            │  | |
| | • 会话 5                 | |  │  - 统一输入区域（上下文标签、输入框、模型选择器、发送按钮）  │  | |
| |                          | |  │                                                               │  | |
| +--------------------------+ |  └─────────────────────────────────────────────────────────────┘  | |
|   会话列表面板（280dp宽）  |                          聊天对话区域                                 | |
|   显示当前项目的会话        |                      （复用工具窗口组件）                            | |
+----------------------------------------------------------------------------------------------------+
| 状态栏：标签数: 5 | [PA] 会话 2 | 文件索引完成                                                    |
+----------------------------------------------------------------------------------------------------+
```

### 2.2 桌面特定功能

#### 2.2.1 项目标签栏

*   **FR-3.1**：项目标签栏位于工具栏下方，显示所有打开的项目。
*   **FR-3.2**：每个项目标签显示项目名称和会话数量。
*   **FR-3.3**：支持通过点击标签切换项目，当前项目有底部指示线。
*   **FR-3.4**：鼠标悬停时显示关闭按钮（仅当有多个项目时）。
*   **FR-3.5**：提供"+"按钮用于创建新项目。

#### 2.2.2 会话列表面板

*   **FR-3.6**：左侧面板显示当前选中项目的所有会话。
*   **FR-3.7**：面板顶部显示"[项目名] 的会话 (数量)"。
*   **FR-3.8**：提供"+ 新建会话"按钮。
*   **FR-3.9**：会话列表显示每个会话的名称，当前会话有高亮显示。
*   **FR-3.10**：支持右键菜单操作（重命名、删除、导出等）。
*   **FR-3.11**：面板宽度固定为280dp，提供良好的可读性。

#### 2.2.3 服务实现

*   **FR-3.12 (文件索引)**：应用程序必须提供适用于独立桌面环境的 `FileIndexService` 的具体实现 (`SimpleFileIndexService`)。
*   **FR-3.13 (项目服务)**：应用程序必须提供用于处理项目级操作的 `ProjectService` 的具体实现 (`DesktopProjectService`)。
*   **FR-3.14 (持久化存储)**：提供本地存储服务，保存项目结构、会话历史和用户设置。

#### 2.2.4 窗口管理

*   **FR-3.15**：支持多窗口操作，允许用户打开多个独立的应用窗口。
*   **FR-3.16**：支持窗口状态记忆（位置、大小、最大化状态）。
*   **FR-3.17**：提供系统托盘集成（可选）。

### 2.3 会话管理

#### 2.3.1 Claude会话集成
- 新建会话时创建占位会话（placeholder session），会话ID为null
- 在用户发送第一条消息时，Claude CLI返回真实的会话ID
- 支持会话链接状态的可视化展示
- 占位会话显示为"新会话"，获得真实ID后更新为实际会话标题
- 所有文件操作由Claude CLI负责，应用不创建任何会话文件

#### 2.3.2 项目关联
- 每个会话必须属于一个项目
- 切换项目时自动显示该项目的会话列表
- 项目简称显示在会话标题中（格式：[项目简称] 会话名）
- 项目简称规则：4个字符以内直接使用，否则取首字母缩写

#### 2.3.3 会话与标签管理
- 桌面应用隐藏了MultiTabChatView的标签栏
- 通过会话列表选择会话，而非通过标签切换
- 每个会话对应一个隐藏的标签，用于管理聊天状态
- 支持通过快捷键（Ctrl+R）刷新所有会话名称

## 3. 非功能性需求

*   **NFR-1.1（性能）**：即使在管理大量对话或索引大型项目目录时，应用程序也应快速启动并保持响应。
*   **NFR-1.2（平台支持）**：应用程序必须可在 macOS、Windows 和 Linux 上分发和运行。
*   **NFR-1.3（依赖项）**：应用程序的核心功能需要本地安装 Claude CLI。它必须处理未找到 CLI 的情况并引导用户。
*   **NFR-1.4（安装）**：构建过程必须为目标平台生成本机安装程序（macOS 的 DMG、Windows 的 MSI、Linux 的 DEB）。

## 4. 架构

*   **AR-1.1（模块化）**：桌面应用程序构建在共享模块之上，包括 `cli-wrapper`（用于 CLI 交互）和 `toolwindow`（用于 UI 组件），促进了代码重用和与插件版本的一致性。
*   **AR-1.2（依赖注入）**：应用程序应使用服务容器（`ServiceContainer.kt`）来管理和提供 `ProjectService` 和 `FileIndexService` 等依赖项，确保架构解耦且可测试。
*   **AR-1.3（服务抽象）**：应用程序应使用抽象服务（例如 `ProjectService`、`FileIndexService`），并为桌面环境提供具体实现（`DesktopProjectService`、`SimpleFileIndexService`）。

## 5. 用户体验

### 5.1 键盘快捷键
- **Ctrl/Cmd + T**：新建标签
- **Ctrl/Cmd + W**：关闭当前标签
- **Ctrl/Cmd + Tab**：切换标签
- **Ctrl/Cmd + Shift + Tab**：反向切换标签
- **Ctrl/Cmd + 1-9**：直接切换到第N个标签

### 5.2 拖放支持
- 支持拖放文件到聊天区域作为上下文
- 支持拖放文件夹到项目面板创建新项目
- 支持拖动标签重新排序

### 5.3 主题支持
- 自动检测系统主题（浅色/深色）
- 支持手动切换主题
- 保存用户的主题偏好设置