# Claude Code Plus 工具窗口模块需求文档

## 1. 模块概述

`toolwindow` 模块为所有 Claude Code Plus 客户端应用程序（包括 JetBrains 插件和独立桌面应用程序）提供核心的、可重用的 UI 组件。它使用 Compose for Desktop 和 Jewel UI 库构建，以确保一致、现代和 IDE 原生的用户体验。

## 2. 功能需求

### 2.1 主聊天视图 (`ChatView.kt`)

*   **FR-1.1**：该组件应提供一个完整的聊天界面，包括消息显示区域和统一的消息输入区域。
*   **FR-1.2**：它必须显示 `EnhancedMessage` 对象列表，正确区分用户、AI、系统和错误消息。
*   **FR-1.3**：视图必须处理聊天会话的生命周期，包括加载初始消息和处理会话创建。
*   **FR-1.4**：在加载会话时，应显示加载指示器。
*   **FR-1.5**：用户消息应使用 `UnifiedInputArea` 的只读版本显示，以保持视觉一致性。
*   **FR-1.6**：AI 响应必须支持 Markdown 和语法高亮的代码块渲染。
*   **FR-1.7**：所有消息内容必须支持文本选择和复制功能，包括用户消息、助手消息、工具参数和工具结果。
*   **FR-1.8**：提供右键上下文菜单，支持"复制消息"、"复制为Markdown"等快捷操作。

### 2.2 统一输入区 (`UnifiedInputArea.kt`)

*   **FR-2.1**：此组件应作为主要的用户输入机制，支持标准输入模式和只读显示模式。
*   **FR-2.2**：它必须提供通过"添加上下文"按钮、`⌘K` 快捷键和 `@` 内联文件提及来添加上下文的机制。
*   **FR-2.3**：添加的上下文项目（文件、URL）应显示为可移除的标签。
*   **FR-2.4**：它必须包括一个模型选择器下拉列表（例如 Opus、Sonnet）。
*   **FR-2.5**：它必须包括一个发送按钮，在消息生成期间能智能地转变为停止按钮。
*   **FR-2.6**：该组件必须是键盘友好的，支持发送消息（`Enter`）、添加换行符（`Shift+Enter`）和触​​发上下文选择的快捷键。

#### 2.2.2 上下文长度统计功能

*   **FR-2.28**：在输入框右下角发送按钮旁边显示上下文使用量统计。
*   **FR-2.29**：统计显示格式：使用简洁的方括号格式 `[当前/最大]`，例如 `[2.4k/200k]`、`[890/200k]`
*   **FR-2.30**：Token格式化规则：低于1k显示具体数字（如"890"），1k及以上显示为"xxk"格式并保留一位小数（如"1.2k"、"15.8k"）
*   **FR-2.31**：鼠标悬浮时显示详细信息，包括精确数字、百分比和token来源分析
*   **FR-2.32**：支持不同模型的上下文长度配置：Opus 和 Sonnet 均配置为 200k tokens
*   **FR-2.33**：统计包含当前消息历史、用户输入文本、添加的上下文文件等所有内容的token数量
*   **FR-2.34**：当接近上下文限制时（>80%）显示警告颜色，超过限制时（>95%）显示错误颜色

**UI布局位置**：
```
|-----------------------------------------------------------------------|
| [模型: Opus ▼] [权限: 绕过 ▼] [⚡跳过认证]          [2.4k/200k] [↑] |
|-----------------------------------------------------------------------|
```

**组件说明**：
- 左侧：模型选择器、权限配置选项
- 右侧：上下文统计信息（紧贴发送按钮）
  - `[2.4k/200k]` - 简洁的当前使用量/最大容量格式
  - `[↑]` - 发送按钮

**悬浮提示示例**：
- 正常状态：`"上下文使用: 15,234 / 200,000 tokens (7.6%)"`
- 警告状态：`"上下文使用: 165,432 / 200,000 tokens (82.7%) - 接近限制"`
- 错误状态：`"上下文使用: 195,678 / 200,000 tokens (97.8%) - 超过限制"`

**设计优势**：
- 更简洁的视觉呈现，减少UI噪音
- 方括号提供清晰的边界感
- 一目了然的比例关系
- 节省水平空间，适合紧凑布局

#### 2.2.1 现代化UI设计要求

*   **FR-2.7**：输入区域必须使用统一容器设计，所有子组件共享同一背景，避免视觉层次混乱。
*   **FR-2.8**：布局必须分为三个清晰的区域：顶部工具栏（上下文标签）、中间输入区、底部选项栏（模型选择、权限、发送按钮）。
*   **FR-2.9**：选择器组件必须使用现代化的悬浮卡片设计，支持图标和描述信息，悬浮时有背景色变化效果。
*   **FR-2.10**：上下文标签必须使用胶囊形状设计（RoundedCornerShape(10.dp)），并显示类型图标（文件、网页等）。
*   **FR-2.11**：所有交互元素必须有清晰的悬浮状态（200ms过渡动画）和禁用状态表现。
*   **FR-2.12**：输入框获得焦点时，整个容器边框必须高亮显示，使用主题色的 focused 边框色。
*   **FR-2.13**：颜色方案必须遵循统一规范：容器背景使用 `panelBackground`，边框使用 `1.dp, borders.normal`，悬浮效果使用 `primaryColor.copy(alpha = 0.1f)`。

### 2.3 基础聊天界面布局

```
+---------------------------------------------------------------------+
| [用户]                                                              |
| > 如何设置一个新项目？                                              |
|                                                                     |
| [Claude]                                                            |
| > 要设置一个新项目，您可以使用以下命令：                            |
| > ```                                                               |
| > claude new-project --name "我的超棒项目"                          |
| > ```                                                               |
|                                                                     |
| [_                                                               ] |
+---------------------------------------------------------------------+
| [📎 添加上下文] [@file.kt]                                          |
|---------------------------------------------------------------------|
|                                                                     |
|   在此处输入您的消息...                                             |
|                                                                     |
|---------------------------------------------------------------------|
| [模型: Opus ▼]                                      [15.2k/200k] [↑] |
+---------------------------------------------------------------------+
```

### 2.4 会话和对话管理组件 (`MultiTabChatView.kt`, `ChatOrganizer.kt`)

*   **FR-3.1**：`MultiTabChatView` 应提供一个支持在标签页界面中进行多个独立聊天对话的顶级容器。
*   **FR-3.2**：用户必须能够创建新标签页、在它们之间切换以及关闭它们。
*   **FR-3.3**：`ChatOrganizer` 组件应提供一个用于高级对话管理的两栏视图。
*   **FR-3.4**：组织器的左侧面板必须显示对话项目列表，允许用户筛选对话。
*   **FR-3.5**：组织器的右侧面板必须显示所选项目内的对话列表，显示每个对话的摘要和元数据。
*   **FR-3.6**：系统必须支持创建、编辑和删除对话项目。

### 2.5 消息渲染组件

*   **FR-4.1**：提供 Markdown 渲染组件，支持代码块语法高亮。
*   **FR-4.2**：提供工具调用显示组件，支持紧凑和展开两种显示模式。
*   **FR-4.3**：提供内联引用渲染组件，支持文件、URL 等多种引用类型。
*   **FR-4.4**：提供消息状态指示组件（生成中、已完成、错误等）。

### 2.6 上下文管理组件

*   **FR-5.1**：提供上下文选择器弹出窗口组件，支持文件和 Web URL 选择。
*   **FR-5.2**：提供上下文标签组件，支持显示和移除操作。
*   **FR-5.3**：提供内联引用检测和处理组件。
*   **FR-5.4**：提供上下文搜索服务接口和实现。

### 2.7 工具调用展示优化 (2025-08-15 更新)

#### 2.7.1 设计原则
1. **极简设计**：减少视觉噪音，专注于关键信息展示
2. **智能折叠**：默认只显示摘要，减少空间占用
3. **轻量背景**：摒弃深色/黑色背景，使用透明或极浅背景
4. **内容过滤**：智能过滤技术细节，只显示用户关心的信息
5. **紧凑布局**：最小化边距、间距和圆角半径

#### 2.7.2 视觉优化要求
- **FR-2.14**：默认背景色使用透明或极淡的主题色(`panelBackground.copy(alpha = 0.1f)`)
- **FR-2.15**：ANSI终端背景适配主题：深色主题使用`Color(40,44,52)`(VS Code风格)，浅色主题使用`Color(248,248,248)`
- **FR-2.16**：工具调用圆角半径减少至3dp，减少视觉重量
- **FR-2.17**：工具调用间距减少至1dp，单行内边距减少至`horizontal=4dp, vertical=2dp`
- **FR-2.18**：字体大小统一使用11sp，减少视觉层次混乱
- **FR-2.35**：工具调用标题仅占用一个字高度，使用单行紧凑显示
- **FR-2.36**：移除执行时长显示，历史消息无法准确反映耗时
- **FR-2.37**：工具调用之间的垂直间距最小化，避免占用过多高度
- **FR-2.38**：展开结果与工具标题之间的间距减少至2dp

#### 2.7.3 极致间距优化（2025-08-16 最新实现）

**核心原则**：最大化信息密度，最小化垂直空间占用，为用户提供更紧凑的工具状态展示。

**间距优化**：
- **FR-2.39**：工具调用列表容器间距完全移除：`verticalArrangement = Arrangement.spacedBy(0.dp)`
- **FR-2.40**：工具标题行垂直内边距完全移除：`padding(horizontal = 3.dp, vertical = 0.dp)`
- **FR-2.44**：顶部工具调用区域边距最小化：`padding(horizontal = 4.dp, vertical = 1.dp)`

**字体和尺寸优化**：
- **FR-2.41**：图标和文字字体进一步缩小：图标 12.sp，工具名 11.sp，箭头 10.sp
- **FR-2.42**：行高与字体大小相等，消除额外行间距：`lineHeight = fontSize`
- **FR-2.43**：状态指示器尺寸减少：主指示器 10.dp，箭头容器 12.dp

**实现细节**：
- 工具调用显示格式优化为 `ToolName: parameter` 格式，避免括号增加视觉重量
- 容器圆角半径减少至 3.dp，降低视觉厚重感
- 所有内边距、外边距和间距值都经过精确调整，确保信息密度最大化

#### 2.7.4 现代化状态指示器系统（2025-08-16 新增）

**设计理念**：采用图标化设计语言，提供直观、现代的视觉反馈。

**核心组件**：`ModernStatusIndicator.kt` - 替代传统的方形色块状态指示器
- **FR-2.45**：使用图标化状态指示器替代方形色块：
  - ✓ (Check Icon) 成功状态 - 绿色对勾图标
  - ✗ (Close Icon) 失败状态 - 红色叉号图标  
  - ● (Pulsing Dot) 运行中状态 - 蓝色脉冲圆点
  - ○ (Static Dot) 等待状态 - 灰色静态圆点

**视觉规范**：
- **FR-2.46**：状态指示器颜色遵循 Material Design 规范：
  - 成功：绿色 #4CAF50 (Material Green 500)
  - 失败：红色 #F44336 (Material Red 500)
  - 运行：蓝色 #2196F3 (Material Blue 500)
  - 等待：灰色 #9E9E9E (Material Grey 500)

**动画效果**：
- **FR-2.47**：运行状态使用脉冲动画效果：
  - 缩放动画：0.8f → 1.2f，800ms 周期
  - 透明度动画：0.4f → 1.0f，800ms 周期
  - 缓动效果：EaseInOut，无限反向重复

**尺寸适配**：
- **FR-2.48**：状态指示器尺寸适配紧凑布局：
  - 默认尺寸：12.dp（适合标准显示）
  - 极致模式：10.dp（适配紧凑间距要求）
  - 脉冲点相对尺寸：容器的 70% 大小
  - 等待点相对尺寸：容器的 60% 大小

#### 2.7.5 工具调用定位系统优化（2025-08-16 实现）

**定位策略**：将工具调用状态从消息内容中分离，提供固定的、专门的展示区域。

**布局设计**：
- **FR-2.49**：工具调用状态显示在聊天框外部的固定顶部区域
  - 位置：聊天内容区域与输入框之间的独立区域
  - 特性：不随消息滚动，始终可见，专门显示当前执行状态
- **FR-2.50**：工具调用区域与聊天内容区域有清晰的分隔线
  - 使用 `Divider` 组件提供视觉分隔
  - 确保用户清楚区分状态信息和对话内容

**视觉设计**：
- **FR-2.51**：工具调用区域背景使用半透明主题色：`panelBackground.copy(alpha = 0.95f)`
  - 提供足够的对比度确保可读性
  - 保持与整体界面的视觉一致性
- **FR-2.52**：生成状态**仅在输入框左上角区域**显示提示文字和跳动点动画，**不在消息列表和工具调用区域中显示**
  - 位置：输入框容器的左上角位置，与输入框内容分离
  - 文案："Generating"（跳动点动画在文案后方）
  - 动画：`JumpingDots()` 组件提供三点跳动效果
  - 字体：12.sp，透明度 0.7f，确保不干扰主要内容
  - 显示效果：`Generating ...`（其中 ... 是跳动动画）
  - **禁止**：在 AssistantMessageDisplay 和工具调用区域中显示 StreamingIndicator

#### 2.7.6 智能内容过滤
- **FR-2.19**：Bash命令输出默认只显示8行，过长内容智能摘要
- **FR-2.20**：文件列表类命令自动统计并折叠显示："📁 找到N个文件..."
- **FR-2.21**：MCP工具结果智能简化，过滤技术细节
- **FR-2.22**：统计类命令只保留关键数字信息
- **FR-2.23**：超过15行的输出自动过滤为关键信息 + "...N行省略"

#### 2.7.7 默认折叠策略
- **FR-2.24**：大部分工具默认不展开详细结果，只显示执行状态
- **FR-2.25**：只有以下工具自动展开：短文件内容(Read <500字符)、编辑操作(Edit)、失败的工具
- **FR-2.26**：用户可点击展开查看完整结果
- **FR-2.27**：展开区域内边距减少至4dp，关闭按钮区域减少至20dp

#### 2.7.8 专属展示组件
- **TodoWrite**：单列任务列表（非看板式）
- **Edit/MultiEdit**：Diff 展示效果
- **Read/Write**：文件内容预览
- **LS**：文件列表展示
- **Bash**：命令行输出展示（最大8行，智能过滤）

#### 2.7.9 动画组件
- **JumpingDots**：三个点依次跳动，表示处理中
- **PulsingDot**：脉冲效果，表示等待状态
- **SpinningProgress**：旋转进度，表示加载中
- **SuccessCheckmark**：成功勾淡入动画
- **ErrorCross**：错误叉淡入动画

## 3. 非功能性需求

*   **NFR-1.1 (可重用性)**：所有组件必须是自包含的，并且可在不同的宿主应用程序（例如 JetBrains 插件、桌面应用程序）中重用。
*   **NFR-1.2 (主题)**：组件必须遵守 Jewel UI 主题系统，自动适应浅色和深色模式。
*   **NFR-1.3 (性能)**：UI 必须具有高性能和响应能力，长时间运行的操作（如文件索引）在后台线程上运行。
*   **NFR-1.4 (平台一致性)**：组件应尽可能遵守宿主操作系统的 UI 约定。

## 4. 组件架构

### 4.1 核心组件层次

```
toolwindow 模块
├── UI 组件层
│   ├── ChatView.kt - 主聊天视图
│   ├── UnifiedInputArea.kt - 统一输入区域  
│   ├── UnifiedChatInput.kt - 新的统一输入组件（整合所有输入元素）
│   ├── MultiTabChatView.kt - 多标签容器
│   └── ChatOrganizer.kt - 对话管理器
├── 现代化UI组件层
│   ├── ModernSelectors.kt - 现代化选择器组件
│   ├── PillContextTag.kt - 胶囊形上下文标签
│   └── ToolbarSection.kt - 工具栏区域组件
├── 渲染组件层
│   ├── MarkdownRenderer.kt - Markdown 渲染
│   ├── ToolCallDisplay.kt - 工具调用显示
│   ├── InlineReferenceRenderer.kt - 内联引用渲染
│   └── GeneratingIndicator.kt - 生成状态指示器
├── 上下文管理层
│   ├── ContextSelectorPopup.kt - 上下文选择器
│   ├── ContextTag.kt - 上下文标签
│   ├── FileContextSelector.kt - 文件选择器
│   └── WebContextSelector.kt - Web 选择器
├── 工具展示组件层（2025-08-16 大幅增强）
│   ├── tools/
│   │   ├── LoadingIndicators.kt - 加载动画组件（跳动点、脉冲点、旋转进度）
│   │   ├── CompactToolCallDisplay.kt - 紧凑工具展示（已实现极致间距优化）
│   │   │   └── 支持80+工具类型的专业格式化显示
│   │   ├── ModernStatusIndicator.kt - 现代化状态指示器（新增，2025-08-16）
│   │   │   └── 图标化设计：Check/Close图标 + 脉冲/静态圆点
│   │   ├── EnhancedTodoDisplay.kt - TodoWrite 单列任务列表展示
│   │   ├── DiffResultDisplay.kt - 文件编辑的 Diff 结果展示
│   │   ├── ToolExecutionProgress.kt - 工具执行进度显示
│   │   ├── ToolGroupDisplay.kt - 工具分组展示
│   │   └── AssistantMessageDisplay.kt - 助手消息展示（集成新的工具展示组件）
└── 服务接口层
    ├── ContextSearchService.kt - 上下文搜索
    ├── FileIndexService.kt - 文件索引
    └── ProjectService.kt - 项目服务
```

### 4.2 依赖注入模式

*   **AR-4.1**：所有组件应通过参数接收其依赖项，而不是直接创建依赖项。
*   **AR-4.2**：服务接口应在 `toolwindow` 模块中定义，具体实现由宿主应用程序提供。
*   **AR-4.3**：组件应支持可选的依赖项注入，为测试环境提供默认实现。

## 5. 会话管理增强

### 5.1 Claude会话链接
- 新增 `isClaudeSessionLinked` 标记，跟踪标签是否已关联Claude会话
- 在用户发送第一条消息时自动链接Claude会话
- 支持通过 `linkClaudeSession` 方法手动关联会话
- 触发 `SessionLinked` 事件通知UI更新

### 5.2 标签状态管理
- 支持多种标签状态：ACTIVE、INTERRUPTED、COMPLETED、ARCHIVED
- 提供状态转换方法 `markTabStatus`
- 支持标签复制、重命名等操作
- 维护最近使用的标签列表

### 5.3 会话持久化系统 (已实现并验证)

**核心功能描述**：
自动记录和恢复用户的会话状态，确保应用重启后能够无缝恢复到上次的工作状态，包括完整的对话历史和上下文信息。

#### FR-5.5 自动状态保存机制
- **触发时机**: 用户选择新会话、切换标签时自动触发
- **保存内容**: 
  - 当前选中的会话ID (sessionId) - 如 `05bbeb4b-0eae-4383-ab5c-2006df0cab6e`
  - 会话所属项目 (projectId) - 如 `-Users-erio-codes-idea-claude-code-plus-desktop`
  - 会话显示名称 (sessionName) - 用户可见的会话标题
- **存储位置**: 本地配置文件 `~/.claude-code-plus/desktop-project.json`
- **保存实现**: 通过 `LocalConfigManager.saveLastSelectedSession()` 实现即时保存

#### FR-5.6 启动时状态恢复机制
- **恢复时机**: 桌面应用启动时自动执行
- **恢复流程**:
  1. 读取本地配置文件中的 `lastSelectedSession` 字段
  2. 验证会话文件是否存在于 `~/.claude/projects/<projectId>/sessions/<sessionId>.jsonl`
  3. 如果会话存在，自动创建对应标签并加载历史消息
  4. 如果会话不存在或损坏，创建新的空会话作为后备
- **恢复内容**:
  - 完整的消息历史（包括用户消息、助手回复、工具调用结果）
  - 会话配置（模型选择、权限设置等）
  - 工具调用的执行状态和结果数据
  - 上下文引用和文件关联信息

#### FR-5.7 历史消息加载系统
- **加载机制**: 使用 `ClaudeSessionManager` 读取 JSONL 格式的会话文件
- **消息处理**: 
  - 按时间顺序逐条处理历史消息 (`MessageConverter` 解析)
  - 保持工具调用与结果的关联关系 (tool_use_id 映射)
  - 支持流式消息的完整恢复 (assistant 多段内容合并)
  - 正确处理工具结果的成功/失败状态
- **性能优化**: 
  - 异步加载历史消息，避免阻塞界面 (`CoroutineScope(Dispatchers.Main)`)
  - 支持大量历史消息的批量处理 (已验证45条消息加载)
  - 内存中缓存解析结果，避免重复处理

#### FR-5.8 会话状态同步
- **状态管理**: 通过 `SessionObject` 维护会话运行时状态
- **数据一致性**: 
  - 内存状态与文件系统状态保持同步
  - 支持多窗口/多实例的状态共享 (通过全局 `SessionManager`)
  - 处理并发访问和状态冲突 (sessionId 作为唯一标识)
- **错误处理**: 
  - 会话文件损坏时的恢复机制 (创建新会话兜底)
  - 配置文件异常时的默认行为 (使用默认项目)
  - 历史消息解析失败时的跳过机制 (继续处理其他消息)

**验证结果 (2025-08-15)**：
已通过桌面应用实际测试验证功能完整性：
- ✅ 自动保存最后选中会话ID到配置文件
- ✅ 应用重启后自动恢复指定会话 (`05bbeb4b-0eae-4383-ab5c-2006df0cab6e`)
- ✅ 成功加载45条完整历史消息 (`sessionMessages: 45, totalCount: 45`)
- ✅ 保持工具调用状态和结果的完整性
- ✅ 用户界面状态与历史数据一致

**实现组件清单**：
- **ChatTabManager.setActiveTab()** - 标签切换时自动保存会话ID
- **ProjectManager.setCurrentSession()** - 会话状态变更时保存到本地配置
- **ProjectManager.selectProjectByWorkingDirectory()** - 启动时优先恢复最后选中会话
- **LocalConfigManager.saveLastSelectedSession()** - 会话ID持久化存储
- **LocalConfigManager.getLastSelectedSession()** - 会话ID读取恢复
- **SessionObject.loadNewMessages()** - 异步加载历史消息
- **MessageConverter** - JSONL消息格式解析器
- **ClaudeSessionManager** - 会话文件读写管理器

## 6. 权限管理系统

### 6.1 权限模式选择器

**功能需求**：
- **FR-6.1**：提供权限模式下拉选择器，支持四种权限模式
- **FR-6.2**：每种权限模式必须有清晰的图标和说明文字
- **FR-6.3**：选择器必须显示当前选择的权限模式，并支持快速切换
- **FR-6.4**：权限模式变更时，必须保存到用户配置中

**权限模式选项**：
- `🔓 绕过权限 (BYPASS_PERMISSIONS)` - 推荐选项，使用 `--accept-tools` 参数
- `🎯 默认模式 (DEFAULT)` - Claude CLI 默认权限行为，需要用户确认
- `✅ 接受编辑 (ACCEPT_EDITS)` - 自动接受文件编辑操作，使用 `--accept-edits` 参数
- `📋 计划模式 (PLAN)` - 只生成计划不执行操作，使用 `--plan` 参数

### 6.2 跳过权限认证开关

**功能需求**：
- **FR-6.5**：提供独立的"跳过权限认证"切换开关
- **FR-6.6**：开关必须有明确的视觉状态区分（开启/关闭）
- **FR-6.7**：提供悬浮提示，说明此选项对工具执行的影响
- **FR-6.8**：与权限模式选择器协同工作，形成完整的权限控制策略

**开关界面**：
- `⚡ 跳过权限认证` - 切换开关组件，默认关闭状态
- 开启时：完全忽略权限检查，不传递任何权限相关的CLI参数
- 关闭时：根据选择的权限模式传递对应的CLI参数

### 6.3 权限控制组合逻辑

**权限处理策略**：
1. **跳过权限认证开启** + **任何权限模式** = 不传递权限参数，完全跳过权限检查
2. **跳过权限认证关闭** + **绕过权限模式** = 传递 `--accept-tools` 参数
3. **跳过权限认证关闭** + **默认模式** = 不传递权限参数，使用 Claude CLI 默认行为
4. **跳过权限认证关闭** + **接受编辑模式** = 传递 `--accept-edits` 参数
5. **跳过权限认证关闭** + **计划模式** = 传递 `--plan` 参数

### 6.4 权限配置持久化

**功能需求**：
- **FR-6.9**：权限模式和跳过认证开关状态必须持久化到配置文件
- **FR-6.10**：支持项目级别的权限配置覆盖全局默认配置
- **FR-6.11**：配置变更时，必须立即生效并应用到后续的工具执行中

## 7. 聊天界面布局设计

### 7.1 基础界面结构

**应用程序主窗口布局**：
```
┌─────────────────────────────────────────────────────────────────┐
│ Claude Code Plus - [D] 新会话                           [ - □ × ] │
├─────────────────────────────────────────────────────────────────┤
│ 📁 Sessions    │ ┌─── 工具调用状态区域 (固定顶部) ────────┐        │
│ ├─ [D] 新会话   │ │ 💻 Bash: find . -name "*.kt"      ✅  ▶ │      │
│ ├─ [D] 代码重构 │ │ 📁 LS: ./src/main/kotlin         ✅  ▶ │      │
│ ├─ [D] Bug修复  │ └──────────────────────────────────────┘        │
│ └─ [+] 新建     │ ┌─────────────────────────────────────────────┐ │
│                │ │             消息列表区域                    │ │
│ 🔧 Settings    │ │          (可滚动，自动到底)                 │ │
│ ├─ 模型: Opus  │ └─────────────────────────────────────────────┘ │
│ ├─ 权限: 绕过  │ Generating...                                 │ │
│ └─ 项目: desktop│ ┌─────────────────────────────────────────────┐ │
│                │ │             聊天输入区域                    │ │
│                │ │         (多行输入，支持上下文)              │ │
│                │ └─────────────────────────────────────────────┘ │
└─────────────────┴─────────────────────────────────────────────────┘
```

### 7.2 消息展示布局

**用户消息布局**：
```
┌─────────────────────────────────────────────────────────────────┐
│                                                            👤 你 │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ 列举当前项目的文件树 文件数量 文件类型数量                     │ │
│ │                                                           │ │
│ │ 📁 上下文: /desktop/src/main/kotlin/Main.kt               │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                    2024-08-13 18:23 │
└─────────────────────────────────────────────────────────────────┘
```

**助手消息 - 简化的工具调用展示布局**：
```
┌─────────────────────────────────────────────────────────────────┐
│ 🤖 Claude                                                        │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ 我来帮你分析项目结构。让我先获取文件信息：                      │ │
│ │                                                           │ │
│ │ 基于分析结果，项目包含以下文件结构...                        │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                    2024-08-13 18:24 │
└─────────────────────────────────────────────────────────────────┘
```

**说明**: 工具调用状态显示在聊天框外部的固定顶部区域，不在消息内容中显示

### 7.3 工具展示详细示例

**工具调用展示位置**：
- **FR-7.1**：工具调用信息必须显示在聊天框外部的左上方区域，位于聊天内容区域和输入框区域之间
- **FR-7.2**：位置固定在聊天内容区域的顶部，不随消息滚动，不在输入框内部显示
- **FR-7.3**：工具调用区域与聊天内容区域之间有清晰的视觉分隔
- **FR-7.7**：生成中状态（Generating...）必须显示在工具调用区域，不在输入框内显示

**极致紧凑模式要求（2025-08-16 实现）**：
- **FR-7.4**：工具调用标题行高度最小化，仅占用必要的文字空间
  - 行高设置为与字体大小相等（`lineHeight = fontSize`）
  - 垂直内边距完全移除（`vertical = 0.dp`）
- **FR-7.5**：完全移除工具调用之间的垂直间距，实现无缝紧密排列
  - 容器间距设置为 0.dp（`verticalArrangement = Arrangement.spacedBy(0.dp)`）
  - 工具调用项目紧密相邻，无任何空隙
- **FR-7.6**：状态指示器使用现代化图标设计，尺寸适配紧凑布局
  - 图标尺寸：10.dp（极致模式）/ 12.dp（标准模式）
  - 图标类型：Check/Close 图标 + 脉冲/静态圆点

**紧凑模式展示（直接显示，无分组）**：
```
💻 Bash: find . -name "*.kt"                         ✅  ▶
📁 LS: ./src/main/kotlin                             ✅  ▶
📄 Read: Main.kt                                     ✅  ▶
🔍 Grep: "function" **/*.kt                          ✅  ▶
   15 处匹配
🌐 WebFetch: github.com                              ✅  ▶
   查询: API文档
```

**展开模式展示 - 直接显示结果**：
```
┌─────────────────────────────────────────────────────────────┐
│ ./src/main/kotlin/Main.kt                                   │
│ ./src/main/kotlin/SimpleMain.kt                             │
│ ./src/main/kotlin/TestSessionLoading.kt                     │
│ ./src/main/kotlin/DesktopProjectService.kt                  │
│ ./src/main/kotlin/SimpleFileIndexService.kt                 │
│ ... 还有 15 个文件                                           │
│                                                             │
│ 执行时间: 1.2s | 退出码: 0                                   │
└─────────────────────────────────────────────────────────────┘
```

### 7.4 状态指示器系统

**执行状态指示**：
- **🟡 PENDING** - 等待执行：淡黄色圆点，静态
- **🔵 RUNNING** - 执行中：蓝色圆点，脉冲动画
- **✅ SUCCESS** - 成功完成：绿色对勾，静态
- **❌ FAILED** - 执行失败：红色叉号，静态  
- **⏹️ CANCELLED** - 已取消：灰色方块，静态

**交互元素指示**：
- **▶** - 点击展开详情
- **▼** - 点击收起详情
- **✕** - 关闭详情面板
- **●** - 正在执行动画（旋转或脉冲）
- **○** - 等待执行（静态圆圈）

### 7.5 响应式布局适配

**窄窗口模式 (< 800px)**：
```
┌─────────────────────────────────┐
│ Claude Code Plus        [ - × ] │
├─────────────────────────────────┤
│          消息列表区域            │
│                               │
│ 💻 Bash find...     ✅ 1.2s   │
│ 📁 LS ./src...      ✅ 0.8s   │  
│ 📄 Read Main.kt     ✅ 0.3s   │
│                               │
│ Generating...                 │
├─────────────────────────────────┤
│         聊天输入区域             │
└─────────────────────────────────┘
```

**宽窗口模式 (> 1200px)**：
```
┌─────────────────────────────────────────────────────────────────┐
│ Claude Code Plus - [D] 新会话                           [ - □ × ] │
├─────────────────────────────────────────────────────────────────┤
│ 📁 Sessions    │                聊天内容区域              │ 🔧 Info │
│ 会话列表       │                                        │ 详细信息 │
│ (200px)       │              主要对话区域               │ (250px) │
│              │              (flex-grow)                │        │
└─────────────────────────────────────────────────────────────────┘
```