# Claude Code Plus 工具窗口模块需求文档

## 1. 模块概述

`toolwindow` 模块为所有 Claude Code Plus 客户端应用程序（包括 JetBrains 插件和独立桌面应用程序）提供核心的、可重用的 UI 组件。它使用 Compose for Desktop 和 Jewel UI 库构建，以确保一致、现代和 IDE 原生的用户体验。

## 2. 功能需求

### 2.1 主聊天视图 (`ChatView.kt`)

*   **FR-1.1**：该组件应提供一个完整的聊天界面，包括消息显示区域和统一的消息输入区域。
*   **FR-1.2**：它必须显示 `EnhancedMessage` 对象列表，正确区分用户、AI、系统和错误消息。
*   **FR-1.3**：视图必须处理聊天会话的生命周期，包括加载初始消息和处理会话创建。
*   **FR-1.4**：在加载会话时，应显示加载指示器。
*   **FR-1.5**：用户消息应使用 `UnifiedInputArea` 的只读版本显示，以保持视觉一致性。
*   **FR-1.6**：AI 响应必须支持 Markdown 和语法高亮的代码块渲染。

### 2.2 统一输入区 (`UnifiedInputArea.kt`)

*   **FR-2.1**：此组件应作为主要的用户输入机制，支持标准输入模式和只读显示模式。
*   **FR-2.2**：它必须提供通过"添加上下文"按钮、`⌘K` 快捷键和 `@` 内联文件提及来添加上下文的机制。
*   **FR-2.3**：添加的上下文项目（文件、URL）应显示为可移除的标签。
*   **FR-2.4**：它必须包括一个模型选择器下拉列表（例如 Opus、Sonnet）。
*   **FR-2.5**：它必须包括一个发送按钮，在消息生成期间能智能地转变为停止按钮。
*   **FR-2.6**：该组件必须是键盘友好的，支持发送消息（`Enter`）、添加换行符（`Shift+Enter`）和触​​发上下文选择的快捷键。

#### 2.2.1 现代化UI设计要求

*   **FR-2.7**：输入区域必须使用统一容器设计，所有子组件共享同一背景，避免视觉层次混乱。
*   **FR-2.8**：布局必须分为三个清晰的区域：顶部工具栏（上下文标签）、中间输入区、底部选项栏（模型选择、权限、发送按钮）。
*   **FR-2.9**：选择器组件必须使用现代化的悬浮卡片设计，支持图标和描述信息，悬浮时有背景色变化效果。
*   **FR-2.10**：上下文标签必须使用胶囊形状设计（RoundedCornerShape(10.dp)），并显示类型图标（文件、网页等）。
*   **FR-2.11**：所有交互元素必须有清晰的悬浮状态（200ms过渡动画）和禁用状态表现。
*   **FR-2.12**：输入框获得焦点时，整个容器边框必须高亮显示，使用主题色的 focused 边框色。
*   **FR-2.13**：颜色方案必须遵循统一规范：容器背景使用 `panelBackground`，边框使用 `1.dp, borders.normal`，悬浮效果使用 `primaryColor.copy(alpha = 0.1f)`。

### 2.3 基础聊天界面布局

```
+---------------------------------------------------------------------+
| [用户]                                                              |
| > 如何设置一个新项目？                                              |
|                                                                     |
| [Claude]                                                            |
| > 要设置一个新项目，您可以使用以下命令：                            |
| > ```                                                               |
| > claude new-project --name "我的超棒项目"                          |
| > ```                                                               |
|                                                                     |
| [_                                                               ] |
+---------------------------------------------------------------------+
| [📎 添加上下文] [@file.kt]                                          |
|---------------------------------------------------------------------|
|                                                                     |
|   在此处输入您的消息...                                             |
|                                                                     |
|---------------------------------------------------------------------|
| [模型: Opus ▼]                                                  [↑] |
+---------------------------------------------------------------------+
```

### 2.4 会话和对话管理组件 (`MultiTabChatView.kt`, `ChatOrganizer.kt`)

*   **FR-3.1**：`MultiTabChatView` 应提供一个支持在标签页界面中进行多个独立聊天对话的顶级容器。
*   **FR-3.2**：用户必须能够创建新标签页、在它们之间切换以及关闭它们。
*   **FR-3.3**：`ChatOrganizer` 组件应提供一个用于高级对话管理的两栏视图。
*   **FR-3.4**：组织器的左侧面板必须显示对话项目列表，允许用户筛选对话。
*   **FR-3.5**：组织器的右侧面板必须显示所选项目内的对话列表，显示每个对话的摘要和元数据。
*   **FR-3.6**：系统必须支持创建、编辑和删除对话项目。

### 2.5 消息渲染组件

*   **FR-4.1**：提供 Markdown 渲染组件，支持代码块语法高亮。
*   **FR-4.2**：提供工具调用显示组件，支持紧凑和展开两种显示模式。
*   **FR-4.3**：提供内联引用渲染组件，支持文件、URL 等多种引用类型。
*   **FR-4.4**：提供消息状态指示组件（生成中、已完成、错误等）。

### 2.6 上下文管理组件

*   **FR-5.1**：提供上下文选择器弹出窗口组件，支持文件和 Web URL 选择。
*   **FR-5.2**：提供上下文标签组件，支持显示和移除操作。
*   **FR-5.3**：提供内联引用检测和处理组件。
*   **FR-5.4**：提供上下文搜索服务接口和实现。

### 2.7 工具调用展示优化

#### 2.7.1 设计原则
1. **单参数内联**：单参数工具直接显示参数值，无需参数名
2. **智能摘要**：多参数工具显示关键信息摘要
3. **结果可视化**：根据工具类型提供专门的结果展示格式

#### 2.7.2 紧凑展示规则
- 单参数工具：`工具名 参数值`
- 多参数工具：`工具名 关键信息摘要`
- 执行状态：使用图标和动画代替文字
- 时间显示：仅在完成后显示执行时间

#### 2.7.3 专属展示组件
- **TodoWrite**：单列任务列表（非看板式）
- **Edit/MultiEdit**：Diff 展示效果
- **Read/Write**：文件内容预览
- **LS**：文件列表展示
- **Bash**：命令行输出展示

#### 2.7.4 动画组件
- **JumpingDots**：三个点依次跳动，表示处理中
- **PulsingDot**：脉冲效果，表示等待状态
- **SpinningProgress**：旋转进度，表示加载中
- **SuccessCheckmark**：成功勾淡入动画
- **ErrorCross**：错误叉淡入动画

## 3. 非功能性需求

*   **NFR-1.1 (可重用性)**：所有组件必须是自包含的，并且可在不同的宿主应用程序（例如 JetBrains 插件、桌面应用程序）中重用。
*   **NFR-1.2 (主题)**：组件必须遵守 Jewel UI 主题系统，自动适应浅色和深色模式。
*   **NFR-1.3 (性能)**：UI 必须具有高性能和响应能力，长时间运行的操作（如文件索引）在后台线程上运行。
*   **NFR-1.4 (平台一致性)**：组件应尽可能遵守宿主操作系统的 UI 约定。

## 4. 组件架构

### 4.1 核心组件层次

```
toolwindow 模块
├── UI 组件层
│   ├── ChatView.kt - 主聊天视图
│   ├── UnifiedInputArea.kt - 统一输入区域  
│   ├── UnifiedChatInput.kt - 新的统一输入组件（整合所有输入元素）
│   ├── MultiTabChatView.kt - 多标签容器
│   └── ChatOrganizer.kt - 对话管理器
├── 现代化UI组件层
│   ├── ModernSelectors.kt - 现代化选择器组件
│   ├── PillContextTag.kt - 胶囊形上下文标签
│   └── ToolbarSection.kt - 工具栏区域组件
├── 渲染组件层
│   ├── MarkdownRenderer.kt - Markdown 渲染
│   ├── ToolCallDisplay.kt - 工具调用显示
│   ├── InlineReferenceRenderer.kt - 内联引用渲染
│   └── GeneratingIndicator.kt - 生成状态指示器
├── 上下文管理层
│   ├── ContextSelectorPopup.kt - 上下文选择器
│   ├── ContextTag.kt - 上下文标签
│   ├── FileContextSelector.kt - 文件选择器
│   └── WebContextSelector.kt - Web 选择器
├── 工具展示组件层
│   ├── tools/
│   │   ├── LoadingIndicators.kt - 加载动画组件
│   │   ├── CompactToolCallDisplay.kt - 紧凑工具展示
│   │   ├── EnhancedTodoDisplay.kt - TodoWrite 列表展示
│   │   ├── DiffResultDisplay.kt - Diff 结果展示
│   │   ├── ToolExecutionProgress.kt - 工具执行进度
│   │   └── ToolGroupDisplay.kt - 工具分组展示
└── 服务接口层
    ├── ContextSearchService.kt - 上下文搜索
    ├── FileIndexService.kt - 文件索引
    └── ProjectService.kt - 项目服务
```

### 4.2 依赖注入模式

*   **AR-4.1**：所有组件应通过参数接收其依赖项，而不是直接创建依赖项。
*   **AR-4.2**：服务接口应在 `toolwindow` 模块中定义，具体实现由宿主应用程序提供。
*   **AR-4.3**：组件应支持可选的依赖项注入，为测试环境提供默认实现。

## 5. 会话管理增强

### 5.1 Claude会话链接
- 新增 `isClaudeSessionLinked` 标记，跟踪标签是否已关联Claude会话
- 在用户发送第一条消息时自动链接Claude会话
- 支持通过 `linkClaudeSession` 方法手动关联会话
- 触发 `SessionLinked` 事件通知UI更新

### 5.2 标签状态管理
- 支持多种标签状态：ACTIVE、INTERRUPTED、COMPLETED、ARCHIVED
- 提供状态转换方法 `markTabStatus`
- 支持标签复制、重命名等操作
- 维护最近使用的标签列表